# 更新说明 - Web一键更新功能

## 🎉 新功能

本次更新添加了完整的Web界面一键更新功能！

### ✨ 主要特性

1. **Web界面更新** - 在浏览器中点击按钮即可更新
2. **版本管理** - 自动管理版本号（v1.0.0 → v1.0.1）
3. **代理支持** - 支持配置代理，直连失败自动切换
4. **自动重启** - 更新完成后自动重启服务
5. **更新历史** - 记录最近10次更新操作
6. **安全控制** - 更新锁、审计日志、本地修改检测

## 📦 新增文件

- `version.txt` - 版本号文件
- `increment_version.py` - 版本号自动递增脚本
- `update_history.json` - 更新历史记录（自动生成）

## 🚀 使用方法

### 方法1：主界面快捷更新

1. 打开Web界面
2. 点击"🔄 更新"按钮
3. 系统自动检查并更新
4. 更新成功后自动重启

### 方法2：设置中更新

1. 点击"⚙️ 设置"按钮
2. 在"系统更新配置"区域：
   - 查看当前版本
   - 配置代理（如需要）
   - 点击"🔍 检查更新"
3. 如有新版本，点击确认更新

## 🔧 代理配置

如果飞牛NAS访问GitHub较慢或失败：

1. 打开"设置"
2. 勾选"启用更新代理"
3. 填写代理地址，例如：`http://192.168.1.100:7890`
4. 保存设置

## 📝 手动上传新版本（开发者）

### Windows环境

1. 安装Git：https://git-scm.com/
2. 修改代码
3. 运行 `upload-to-github.bat`
4. 脚本自动递增版本号并推送

### 飞牛NAS环境

```bash
# 1. 递增版本号
python3 increment_version.py

# 2. 查看新版本
cat version.txt

# 3. 提交更改
git add .
git commit -m "Update to $(cat version.txt)"

# 4. 推送到GitHub
git push origin main
```

## 🐛 故障排除

### 更新失败：无法连接GitHub

**解决方案**：
1. 在设置中配置代理
2. 或在飞牛NAS上手动更新：
   ```bash
   cd /path/to/media-renamer
   git pull origin main
   ./stop.sh && ./start.sh
   ```

### 更新失败：检测到本地修改

**解决方案**：
```bash
# 查看修改
git status

# 重置本地修改
git reset --hard HEAD

# 再次尝试更新
```

### 服务重启失败

**解决方案**：
```bash
# 手动重启
./stop.sh
./start.sh
```

## 📊 API端点

新增的API端点：

- `POST /api/get-version` - 获取当前版本
- `POST /api/check-update` - 检查更新
- `POST /api/update` - 执行更新
- `POST /api/rollback` - 版本回滚
- `POST /api/update-history` - 更新历史

## 🔐 安全特性

- 更新操作有并发锁保护
- 记录操作审计日志（用户、IP、时间）
- 检测本地修改，防止覆盖
- 更新前自动备份（Git机制）

## 📈 版本历史

- **v1.0.0** - 初始版本，添加Web更新功能

## 💡 提示

- 首次使用需要在飞牛NAS上手动pull一次
- 之后就可以在Web界面一键更新了
- 建议配置代理以提高更新速度
- 更新历史保存在 `update_history.json`
