# 飞牛NAS更新指南

## 📋 准备工作

由于你的Windows环境没有安装Git，我们需要在飞牛NAS上操作。

## 🚀 方法1：直接在飞牛NAS上推送（推荐）

### 步骤1：SSH连接到飞牛NAS

```bash
ssh your-username@飞牛IP地址
```

### 步骤2：进入项目目录

```bash
cd /path/to/media-renamer
# 例如：cd /vol02/1000-1-b23abde7/media-renamer
```

### 步骤3：检查Git状态

```bash
git status
```

### 步骤4：递增版本号

```bash
python3 increment_version.py
cat version.txt  # 查看新版本号
```

### 步骤5：提交更改

```bash
# 添加所有文件
git add .

# 提交（使用新版本号）
NEW_VERSION=$(cat version.txt)
git commit -m "Update to $NEW_VERSION - 添加Web更新功能"
```

### 步骤6：推送到GitHub

```bash
# 如果直连GitHub
git push origin main

# 如果需要跳过SSL验证
git -c http.sslVerify=false push origin main

# 如果需要使用代理
git config http.proxy http://代理地址:端口
git push origin main
```

## 🔄 方法2：使用上传脚本

### 步骤1：给脚本添加执行权限

```bash
chmod +x upload-to-github.sh
```

### 步骤2：运行脚本

```bash
./upload-to-github.sh
```

脚本会自动：
- 递增版本号
- 添加文件
- 提交更改
- 推送到GitHub

## 🧪 测试Web更新功能

### 步骤1：确认推送成功

在GitHub上查看你的仓库，确认最新代码已上传。

### 步骤2：打开Web界面

```
http://飞牛IP:8090
```

### 步骤3：测试更新

**方法A：快捷更新**
1. 点击主界面的"🔄 更新"按钮
2. 确认更新
3. 等待自动重启
4. 刷新页面

**方法B：设置中更新**
1. 点击"⚙️ 设置"
2. 在"系统更新配置"中点击"🔍 检查更新"
3. 如果有更新，点击确认
4. 等待自动重启
5. 刷新页面

## 🔧 配置代理（如果GitHub访问慢）

### 在Web界面配置

1. 打开"设置"
2. 找到"系统更新配置"
3. 勾选"启用更新代理"
4. 填写代理地址：`http://代理IP:端口`
5. 保存设置

### 在命令行配置

```bash
# 配置Git代理
git config http.proxy http://代理IP:端口
git config https.proxy http://代理IP:端口

# 查看配置
git config --list | grep proxy

# 取消代理
git config --unset http.proxy
git config --unset https.proxy
```

## 📝 常见问题

### Q1: 推送时提示需要认证

**解决方案**：

```bash
# 方法1：使用Personal Access Token
git remote set-url origin https://TOKEN@github.com/username/repo.git

# 方法2：使用SSH
git remote set-url origin git@github.com:username/repo.git
```

### Q2: 推送失败：SSL certificate problem

**解决方案**：

```bash
# 临时跳过SSL验证
git -c http.sslVerify=false push origin main

# 或永久配置
git config http.sslVerify false
```

### Q3: Web更新失败：无法连接GitHub

**解决方案**：
1. 在Web设置中配置代理
2. 或手动更新：
   ```bash
   cd /path/to/media-renamer
   git pull origin main
   ./stop.sh && ./start.sh
   ```

### Q4: 更新后服务没有重启

**解决方案**：

```bash
# 手动重启
cd /path/to/media-renamer
./stop.sh
./start.sh

# 检查服务状态
ps aux | grep app.py
```

### Q5: 检测到本地修改，无法更新

**解决方案**：

```bash
# 查看修改的文件
git status

# 如果不需要保留修改
git reset --hard HEAD

# 如果需要保留修改
git stash
git pull origin main
git stash pop
```

## 🎯 完整流程示例

```bash
# 1. SSH连接
ssh user@192.168.1.100

# 2. 进入目录
cd /vol02/1000-1-b23abde7/media-renamer

# 3. 递增版本
python3 increment_version.py

# 4. 提交推送
git add .
git commit -m "Update to $(cat version.txt)"
git -c http.sslVerify=false push origin main

# 5. 测试Web更新
# 打开浏览器：http://192.168.1.100:8090
# 点击"更新"按钮
```

## 📊 验证更新成功

### 检查版本号

```bash
# 命令行查看
cat version.txt

# Web界面查看
# 打开"设置" → "系统更新配置" → 查看"当前版本"
```

### 检查更新历史

```bash
# 查看更新历史文件
cat update_history.json

# 或在Web界面查看（如果实现了历史显示）
```

## 🎉 成功标志

更新成功后，你应该看到：

1. ✅ 版本号从 v1.0.0 变为 v1.0.1（或更高）
2. ✅ Web界面显示新版本号
3. ✅ 设置中有"系统更新配置"区域
4. ✅ 主界面有"🔄 更新"按钮
5. ✅ 点击更新按钮可以正常工作

## 💡 后续使用

以后每次更新代码：

1. 在飞牛NAS上修改代码
2. 运行 `./upload-to-github.sh`
3. 在其他设备上打开Web界面
4. 点击"更新"按钮
5. 自动拉取最新代码并重启

就这么简单！🎊
