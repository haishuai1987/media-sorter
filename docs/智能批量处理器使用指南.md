# 智能批量处理器使用指南

## 概述

智能批量处理器是借鉴 media-renamer-2 设计的高效批量文件处理工具，提供实时进度跟踪、详细统计和事件驱动架构。

## 核心特性

✓ **智能批量处理** - 高效处理大量文件  
✓ **实时进度跟踪** - 进度百分比、ETA 预估  
✓ **详细统计信息** - 成功率、处理时间、错误详情  
✓ **事件驱动架构** - 与现有事件系统完美集成  
✓ **中文标题查询** - 自动转换英文标题为中文  
✓ **模板引擎集成** - 灵活的命名方式  
✓ **无外部依赖** - 保持简单实用

## 快速开始

### 基本使用

```python
from core.smart_batch_processor import SmartBatchProcessor

# 创建处理器
processor = SmartBatchProcessor()

# 准备文件列表
files = [
    "The.Matrix.1999.1080p.BluRay.x264.mkv",
    "Inception.2010.1080p.BluRay.x264.mkv",
    "流浪地球.2019.1080p.BluRay.x264.mkv"
]

# 批量处理
result = processor.process_batch(files)

# 查看结果
print(f"成功: {result['stats']['success']}")
print(f"失败: {result['stats']['failed']}")
print(f"成功率: {result['stats']['success_rate']*100:.1f}%")
```

### 带进度回调

```python
def progress_callback(progress, current_file, result):
    """进度回调函数"""
    print(f"进度: {progress*100:.1f}% - {result['message']}")

# 使用进度回调
result = processor.process_batch(
    files,
    progress_callback=progress_callback
)
```

### 指定模板

```python
# 使用特定模板
result = processor.process_batch(
    files,
    template_name='movie_detailed'  # 详细模板
)
```

## 高级功能

### 1. 事件监听

```python
from core.events import get_event_bus

bus = get_event_bus()

# 监听批量处理开始
def on_batch_start(event):
    print(f"开始处理 {event.data['total_files']} 个文件")

bus.on('batch.process.start', on_batch_start)

# 监听进度更新
def on_batch_progress(event):
    progress = event.data['progress']
    stats = event.data['stats']
    print(f"进度: {progress*100:.1f}% - 成功: {stats['success']}")

bus.on('batch.process.progress', on_batch_progress)

# 监听处理完成
def on_batch_complete(event):
    stats = event.data['stats']
    print(f"完成! 成功率: {stats['success_rate']*100:.1f}%")

bus.on('batch.process.complete', on_batch_complete)
```

### 2. 统计信息

```python
# 获取详细统计
stats = result['stats']

print(f"总文件数: {stats['total_files']}")
print(f"处理文件数: {stats['processed_files']}")
print(f"成功: {stats['success']}")
print(f"失败: {stats['failed']}")
print(f"跳过: {stats['skipped']}")
print(f"成功率: {stats['success_rate']*100:.1f}%")
print(f"中文标题查询: {stats['chinese_title_queries']}")
print(f"模板渲染: {stats['template_renders']}")
print(f"处理时间: {stats['duration']:.2f}秒")

# 查看错误详情
if stats['errors']:
    print("\n错误详情:")
    for error in stats['errors']:
        print(f"  - {error}")
```

### 3. 处理结果

```python
# 遍历每个文件的处理结果
for result in result['results']:
    if result['success']:
        print(f"✓ {result['original_name']}")
        print(f"  → {result['new_name']}")
        print(f"  质量分数: {result['quality_score']}")
        
        # 如果查询了中文标题
        if result['info'].get('original_title'):
            print(f"  中文标题: {result['info']['original_title']} → {result['info']['title']}")
    else:
        print(f"✗ {result['file_path']}")
        print(f"  错误: {result['error']}")
```

## 可用模板

### 电影模板

- `movie_default` - 默认电影模板（推荐）
- `movie_simple` - 简单电影模板
- `movie_detailed` - 详细电影模板
- `nas_movie` - NAS 电影模板
- `plex_movie` - Plex 电影模板

### 电视剧模板

- `tv_default` - 默认电视剧模板（推荐）
- `tv_simple` - 简单电视剧模板
- `tv_detailed` - 详细电视剧模板
- `nas_tv` - NAS 电视剧模板
- `plex_tv` - Plex 电视剧模板

## 实际示例

### 示例 1: 批量处理电影

```python
from core.smart_batch_processor import SmartBatchProcessor

processor = SmartBatchProcessor()

movies = [
    "The.Matrix.1999.1080p.BluRay.x264.DTS.mkv",
    "Inception.2010.1080p.BluRay.x264.DTS.mkv",
    "Interstellar.2014.1080p.BluRay.x264.DTS.mkv"
]

result = processor.process_batch(movies, template_name='movie_detailed')

# 输出:
# The Matrix (1999)/The Matrix (1999) [1080p x264 DTS BluRay].mkv
# Inception (2010)/Inception (2010) [1080p x264 DTS BluRay].mkv
# Interstellar (2014)/Interstellar (2014) [1080p x264 DTS BluRay].mkv
```

### 示例 2: 批量处理电视剧

```python
tv_shows = [
    "Game.of.Thrones.S01E01.1080p.BluRay.x264.mkv",
    "Game.of.Thrones.S01E02.1080p.BluRay.x264.mkv",
    "Game.of.Thrones.S01E03.1080p.BluRay.x264.mkv"
]

result = processor.process_batch(tv_shows)

# 输出:
# Game of Thrones/Season 01/Game of Thrones - S01E01 [1080p-BluRay].mkv
# Game of Thrones/Season 01/Game of Thrones - S01E02 [1080p-BluRay].mkv
# Game of Thrones/Season 01/Game of Thrones - S01E03 [1080p-BluRay].mkv
```

### 示例 3: 混合处理（中英文）

```python
mixed_files = [
    "The.Matrix.1999.1080p.BluRay.x264.mkv",
    "流浪地球.2019.1080p.BluRay.x264.mkv",
    "Avengers.Endgame.2019.4K.UHD.BluRay.mkv",
    "权力的游戏.S01E01.1080p.BluRay.x265.mkv"
]

def progress_callback(progress, current_file, result):
    print(f"[{progress*100:.0f}%] {result['message']}")

result = processor.process_batch(
    mixed_files,
    progress_callback=progress_callback
)

print(f"\n处理完成! 成功率: {result['stats']['success_rate']*100:.1f}%")
```

## 性能优化

### 批量大小建议

- **小批量** (< 100 文件): 适合快速处理
- **中批量** (100-1000 文件): 推荐使用进度回调
- **大批量** (> 1000 文件): 建议分批处理

### 分批处理示例

```python
def process_in_batches(all_files, batch_size=100):
    """分批处理大量文件"""
    processor = SmartBatchProcessor()
    
    total_results = []
    total_stats = {
        'success': 0,
        'failed': 0,
        'total_files': len(all_files)
    }
    
    # 分批处理
    for i in range(0, len(all_files), batch_size):
        batch = all_files[i:i+batch_size]
        print(f"\n处理批次 {i//batch_size + 1}...")
        
        result = processor.process_batch(batch)
        
        total_results.extend(result['results'])
        total_stats['success'] += result['stats']['success']
        total_stats['failed'] += result['stats']['failed']
    
    # 计算总体成功率
    total_stats['success_rate'] = total_stats['success'] / total_stats['total_files']
    
    return {
        'results': total_results,
        'stats': total_stats
    }

# 使用
large_file_list = [...]  # 大量文件
result = process_in_batches(large_file_list, batch_size=100)
```

## 错误处理

### 常见错误

1. **文件识别失败** - 文件名格式不规范
2. **模板渲染失败** - 缺少必要的上下文变量
3. **中文标题查询失败** - 网络问题或 API 限制

### 错误处理示例

```python
result = processor.process_batch(files)

# 检查是否有错误
if result['stats']['failed'] > 0:
    print(f"\n发现 {result['stats']['failed']} 个错误:")
    
    for error in result['stats']['errors']:
        print(f"  - {error}")
    
    # 获取失败的文件
    failed_files = [
        r['file_path'] 
        for r in result['results'] 
        if not r['success']
    ]
    
    print(f"\n失败的文件:")
    for file in failed_files:
        print(f"  - {file}")
```

## 最佳实践

1. **使用进度回调** - 处理大量文件时提供用户反馈
2. **监听事件** - 集成到现有系统中
3. **检查统计信息** - 了解处理效果
4. **处理错误** - 记录并处理失败的文件
5. **选择合适的模板** - 根据需求选择模板
6. **分批处理** - 处理大量文件时分批进行

## 与其他功能集成

### 与 Web UI 集成

```python
from flask import Flask, jsonify, request
from core.smart_batch_processor import SmartBatchProcessor

app = Flask(__name__)
processor = SmartBatchProcessor()

@app.route('/api/batch-process', methods=['POST'])
def batch_process():
    files = request.json.get('files', [])
    template = request.json.get('template', None)
    
    result = processor.process_batch(files, template_name=template)
    
    return jsonify({
        'success': True,
        'results': result['results'],
        'stats': result['stats']
    })
```

### 与命令行工具集成

```python
import argparse
from core.smart_batch_processor import SmartBatchProcessor

def main():
    parser = argparse.ArgumentParser(description='批量处理媒体文件')
    parser.add_argument('files', nargs='+', help='文件列表')
    parser.add_argument('--template', help='模板名称')
    
    args = parser.parse_args()
    
    processor = SmartBatchProcessor()
    
    def progress_callback(progress, current_file, result):
        print(f"[{progress*100:.0f}%] {result['message']}")
    
    result = processor.process_batch(
        args.files,
        progress_callback=progress_callback,
        template_name=args.template
    )
    
    print(f"\n完成! 成功率: {result['stats']['success_rate']*100:.1f}%")

if __name__ == '__main__':
    main()
```

## 总结

智能批量处理器提供了强大而灵活的批量文件处理能力，借鉴了 media-renamer-2 的优秀设计，同时保持简单无依赖。通过实时进度跟踪、详细统计和事件驱动架构，可以轻松集成到各种应用场景中。
