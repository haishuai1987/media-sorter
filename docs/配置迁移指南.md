# 配置迁移指南

## 概述

新版本引入了统一的媒体库路径配置，支持二级分类功能。本指南将帮助您从旧配置迁移到新配置。

---

## 为什么要迁移？

### 旧配置的局限性

```
待整理路径: /vol02/1000-1-b23abde7/待整理
电影输出路径: /vol02/1000-1-b23abde7/电影
电视剧输出路径: /vol02/1000-1-b23abde7/电视剧
```

**问题**：
- ❌ 不支持二级分类（动作、喜剧、美剧等）
- ❌ 路径配置分散
- ❌ 无法自动检测现有结构
- ❌ 不支持中英文目录名称切换

### 新配置的优势

```
待整理路径: /vol02/1000-1-b23abde7/待整理
媒体库路径: /vol02/1000-1-b23abde7/115
语言偏好: 中文
```

**优势**：
- ✅ 支持二级分类（动作、喜剧、美剧、日剧等）
- ✅ 统一管理媒体库路径
- ✅ 自动检测现有目录结构
- ✅ 支持中英文目录名称
- ✅ 智能匹配现有分类
- ✅ 自动创建缺失的分类目录

---

## 自动迁移（推荐）

### 步骤 1：打开应用

访问应用首页，如果检测到旧配置，会自动弹出迁移提示对话框。

### 步骤 2：查看迁移信息

对话框会显示：
- 当前的旧配置信息
- 新配置的优势说明
- 安全提示（旧配置保留为备份）

### 步骤 3：一键迁移

点击 **"一键升级配置"** 按钮：
- 系统会自动推断媒体库根路径
- 设置默认语言偏好为中文
- 保留旧配置作为备份
- 自动检测媒体库结构

### 步骤 4：验证配置

迁移完成后：
1. 查看检测到的媒体库结构
2. 确认电影和电视剧目录正确
3. 查看现有的分类目录

---

## 手动迁移

如果您选择了"暂不升级"，可以随时手动迁移：

### 步骤 1：确定媒体库根路径

假设您的旧配置是：
```
电影输出路径: /vol02/1000-1-b23abde7/电影
电视剧输出路径: /vol02/1000-1-b23abde7/电视剧
```

媒体库根路径应该是它们的共同父目录：
```
媒体库路径: /vol02/1000-1-b23abde7
```

### 步骤 2：输入新配置

在设置页面：
1. 找到"媒体库路径"输入框
2. 输入媒体库根路径
3. 选择语言偏好（中文/English）

### 步骤 3：检测结构

点击 🔍 检测按钮，查看检测结果：
```
✓ 检测成功：
📁 电影目录: 电影
📁 电视剧目录: 电视剧
🎬 电影分类: 动作, 喜剧, 科幻
📺 电视剧分类: 美剧, 日剧, 韩剧
```

### 步骤 4：预览路径

点击 👁️ 预览路径按钮，确认配置正确：
- 查看待整理路径
- 查看媒体库路径
- 查看检测到的目录结构
- 查看文件将保存到的路径格式

---

## 路径推断规则

系统会根据旧配置自动推断媒体库根路径：

### 情况 1：同时有电影和电视剧路径

```
电影路径: /vol02/1000-1-b23abde7/电影
电视剧路径: /vol02/1000-1-b23abde7/电视剧
```

**推断结果**：`/vol02/1000-1-b23abde7`

### 情况 2：只有电影路径

```
电影路径: /vol02/1000-1-b23abde7/电影
```

**推断结果**：`/vol02/1000-1-b23abde7`（取父目录）

### 情况 3：只有电视剧路径

```
电视剧路径: /vol02/1000-1-b23abde7/电视剧
```

**推断结果**：`/vol02/1000-1-b23abde7`（取父目录）

### 情况 4：推断失败

如果无法推断，使用默认路径：`/vol02/1000-1-b23abde7/115`

---

## 迁移后的目录结构

### 新媒体库（无现有分类）

迁移后，系统会根据内容自动创建分类：

```
/vol02/1000-1-b23abde7/
├── 电影/
│   ├── 动作/
│   │   └── 速度与激情9 (2021)/
│   │       └── 速度与激情9 (2021).mkv
│   └── 科幻/
│       └── 沙丘 (2021)/
│           └── 沙丘 (2021).mkv
└── 电视剧/
    ├── 美剧/
    │   └── 权力的游戏/
    │       └── Season 01/
    │           └── 权力的游戏 - S01E01 - 第 01 集.mkv
    └── 日剧/
        └── 半泽直树/
            └── Season 01/
                └── 半泽直树 - S01E01 - 第 01 集.mkv
```

### 现有媒体库（有分类）

如果您已经有分类目录，系统会智能匹配：

```
/vol02/1000-1-b23abde7/
├── 电影/
│   ├── Action/          ← 匹配"动作"
│   ├── Comedy/          ← 匹配"喜剧"
│   └── Sci-Fi/          ← 匹配"科幻"
└── 电视剧/
    ├── 美剧/
    ├── Japanese Drama/  ← 匹配"日剧"
    └── Korean Drama/    ← 匹配"韩剧"
```

---

## 文件名格式

### 电视剧

**新格式**：
```
剧名 - S01E08 - 第 08 集.mkv
```

**特点**：
- 移除了 Season 信息（已在目录中体现）
- 保留季集信息（S01E08）
- 保留集数标题（第 08 集）

### 电影

**格式**：
```
电影名 (年份).mkv
```

**特点**：
- 简洁的文件名
- 包含年份信息

---

## 常见问题

### Q1: 迁移后旧配置还能用吗？

**A**: 可以。系统保持向后兼容，旧配置会保留在 localStorage 中。但旧配置不支持二级分类功能。

### Q2: 如何切换回旧配置？

**A**: 
1. 清除媒体库路径输入框
2. 使用电影和电视剧输出路径
3. 系统会自动使用旧配置方式

### Q3: 迁移会影响现有文件吗？

**A**: 不会。迁移只是更改配置，不会移动或修改现有文件。

### Q4: 如何重新触发迁移提示？

**A**: 
1. 打开浏览器开发者工具（F12）
2. 进入 Console 标签
3. 执行：`localStorage.removeItem('configMigrationSkipped')`
4. 刷新页面

### Q5: 媒体库路径检测失败怎么办？

**A**: 
- 检查路径是否正确
- 检查是否有读取权限
- 手动创建电影和电视剧目录
- 查看后端日志获取详细错误信息

### Q6: 如何自定义分类目录？

**A**: 
- 在媒体库的电影或电视剧目录下手动创建分类文件夹
- 系统会自动检测并使用这些分类
- 支持中英文混合的分类名称

### Q7: 语言偏好有什么作用？

**A**: 
- 决定新创建目录的名称语言
- 中文：电影、电视剧
- English：Movies、TV Shows
- 不影响现有目录的识别

---

## 技术细节

### 目录检测优先级

**电影目录**：
1. `电影`
2. `Movies`
3. `Movie`

**电视剧目录**：
1. `电视剧`
2. `TV Shows`
3. `TV`
4. `Series`

### 分类匹配规则

**精确匹配**：
- 分类名称完全相同（忽略大小写）

**模糊匹配**：
- 包含关系（如 "Action" 匹配 "动作"）
- 支持中英文互相匹配

### 缓存机制

- 分类目录扫描结果会缓存
- 避免重复扫描文件系统
- 提高批量处理性能

---

## 获取帮助

如果遇到问题：
1. 查看 [常见问题](./常见问题.md)
2. 查看 [使用指南](./使用指南.md)
3. 查看后端日志
4. 提交 Issue

---

## 总结

新配置方式提供了更强大和灵活的媒体库管理功能。建议所有用户迁移到新配置，以获得最佳体验。
