# 分类功能说明

## 概述

系统提供了两种互补的分类功能：

1. **规则分类**：基于 TMDB 元数据自动分类
2. **目录检测**：检测现有分类目录，智能匹配

---

## 功能对比

### 1. 规则分类（Rule-Based Classification）

**工作原理**：
- 从 TMDB API 获取电影/电视剧的元数据
- 根据预定义的规则（类型、语言、国家）自动分类
- 决定文件应该放到哪个分类目录

**配置位置**：
- `app.py` 中的 `CATEGORY_CONFIG`

**示例规则**：
```python
'国漫': {
    'genre_ids': ['16'],  # 动画类型
    'origin_country': ['CN', 'TW', 'HK']  # 中国地区
}
```

**优点**：
- 自动化程度高
- 基于准确的元数据
- 规则清晰明确

**适用场景**：
- 新建媒体库
- 标准化分类
- 批量整理

---

### 2. 目录检测（Directory Detection）

**工作原理**：
- 扫描媒体库中已存在的分类目录
- 智能匹配文件应该放到哪个已存在的目录
- 支持精确和模糊匹配

**实现类**：
- `MediaLibraryDetector`：检测电影/电视剧目录
- `SecondaryClassificationDetector`：检测分类目录
- `PathGenerator`：生成完整路径

**匹配规则**：
- 精确匹配：分类名称完全相同
- 模糊匹配：包含关系（如 "Action" 匹配 "动作"）
- 支持中英文混合

**优点**：
- 适应现有结构
- 灵活性高
- 支持自定义分类名称

**适用场景**：
- 已有媒体库
- 自定义分类
- 迁移整理

---

## 工作流程

### 完整流程

```
1. 扫描文件
   ↓
2. 识别文件信息（文件名解析）
   ↓
3. 查询 TMDB API（获取元数据）
   ↓
4. 规则分类（确定分类名称）
   ↓
5. 目录检测（查找/创建分类目录）
   ↓
6. 生成完整路径
   ↓
7. 移动文件
```

### 详细说明

#### 步骤 1-3：文件识别
```
文件: 权力的游戏.S01E01.mkv
  ↓
解析: 剧名=权力的游戏, 季=01, 集=01
  ↓
TMDB: genre_ids=[18, 10765], origin_country=['US']
```

#### 步骤 4：规则分类
```
元数据: genre_ids=[18, 10765], origin_country=['US']
  ↓
匹配规则: 欧美剧 (origin_country 包含 'US')
  ↓
分类名称: 欧美剧
```

#### 步骤 5：目录检测
```
媒体库路径: /media/
  ↓
检测电视剧目录: /media/TV Shows/
  ↓
检测分类目录: /media/TV Shows/US Drama/
  ↓
匹配结果: "US Drama" 匹配 "欧美剧"
  ↓
使用目录: /media/TV Shows/US Drama/
```

#### 步骤 6-7：生成路径并移动
```
完整路径: /media/TV Shows/US Drama/权力的游戏/Season 01/权力的游戏 - S01E01 - 第 01 集.mkv
  ↓
移动文件
```

---

## 配置示例

### 规则分类配置

**电影分类**：
```python
CATEGORY_CONFIG = {
    'movie': {
        '动画电影': {
            'genre_ids': ['16']
        },
        '华语电影': {
            'original_language': ['zh', 'cn', 'bo', 'za']
        },
        '外语电影': {}  # 默认
    }
}
```

**电视剧分类**：
```python
CATEGORY_CONFIG = {
    'tv': {
        '国漫': {
            'genre_ids': ['16'],
            'origin_country': ['CN', 'TW', 'HK']
        },
        '日番': {
            'genre_ids': ['16'],
            'origin_country': ['JP']
        },
        '国产剧': {
            'origin_country': ['CN', 'TW', 'HK']
        },
        '欧美剧': {
            'origin_country': ['US', 'FR', 'GB', 'DE', 'ES', 'IT', 'NL', 'PT', 'RU', 'UK']
        },
        '未分类': {}  # 默认
    }
}
```

### 目录检测配置

**媒体库路径**：
```
媒体库路径: /media/
语言偏好: 中文
```

**检测结果**：
```
电影目录: Movies
电视剧目录: TV Shows
电影分类: Action, Comedy, Sci-Fi
电视剧分类: US Drama, Japanese Drama, Chinese Drama
```

---

## 使用场景

### 场景 1：新建媒体库

**需求**：
- 从零开始建立媒体库
- 使用标准化的分类

**推荐方式**：
1. 配置媒体库路径
2. 选择语言偏好（中文/English）
3. 使用规则分类自动创建目录
4. 系统会自动创建：
   - 电影/Movies
   - 电视剧/TV Shows
   - 各个分类目录

**结果**：
```
媒体库/
├── 电影/
│   ├── 动画电影/
│   ├── 华语电影/
│   └── 外语电影/
└── 电视剧/
    ├── 国漫/
    ├── 日番/
    ├── 国产剧/
    ├── 欧美剧/
    └── 日韩剧/
```

---

### 场景 2：已有媒体库

**需求**：
- 已有自定义的分类目录
- 希望保持现有结构

**推荐方式**：
1. 配置媒体库路径
2. 点击检测按钮
3. 系统会检测现有分类
4. 智能匹配文件到现有目录

**示例**：
```
现有结构:
媒体库/
├── Movies/
│   ├── Action/
│   ├── Comedy/
│   └── Sci-Fi/
└── TV Shows/
    ├── US Drama/
    └── Japanese Drama/

规则分类结果: "欧美剧"
目录检测匹配: "US Drama"
最终路径: TV Shows/US Drama/
```

---

### 场景 3：混合使用

**需求**：
- 部分使用标准分类
- 部分使用自定义分类

**推荐方式**：
1. 使用规则分类确定分类名称
2. 使用目录检测匹配现有目录
3. 不存在的分类自动创建

**示例**：
```
规则分类: "国产剧"
目录检测: 
  - 精确匹配: "国产剧" ✓
  - 模糊匹配: "Chinese Drama" ✓
  - 不存在: 创建 "国产剧" 目录
```

---

## 常见问题

### Q1: 两种分类方式有什么区别？

**A**: 
- **规则分类**：决定文件应该属于哪个分类（基于元数据）
- **目录检测**：决定文件应该放到哪个目录（基于现有结构）

### Q2: 可以只使用其中一种吗？

**A**: 
- 两种方式是互补的，系统会自动结合使用
- 规则分类确定分类名称
- 目录检测确定实际目录

### Q3: 如何自定义分类规则？

**A**: 
- 编辑 `app.py` 中的 `CATEGORY_CONFIG`
- 添加或修改分类规则
- 重启服务生效

### Q4: 如何使用自定义的分类名称？

**A**: 
- 在媒体库中手动创建分类目录
- 系统会自动检测并使用
- 支持中英文混合

### Q5: 分类不准确怎么办？

**A**: 
- 检查 TMDB 元数据是否准确
- 调整分类规则的匹配条件
- 手动创建目录并使用目录检测

---

## 最佳实践

### 1. 新建媒体库

**步骤**：
1. 配置媒体库路径
2. 选择语言偏好
3. 使用默认的分类规则
4. 让系统自动创建目录

**优点**：
- 结构标准化
- 自动化程度高
- 易于维护

### 2. 迁移现有媒体库

**步骤**：
1. 配置媒体库路径
2. 点击检测按钮
3. 查看检测到的分类
4. 确认匹配结果

**优点**：
- 保持现有结构
- 平滑迁移
- 灵活性高

### 3. 混合使用

**步骤**：
1. 使用规则分类作为基础
2. 手动创建特殊分类目录
3. 系统自动匹配和创建

**优点**：
- 兼顾标准化和灵活性
- 适应各种需求
- 易于扩展

---

## 技术细节

### 规则分类实现

```python
def determine_category(metadata, media_type):
    """根据元数据确定分类"""
    config = CATEGORY_CONFIG.get(media_type, {})
    
    for category_name, rules in config.items():
        if match_rules(metadata, rules):
            return category_name
    
    return None  # 使用默认分类
```

### 目录检测实现

```python
class SecondaryClassificationDetector:
    """检测二级分类目录"""
    
    def get_category_dir(self, category_name):
        """获取分类目录名称"""
        # 精确匹配
        if category_name in self.existing_categories:
            return self.existing_categories[category_name]
        
        # 模糊匹配
        for dir_name in self.existing_categories.values():
            if self.fuzzy_match(category_name, dir_name):
                return dir_name
        
        # 不存在，返回原名称
        return category_name
```

---

## 总结

两种分类功能互补使用，提供了灵活而强大的媒体库管理能力：

✅ **规则分类** - 基于元数据，自动化程度高
✅ **目录检测** - 适应现有结构，灵活性高
✅ **智能匹配** - 精确和模糊匹配，支持中英文
✅ **自动创建** - 缺失的目录自动创建
✅ **易于扩展** - 支持自定义规则和目录

合理使用这两种功能，可以实现高度自动化和个性化的媒体库管理！
