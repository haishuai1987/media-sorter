# ä¼˜åŒ–äºŒç»´ç ç™»å½•æ–¹æ¡ˆ

## é—®é¢˜åˆ†æ

å½“å‰äºŒç»´ç ç™»å½•çš„é—®é¢˜ï¼š
1. âŒ éœ€è¦qrcodeåº“ç”ŸæˆäºŒç»´ç å›¾ç‰‡
2. âŒ åç«¯ç”Ÿæˆå›¾ç‰‡å¯èƒ½é˜»å¡
3. âŒ Webç«¯å¯èƒ½å¡æ­»

## è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨115å®˜æ–¹äºŒç»´ç å›¾ç‰‡

### æ ¸å¿ƒå‘ç°

115æä¾›äº†**ç°æˆçš„äºŒç»´ç å›¾ç‰‡URL**ï¼š
```
https://qrcodeapi.115.com/api/1.0/mac/1.0/qrcode?uid={uid}
```

**ä¸éœ€è¦è‡ªå·±ç”ŸæˆäºŒç»´ç ï¼** ç›´æ¥åœ¨å‰ç«¯æ˜¾ç¤ºè¿™ä¸ªURLçš„å›¾ç‰‡å³å¯ã€‚

### ä¼˜åŒ–åçš„æµç¨‹

```
å‰ç«¯                          åç«¯                        115 API
  â”‚                            â”‚                            â”‚
  â”‚  1. è¯·æ±‚å¼€å§‹æ‰«ç ç™»å½•         â”‚                            â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                            â”‚
  â”‚                            â”‚  2. è·å–Token              â”‚
  â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                            â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  3. è¿”å›äºŒç»´ç URLå’ŒToken    â”‚                            â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
  â”‚                            â”‚                            â”‚
  â”‚  4. æ˜¾ç¤ºäºŒç»´ç å›¾ç‰‡           â”‚                            â”‚
  â”‚  <img src="qr_url">        â”‚                            â”‚
  â”‚                            â”‚                            â”‚
  â”‚  5. è½®è¯¢æ£€æŸ¥çŠ¶æ€             â”‚                            â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚  6. æ£€æŸ¥æ‰«ç çŠ¶æ€            â”‚
  â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                            â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  7. è¿”å›çŠ¶æ€                â”‚                            â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
  â”‚                            â”‚                            â”‚
  â”‚  (é‡å¤5-7ç›´åˆ°æ‰«ç å®Œæˆ)       â”‚                            â”‚
  â”‚                            â”‚                            â”‚
  â”‚  8. æ‰«ç æˆåŠŸï¼Œè·å–Cookie     â”‚                            â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚  9. POSTè·å–Cookie         â”‚
  â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚                            â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  10. è¿”å›Cookie             â”‚                            â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
  â”‚                            â”‚                            â”‚
  â”‚  11. ä¿å­˜Cookieå¹¶åˆ·æ–°       â”‚                            â”‚
```

### ä¼˜åŠ¿

1. âœ… **ä¸éœ€è¦qrcodeåº“** - ä½¿ç”¨115å®˜æ–¹å›¾ç‰‡
2. âœ… **ä¸é˜»å¡åç«¯** - åªæ˜¯è¿”å›URLï¼Œä¸ç”Ÿæˆå›¾ç‰‡
3. âœ… **ä¸å¡æ­»Webç«¯** - å¼‚æ­¥è½®è¯¢ï¼Œä¸é˜»å¡UI
4. âœ… **ç”¨æˆ·ä½“éªŒå¥½** - å®æ—¶æ˜¾ç¤ºæ‰«ç çŠ¶æ€
5. âœ… **è·¨å¹³å°å…¼å®¹** - çº¯Webå®ç°

## å®ç°ä»£ç 

### åç«¯API

```python
@app.route('/api/qrcode/start', methods=['POST'])
def start_qrcode_login():
    """å¼€å§‹äºŒç»´ç ç™»å½•"""
    try:
        data = request.get_json()
        app_type = data.get('app', 'wechatmini')
        
        # 1. è·å–Token
        url = 'https://qrcodeapi.115.com/api/1.0/web/1.0/token/'
        response = requests.get(url, timeout=10)
        result = response.json()
        
        if not result.get('state'):
            return jsonify({'success': False, 'error': 'è·å–Tokenå¤±è´¥'})
        
        token_data = result.get('data', {})
        uid = token_data.get('uid')
        
        # 2. ç”ŸæˆäºŒç»´ç URLï¼ˆä¸éœ€è¦qrcodeåº“ï¼ï¼‰
        qr_url = f'https://qrcodeapi.115.com/api/1.0/mac/1.0/qrcode?uid={uid}'
        
        # 3. è¿”å›ç»™å‰ç«¯
        return jsonify({
            'success': True,
            'qr_url': qr_url,  # å‰ç«¯ç›´æ¥æ˜¾ç¤ºè¿™ä¸ªå›¾ç‰‡
            'uid': uid,
            'time': token_data.get('time'),
            'sign': token_data.get('sign'),
            'app': app_type
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/qrcode/check', methods=['POST'])
def check_qrcode_status():
    """æ£€æŸ¥äºŒç»´ç æ‰«ç çŠ¶æ€"""
    try:
        data = request.get_json()
        uid = data.get('uid')
        time_val = data.get('time')
        sign = data.get('sign')
        
        # æ£€æŸ¥çŠ¶æ€
        params = {'uid': uid, 'time': time_val, 'sign': sign}
        url = f'https://qrcodeapi.115.com/get/status/?{urlencode(params)}'
        response = requests.get(url, timeout=10)
        result = response.json()
        
        status_data = result.get('data', {})
        status_code = status_data.get('status')
        
        # çŠ¶æ€ç ï¼š
        # 0 - ç­‰å¾…æ‰«ç 
        # 1 - å·²æ‰«ç ï¼Œç­‰å¾…ç¡®è®¤
        # 2 - å·²ç¡®è®¤ï¼Œç™»å½•æˆåŠŸ
        # -1 - äºŒç»´ç è¿‡æœŸ
        # -2 - ç”¨æˆ·å–æ¶ˆ
        
        return jsonify({
            'success': True,
            'status': status_code
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/qrcode/finish', methods=['POST'])
def finish_qrcode_login():
    """å®ŒæˆäºŒç»´ç ç™»å½•ï¼Œè·å–Cookie"""
    try:
        data = request.get_json()
        uid = data.get('uid')
        app_type = data.get('app', 'wechatmini')
        
        # POSTè·å–Cookie
        url = f'https://passportapi.115.com/app/1.0/{app_type}/1.0/login/qrcode/'
        post_data = {'app': app_type, 'account': uid}
        response = requests.post(url, data=post_data, timeout=10)
        result = response.json()
        
        if not result.get('state'):
            return jsonify({'success': False, 'error': 'è·å–Cookieå¤±è´¥'})
        
        # æå–Cookie
        cookie_dict = result.get('data', {}).get('cookie', {})
        cookie_parts = []
        for key in ['UID', 'CID', 'SEID']:
            if key in cookie_dict:
                cookie_parts.append(f"{key}={cookie_dict[key]}")
        
        cookie = '; '.join(cookie_parts)
        
        # ä¿å­˜Cookie
        config = load_config()
        config['cloud115_cookie'] = cookie
        save_config(config)
        
        return jsonify({
            'success': True,
            'cookie': cookie
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})
```

### å‰ç«¯å®ç°

```javascript
// å¼€å§‹äºŒç»´ç ç™»å½•
async function startQRCodeLogin() {
  try {
    showLoading('æ­£åœ¨ç”ŸæˆäºŒç»´ç ...');
    
    const response = await fetch('/api/qrcode/start', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({app: 'wechatmini'})
    });
    
    const data = await response.json();
    
    if (data.success) {
      // æ˜¾ç¤ºäºŒç»´ç ï¼ˆç›´æ¥ç”¨imgæ ‡ç­¾æ˜¾ç¤ºURLï¼‰
      showQRCode(data.qr_url, data);
      
      // å¼€å§‹è½®è¯¢æ£€æŸ¥çŠ¶æ€
      startPolling(data);
    } else {
      showError('ç”ŸæˆäºŒç»´ç å¤±è´¥: ' + data.error);
    }
  } catch (error) {
    showError('è¯·æ±‚å¤±è´¥: ' + error.message);
  }
}

// æ˜¾ç¤ºäºŒç»´ç 
function showQRCode(qrUrl, tokenData) {
  const modal = document.getElementById('qrcode-modal');
  const img = document.getElementById('qrcode-image');
  const status = document.getElementById('qrcode-status');
  
  // ç›´æ¥æ˜¾ç¤º115çš„äºŒç»´ç å›¾ç‰‡
  img.src = qrUrl;
  img.style.display = 'block';
  
  status.textContent = 'è¯·ä½¿ç”¨115æ‰‹æœºå®¢æˆ·ç«¯æ‰«æäºŒç»´ç ';
  status.className = 'status-waiting';
  
  modal.style.display = 'block';
  
  // ä¿å­˜tokenæ•°æ®ç”¨äºè½®è¯¢
  window.qrcodeData = tokenData;
}

// è½®è¯¢æ£€æŸ¥çŠ¶æ€
function startPolling(tokenData) {
  let attempts = 0;
  const maxAttempts = 30; // 60ç§’è¶…æ—¶
  
  const pollInterval = setInterval(async () => {
    attempts++;
    
    if (attempts > maxAttempts) {
      clearInterval(pollInterval);
      showQRCodeStatus('äºŒç»´ç å·²è¿‡æœŸï¼Œè¯·é‡æ–°è·å–', 'error');
      return;
    }
    
    try {
      const response = await fetch('/api/qrcode/check', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          uid: tokenData.uid,
          time: tokenData.time,
          sign: tokenData.sign
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        const status = data.status;
        
        if (status === 0) {
          showQRCodeStatus('ç­‰å¾…æ‰«ç ...', 'waiting');
        } else if (status === 1) {
          showQRCodeStatus('å·²æ‰«ç ï¼Œè¯·åœ¨æ‰‹æœºä¸Šç¡®è®¤', 'scanned');
        } else if (status === 2) {
          // æ‰«ç æˆåŠŸï¼
          clearInterval(pollInterval);
          showQRCodeStatus('æ‰«ç æˆåŠŸï¼Œæ­£åœ¨è·å–Cookie...', 'success');
          
          // è·å–Cookie
          await finishLogin(tokenData);
        } else if (status === -1) {
          clearInterval(pollInterval);
          showQRCodeStatus('äºŒç»´ç å·²è¿‡æœŸ', 'error');
        } else if (status === -2) {
          clearInterval(pollInterval);
          showQRCodeStatus('ç”¨æˆ·å–æ¶ˆæ‰«ç ', 'error');
        }
      }
    } catch (error) {
      console.error('æ£€æŸ¥çŠ¶æ€å¤±è´¥:', error);
    }
  }, 2000); // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡
  
  // ä¿å­˜interval IDç”¨äºå–æ¶ˆ
  window.qrcodePolling = pollInterval;
}

// å®Œæˆç™»å½•
async function finishLogin(tokenData) {
  try {
    const response = await fetch('/api/qrcode/finish', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        uid: tokenData.uid,
        app: tokenData.app
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      showQRCodeStatus('ç™»å½•æˆåŠŸï¼', 'success');
      
      // å»¶è¿Ÿå…³é—­å¼¹çª—å¹¶åˆ·æ–°é¡µé¢
      setTimeout(() => {
        closeQRCodeModal();
        location.reload();
      }, 1500);
    } else {
      showQRCodeStatus('è·å–Cookieå¤±è´¥: ' + data.error, 'error');
    }
  } catch (error) {
    showQRCodeStatus('è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
  }
}

// æ˜¾ç¤ºçŠ¶æ€
function showQRCodeStatus(message, type) {
  const status = document.getElementById('qrcode-status');
  status.textContent = message;
  status.className = `status-${type}`;
}

// å…³é—­å¼¹çª—
function closeQRCodeModal() {
  const modal = document.getElementById('qrcode-modal');
  modal.style.display = 'none';
  
  // åœæ­¢è½®è¯¢
  if (window.qrcodePolling) {
    clearInterval(window.qrcodePolling);
  }
}
```

### HTMLç»“æ„

```html
<!-- äºŒç»´ç ç™»å½•æŒ‰é’® -->
<button onclick="startQRCodeLogin()" class="btn btn-primary">
  ğŸ“± æ‰«ç ç™»å½•
</button>

<!-- äºŒç»´ç å¼¹çª— -->
<div id="qrcode-modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeQRCodeModal()">&times;</span>
    <h2>æ‰«ç ç™»å½•115ç½‘ç›˜</h2>
    
    <!-- ç›´æ¥æ˜¾ç¤º115çš„äºŒç»´ç å›¾ç‰‡ -->
    <img id="qrcode-image" src="" alt="äºŒç»´ç " style="width: 300px; height: 300px;">
    
    <p id="qrcode-status" class="status-waiting">æ­£åœ¨åŠ è½½...</p>
    
    <div class="tips">
      <p>ğŸ’¡ æç¤ºï¼š</p>
      <ul>
        <li>è¯·ä½¿ç”¨115æ‰‹æœºå®¢æˆ·ç«¯æ‰«æäºŒç»´ç </li>
        <li>äºŒç»´ç æœ‰æ•ˆæœŸ60ç§’</li>
        <li>æ‰«ç åè¯·åœ¨æ‰‹æœºä¸Šç¡®è®¤ç™»å½•</li>
      </ul>
    </div>
  </div>
</div>
```

## æ€»ç»“

è¿™ä¸ªæ–¹æ¡ˆçš„å…³é”®ä¼˜åŠ¿ï¼š

1. **ä¸éœ€è¦qrcodeåº“** - ç›´æ¥ä½¿ç”¨115å®˜æ–¹äºŒç»´ç å›¾ç‰‡URL
2. **ä¸é˜»å¡åç«¯** - åªè¿”å›URLï¼Œä¸ç”Ÿæˆå›¾ç‰‡
3. **å¼‚æ­¥è½®è¯¢** - å‰ç«¯å®šæ—¶æ£€æŸ¥çŠ¶æ€ï¼Œä¸é˜»å¡UI
4. **å®æ—¶åé¦ˆ** - æ˜¾ç¤ºæ‰«ç è¿›åº¦ï¼ˆç­‰å¾…â†’å·²æ‰«ç â†’æˆåŠŸï¼‰
5. **è‡ªåŠ¨å®Œæˆ** - æ‰«ç æˆåŠŸåè‡ªåŠ¨è·å–Cookieå¹¶ä¿å­˜

**å®ç°æ—¶é—´ï¼š** çº¦1-2å°æ—¶
**ç”¨æˆ·ä½“éªŒï¼š** ä¼˜ç§€ï¼Œç±»ä¼¼ä¸»æµç½‘ç«™çš„æ‰«ç ç™»å½•
