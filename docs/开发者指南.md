# 开发者指南 (v2.0.0)

## 概述

本指南介绍如何基于 v2.0.0 的模块化架构进行开发和扩展。

## 架构概览

### 目录结构

```
media-renamer/
├── core/                 # 核心模块
│   ├── config.py        # 配置管理
│   ├── logger.py        # 日志系统
│   └── utils.py         # 工具函数
├── plugins/             # 插件系统
│   ├── base.py         # 插件基类
│   ├── loader.py       # 插件加载器
│   └── example_plugin.py  # 示例插件
├── processors/          # 处理器模块（待实现）
├── services/            # 服务模块（待实现）
└── api/                 # API模块（待实现）
```

### 核心模块

#### 1. 配置管理 (core/config.py)

```python
from core import ConfigManager

# 创建配置管理器
config = ConfigManager()

# 加载配置
config.load()

# 获取配置
api_key = config.get('tmdb_api_key')
max_workers = config.get('max_workers', 4)

# 设置配置
config.set('max_workers', 8)
config.set('nested.key', 'value')

# 保存配置
config.save()
```

#### 2. 日志系统 (core/logger.py)

```python
from core import Logger

# 创建日志记录器
logger = Logger('my_module')

# 记录日志
logger.debug('调试信息')
logger.info('普通信息')
logger.warning('警告信息')
logger.error('错误信息')
logger.exception('异常信息')  # 包含堆栈跟踪
```

#### 3. 工具函数 (core/utils.py)

```python
from core import Utils

# 文件大小格式化
size_str = Utils.format_size(1024 * 1024)  # "1.00 MB"

# 时间格式化
duration_str = Utils.format_duration(3665)  # "1.0小时"

# 文件名清理
clean_name = Utils.sanitize_filename('test<>:file?.txt')

# 列表分块
chunks = Utils.chunk_list([1,2,3,4,5], 2)  # [[1,2], [3,4], [5]]

# 字典合并
merged = Utils.merge_dicts({'a': 1}, {'b': 2})
```

## 插件开发

### 插件类型

#### 1. 处理器插件 (ProcessorPlugin)

用于数据处理和转换。

```python
from plugins.base import ProcessorPlugin

class MyProcessor(ProcessorPlugin):
    name = "my_processor"
    version = "1.0.0"
    description = "我的处理器插件"
    author = "Your Name"
    
    def on_load(self):
        print(f"{self.name} 已加载")
    
    def on_unload(self):
        print(f"{self.name} 已卸载")
    
    def process(self, data):
        # 处理逻辑
        processed_data = data.upper()
        return processed_data
```

#### 2. 服务插件 (ServicePlugin)

用于提供后台服务。

```python
from plugins.base import ServicePlugin

class MyService(ServicePlugin):
    name = "my_service"
    version = "1.0.0"
    
    def on_load(self):
        self.running = False
    
    def on_unload(self):
        if self.running:
            self.stop()
    
    def start(self):
        self.running = True
        print(f"{self.name} 服务已启动")
    
    def stop(self):
        self.running = False
        print(f"{self.name} 服务已停止")
```

#### 3. 钩子插件 (HookPlugin)

用于在处理前后执行操作。

```python
from plugins.base import HookPlugin

class MyHook(HookPlugin):
    name = "my_hook"
    version = "1.0.0"
    
    def on_load(self):
        pass
    
    def on_unload(self):
        pass
    
    def on_before_process(self, data):
        # 处理前钩子
        print(f"处理前: {data}")
        return data
    
    def on_after_process(self, data, result):
        # 处理后钩子
        print(f"处理后: {result}")
        return result
```

### 插件加载

```python
from plugins import PluginLoader

# 创建加载器
loader = PluginLoader()

# 发现插件
plugins = loader.discover_plugins()
print(f"发现 {len(plugins)} 个插件")

# 加载插件
loader.load_plugin('my_processor')

# 获取插件
plugin = loader.get_plugin('my_processor')
result = plugin.process("hello")

# 列出所有插件
plugin_list = loader.list_plugins()

# 卸载插件
loader.unload_plugin('my_processor')
```

## 最佳实践

### 1. 配置管理

```python
# 使用全局配置实例
from core.config import get_config

config = get_config()
api_key = config.get('tmdb_api_key')
```

### 2. 日志记录

```python
# 使用全局日志实例
from core.logger import get_logger

logger = get_logger()
logger.info('操作成功')
```

### 3. 错误处理

```python
from core import Logger

logger = Logger()

try:
    # 你的代码
    pass
except Exception as e:
    logger.exception('操作失败')
    # 处理错误
```

### 4. 插件配置

```python
class MyPlugin(ProcessorPlugin):
    def on_load(self):
        # 从配置中读取插件配置
        from core.config import get_config
        config = get_config()
        
        plugin_config = config.get(f'plugins.{self.name}', {})
        self.set_config(plugin_config)
    
    def process(self, data):
        # 使用插件配置
        option = self.get_config('option', 'default')
        # 处理逻辑
        return data
```

## API开发

### RESTful API设计

```python
# 统一响应格式
def success_response(data):
    return {
        'success': True,
        'data': data,
        'error': None,
        'timestamp': Utils.get_timestamp()
    }

def error_response(error_code, message, details=None):
    return {
        'success': False,
        'data': None,
        'error': {
            'code': error_code,
            'message': message,
            'details': details
        },
        'timestamp': Utils.get_timestamp()
    }
```

## 测试

### 单元测试

```python
def test_my_plugin():
    from plugins import PluginLoader
    
    loader = PluginLoader()
    loader.load_plugin('my_plugin')
    
    plugin = loader.get_plugin('my_plugin')
    result = plugin.process('test')
    
    assert result == 'TEST'
    print("✓ 测试通过")
```

### 集成测试

```python
def test_integration():
    from core import ConfigManager, Logger
    from plugins import PluginLoader
    
    # 配置
    config = ConfigManager()
    config.load()
    
    # 日志
    logger = Logger(level=config.get('log_level'))
    
    # 插件
    loader = PluginLoader()
    loader.load_all_plugins()
    
    logger.info(f"加载了 {len(loader.plugins)} 个插件")
    
    print("✓ 集成测试通过")
```

## 性能优化

### 1. 缓存

```python
from functools import lru_cache

@lru_cache(maxsize=128)
def expensive_operation(param):
    # 耗时操作
    return result
```

### 2. 并发处理

```python
from batch_processor import ConcurrentProcessor

processor = ConcurrentProcessor(max_workers=4)
result = processor.process_batch(items, handler)
```

### 3. 延迟加载

```python
class LazyLoader:
    def __init__(self):
        self._data = None
    
    @property
    def data(self):
        if self._data is None:
            self._data = self._load_data()
        return self._data
    
    def _load_data(self):
        # 加载数据
        return data
```

## 调试技巧

### 1. 启用调试日志

```python
from core import Logger

logger = Logger(level='DEBUG')
logger.debug('调试信息')
```

### 2. 性能分析

```python
import time

start = time.time()
# 你的代码
elapsed = time.time() - start
print(f"耗时: {elapsed:.2f}秒")
```

### 3. 内存分析

```python
import sys

obj = [1, 2, 3, 4, 5]
size = sys.getsizeof(obj)
print(f"对象大小: {size} 字节")
```

## 贡献指南

### 1. 代码风格

- 遵循 PEP 8
- 使用类型提示
- 添加文档字符串

### 2. 提交规范

```
feat: 新功能
fix: 修复bug
docs: 文档更新
refactor: 代码重构
test: 测试相关
```

### 3. 测试要求

- 所有新功能必须有测试
- 测试覆盖率 > 80%
- 所有测试必须通过

## 常见问题

**Q: 如何添加新的配置项？**  
A: 在 `core/config.py` 的 `DEFAULT_CONFIG` 中添加

**Q: 如何创建自定义插件类型？**  
A: 继承 `Plugin` 基类并定义自己的接口

**Q: 如何调试插件加载失败？**  
A: 查看控制台输出的错误信息和堆栈跟踪

**Q: 如何优化性能？**  
A: 使用缓存、并发处理和延迟加载

## 更多资源

- [CHANGELOG-v2.0.0.md](../CHANGELOG-v2.0.0.md) - 更新日志
- [test_architecture.py](../test_architecture.py) - 测试示例
- [plugins/example_plugin.py](../plugins/example_plugin.py) - 插件示例

---

**版本**: v2.0.0  
**更新日期**: 2025-01-XX
