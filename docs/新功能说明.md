# æ–°åŠŸèƒ½è¯´æ˜ (v2.1.0)

## ğŸ‰ æ–°å¢åŠŸèƒ½

v2.1.0 å¼•å…¥äº†ä¸‰ä¸ªå¼ºå¤§çš„æ–°åŠŸèƒ½ï¼Œæå‡äº†ç³»ç»Ÿçš„è¯†åˆ«å‡†ç¡®åº¦ã€çµæ´»æ€§å’Œå¯æ‰©å±•æ€§ã€‚

---

## 1ï¸âƒ£ é«˜çº§è¯†åˆ«å™¨

### æ¦‚è¿°

èåˆäº† NAS-Tools å’Œ MoviePilot çš„æœ€ä½³è¯†åˆ«ç®—æ³•ï¼Œæä¾›æ›´å‡†ç¡®ã€æ›´å…¨é¢çš„åª’ä½“æ–‡ä»¶è¯†åˆ«ã€‚

### ç‰¹æ€§

- âœ¨ **æ›´å…¨é¢çš„æ­£åˆ™æ¨¡å¼** - æ”¯æŒæ›´å¤šæ ¼å¼å’Œå‘½åé£æ ¼
- âœ¨ **æ™ºèƒ½æ ‡é¢˜æå–** - è‡ªåŠ¨ç§»é™¤è¯†åˆ«åˆ°çš„ä¿¡æ¯ï¼Œæå–çº¯å‡€æ ‡é¢˜
- âœ¨ **è´¨é‡è¯„åˆ†ç³»ç»Ÿ** - ç”¨äºæ™ºèƒ½å»é‡å’Œç‰ˆæœ¬æ¯”è¾ƒ
- âœ¨ **HDR è¯†åˆ«** - æ”¯æŒ HDR10+ã€Dolby Vision ç­‰
- âœ¨ **éŸ³é¢‘ç¼–ç è¯†åˆ«** - æ”¯æŒ Atmosã€TrueHDã€DTS-HD ç­‰

### ä½¿ç”¨æ–¹æ³•

```python
from core.advanced_recognizer import get_advanced_recognizer

# è·å–è¯†åˆ«å™¨å®ä¾‹
recognizer = get_advanced_recognizer()

# è¯†åˆ«æ–‡ä»¶
filename = "The.Matrix.1999.1080p.BluRay.x264.DTS-RARBG.mkv"
result = recognizer.recognize(filename)

print(f"æ ‡é¢˜: {result['title']}")
print(f"å¹´ä»½: {result['year']}")
print(f"åˆ†è¾¨ç‡: {result['resolution']}")
print(f"è§†é¢‘ç¼–ç : {result['video_codec']}")
print(f"éŸ³é¢‘ç¼–ç : {result['audio_codec']}")
print(f"æ¥æº: {result['source']}")

# è®¡ç®—è´¨é‡åˆ†æ•°
score = recognizer.get_quality_score(result)
print(f"è´¨é‡åˆ†æ•°: {score}")
```

### è¯†åˆ«ç»“æœ

```python
{
    'original_name': 'åŸå§‹æ–‡ä»¶å',
    'title': 'æ ‡é¢˜',
    'year': 2023,
    'season': 1,           # ç”µè§†å‰§å­£æ•°
    'episode': 1,          # ç”µè§†å‰§é›†æ•°
    'resolution': '1080p',
    'video_codec': 'H264',
    'audio_codec': 'AAC',
    'source': 'BluRay',
    'hdr': 'HDR10+',
    'language': ['chs', 'eng'],
    'subtitle': ['ç®€ä½“', 'ä¸­è‹±'],
    'release_group': 'RARBG',
    'is_tv': False,
}
```

### æ”¯æŒçš„æ ¼å¼

#### åˆ†è¾¨ç‡
- 8K, 4K, UHD, FHD, HD
- 2160p, 1080p, 720p, 480p, 360p

#### è§†é¢‘ç¼–ç 
- H.264, H264, x264, AVC
- H.265, H265, HEVC, x265
- AV1, VP9, MPEG-2

#### éŸ³é¢‘ç¼–ç 
- AAC, AC3, AC-3
- DTS, DTS-HD
- TrueHD, Atmos
- FLAC, DDP, DD+

#### æ¥æº
- BluRay, Blu-Ray, BDMV, BD
- WEB-DL, WEBDL, WEBRip
- HDTV, DVDRip, HDRip
- REMUX, BRRip

#### HDR
- HDR10, HDR10+
- Dolby Vision, DV
- HLG, SDR

---

## 2ï¸âƒ£ æ¨¡æ¿å¼•æ“

### æ¦‚è¿°

çµæ´»çš„æ–‡ä»¶å‘½åæ¨¡æ¿ç³»ç»Ÿï¼Œæ”¯æŒå¤šç§é¢„è®¾é£æ ¼å’Œè‡ªå®šä¹‰æ¨¡æ¿ã€‚

### ç‰¹æ€§

- âœ¨ **å¤šç§é¢„è®¾æ¨¡æ¿** - é»˜è®¤ã€ç®€å•ã€è¯¦ç»†ã€NAS-Toolsã€MoviePilotã€Plexã€Jellyfin é£æ ¼
- âœ¨ **è‡ªå®šä¹‰æ¨¡æ¿** - ç”¨æˆ·å¯ä»¥åˆ›å»ºè‡ªå·±çš„å‘½åæ¨¡æ¿
- âœ¨ **æ ¼å¼åŒ–æ”¯æŒ** - æ”¯æŒæ•°å­—æ ¼å¼åŒ–ï¼ˆå¦‚ `{season:02d}` â†’ `01`ï¼‰
- âœ¨ **æ¨¡æ¿éªŒè¯** - è‡ªåŠ¨éªŒè¯æ¨¡æ¿è¯­æ³•
- âœ¨ **æ™ºèƒ½æ¸…ç†** - è‡ªåŠ¨ç§»é™¤ç©ºæ‹¬å·å’Œå¤šä½™ç©ºæ ¼

### ä½¿ç”¨æ–¹æ³•

```python
from core.template_engine import get_template_engine

# è·å–æ¨¡æ¿å¼•æ“å®ä¾‹
engine = get_template_engine()

# å‡†å¤‡ä¸Šä¸‹æ–‡æ•°æ®
context = {
    'title': 'æµæµªåœ°çƒ',
    'year': 2019,
    'resolution': '1080p',
    'video_codec': 'H264',
    'audio_codec': 'AAC',
    'source': 'BluRay',
    'ext': 'mkv',
}

# ä½¿ç”¨é¢„è®¾æ¨¡æ¿
result = engine.render('movie_default', context)
print(result)
# è¾“å‡º: æµæµªåœ°çƒ (2019)/æµæµªåœ°çƒ (2019) [1080p-BluRay].mkv

# æ·»åŠ è‡ªå®šä¹‰æ¨¡æ¿
engine.add_template('my_style', '{title} [{year}] - {quality}.{ext}')
result = engine.render('my_style', context)
print(result)
# è¾“å‡º: æµæµªåœ°çƒ [2019] - 1080p-BluRay.mkv
```

### é¢„è®¾æ¨¡æ¿

#### ç”µå½±æ¨¡æ¿

| æ¨¡æ¿å | æ ¼å¼ | ç¤ºä¾‹ |
|--------|------|------|
| `movie_default` | `{title} ({year})/{title} ({year}) [{resolution}-{source}].{ext}` | æµæµªåœ°çƒ (2019)/æµæµªåœ°çƒ (2019) [1080p-BluRay].mkv |
| `movie_simple` | `{title} ({year})/{title} ({year}).{ext}` | æµæµªåœ°çƒ (2019)/æµæµªåœ°çƒ (2019).mkv |
| `movie_detailed` | `{title} ({year})/{title} ({year}) [{resolution} {video_codec} {audio_codec} {source}].{ext}` | æµæµªåœ°çƒ (2019)/æµæµªåœ°çƒ (2019) [1080p H264 AAC BluRay].mkv |
| `nas_movie` | NAS-Tools é£æ ¼ | æµæµªåœ°çƒ (2019)/æµæµªåœ°çƒ (2019) [1080p H264 AAC].mkv |
| `plex_movie` | Plex é£æ ¼ | æµæµªåœ°çƒ (2019)/æµæµªåœ°çƒ (2019).mkv |

#### ç”µè§†å‰§æ¨¡æ¿

| æ¨¡æ¿å | æ ¼å¼ | ç¤ºä¾‹ |
|--------|------|------|
| `tv_default` | `{title}/Season {season:02d}/{title} - S{season:02d}E{episode:02d} [{resolution}-{source}].{ext}` | æƒåŠ›çš„æ¸¸æˆ/Season 01/æƒåŠ›çš„æ¸¸æˆ - S01E01 [1080p-WEB-DL].mkv |
| `tv_simple` | `{title}/S{season:02d}/{title} - S{season:02d}E{episode:02d}.{ext}` | æƒåŠ›çš„æ¸¸æˆ/S01/æƒåŠ›çš„æ¸¸æˆ - S01E01.mkv |
| `tv_detailed` | è¯¦ç»†ä¿¡æ¯ | æƒåŠ›çš„æ¸¸æˆ/Season 01/æƒåŠ›çš„æ¸¸æˆ - S01E01 [1080p H265 DTS WEB-DL].mkv |
| `nas_tv` | NAS-Tools é£æ ¼ | æƒåŠ›çš„æ¸¸æˆ/Season 01/æƒåŠ›çš„æ¸¸æˆ S01E01 [1080p H265 DTS].mkv |
| `plex_tv` | Plex é£æ ¼ | æƒåŠ›çš„æ¸¸æˆ/Season 01/æƒåŠ›çš„æ¸¸æˆ - s01e01.mkv |

### å¯ç”¨å ä½ç¬¦

| å ä½ç¬¦ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|
| `{title}` | æ ‡é¢˜ | æµæµªåœ°çƒ |
| `{year}` | å¹´ä»½ | 2019 |
| `{season}` | å­£æ•° | 1 |
| `{season:02d}` | å­£æ•°ï¼ˆä¸¤ä½æ•°ï¼‰ | 01 |
| `{episode}` | é›†æ•° | 1 |
| `{episode:02d}` | é›†æ•°ï¼ˆä¸¤ä½æ•°ï¼‰ | 01 |
| `{resolution}` | åˆ†è¾¨ç‡ | 1080p |
| `{video_codec}` | è§†é¢‘ç¼–ç  | H264 |
| `{audio_codec}` | éŸ³é¢‘ç¼–ç  | AAC |
| `{source}` | æ¥æº | BluRay |
| `{quality}` | è´¨é‡ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰ | 1080p-BluRay |
| `{hdr}` | HDR ç±»å‹ | HDR10+ |
| `{ext}` | æ‰©å±•å | mkv |

### æ¨¡æ¿éªŒè¯

```python
# éªŒè¯æ¨¡æ¿
is_valid, error = engine.validate_template('{title} ({year}).{ext}')
if is_valid:
    print("æ¨¡æ¿æœ‰æ•ˆ")
else:
    print(f"æ¨¡æ¿æ— æ•ˆ: {error}")
```

---

## 3ï¸âƒ£ äº‹ä»¶ç³»ç»Ÿ

### æ¦‚è¿°

ç®€å•è€Œå¼ºå¤§çš„äº‹ä»¶é©±åŠ¨æ¶æ„ï¼Œæ”¯æŒæ¨¡å—è§£è€¦å’Œæ’ä»¶æ‰©å±•ã€‚

### ç‰¹æ€§

- âœ¨ **å‘å¸ƒ/è®¢é˜…æ¨¡å¼** - æ¾è€¦åˆçš„äº‹ä»¶é€šä¿¡
- âœ¨ **ä¼˜å…ˆçº§æ”¯æŒ** - æ§åˆ¶å¤„ç†å™¨æ‰§è¡Œé¡ºåº
- âœ¨ **ä¸€æ¬¡æ€§å¤„ç†å™¨** - åªè§¦å‘ä¸€æ¬¡çš„äº‹ä»¶å¤„ç†
- âœ¨ **äº‹ä»¶å†å²** - è®°å½•æœ€è¿‘çš„äº‹ä»¶
- âœ¨ **ç»Ÿè®¡ä¿¡æ¯** - äº‹ä»¶æ•°é‡å’Œç±»å‹ç»Ÿè®¡
- âœ¨ **è£…é¥°å™¨æ”¯æŒ** - ä¼˜é›…çš„äº‹ä»¶å¤„ç†å™¨å®šä¹‰

### ä½¿ç”¨æ–¹æ³•

#### åŸºæœ¬ç”¨æ³•

```python
from core.events import get_event_bus

# è·å–äº‹ä»¶æ€»çº¿å®ä¾‹
bus = get_event_bus()

# å®šä¹‰å¤„ç†å™¨
def on_file_processed(event):
    print(f"æ–‡ä»¶å·²å¤„ç†: {event.data['filename']}")

# è®¢é˜…äº‹ä»¶
bus.on('file.processed', on_file_processed)

# å‘å¸ƒäº‹ä»¶
bus.emit('file.processed', {'filename': 'test.mkv'})
```

#### ä½¿ç”¨è£…é¥°å™¨

```python
from core.events import event_handler

@event_handler('file.processed', priority=10)
def on_file_processed(event):
    print(f"æ–‡ä»¶å·²å¤„ç†: {event.data['filename']}")

# å‘å¸ƒäº‹ä»¶
from core.events import emit
emit('file.processed', {'filename': 'test.mkv'})
```

#### ä¸€æ¬¡æ€§å¤„ç†å™¨

```python
# åªè§¦å‘ä¸€æ¬¡
bus.once('app.ready', lambda event: print("åº”ç”¨å·²å°±ç»ª"))

bus.emit('app.ready')  # è§¦å‘
bus.emit('app.ready')  # ä¸è§¦å‘
```

#### ä¼˜å…ˆçº§

```python
# é«˜ä¼˜å…ˆçº§å…ˆæ‰§è¡Œ
bus.on('event', high_priority_handler, priority=10)
bus.on('event', low_priority_handler, priority=1)
```

### é¢„å®šä¹‰äº‹ä»¶ç±»å‹

```python
from core.events import EventTypes

# æ–‡ä»¶å¤„ç†äº‹ä»¶
EventTypes.FILE_SCAN_START
EventTypes.FILE_SCAN_COMPLETE
EventTypes.FILE_PROCESS_START
EventTypes.FILE_PROCESS_COMPLETE
EventTypes.FILE_RENAME_START
EventTypes.FILE_RENAME_COMPLETE
EventTypes.FILE_MOVE_START
EventTypes.FILE_MOVE_COMPLETE

# å…ƒæ•°æ®äº‹ä»¶
EventTypes.METADATA_QUERY_START
EventTypes.METADATA_QUERY_COMPLETE

# å»é‡äº‹ä»¶
EventTypes.DEDUPE_START
EventTypes.DEDUPE_COMPLETE
EventTypes.DEDUPE_FOUND

# å†²çªäº‹ä»¶
EventTypes.CONFLICT_DETECTED
EventTypes.CONFLICT_RESOLVED

# æ¸…ç†äº‹ä»¶
EventTypes.CLEANUP_START
EventTypes.CLEANUP_COMPLETE

# è¿›åº¦äº‹ä»¶
EventTypes.PROGRESS_UPDATE

# ç³»ç»Ÿäº‹ä»¶
EventTypes.SYSTEM_START
EventTypes.SYSTEM_STOP
EventTypes.SYSTEM_ERROR
```

### äº‹ä»¶å¯¹è±¡

```python
class Event:
    type: str          # äº‹ä»¶ç±»å‹
    data: Any          # äº‹ä»¶æ•°æ®
    source: str        # äº‹ä»¶æ¥æº
    timestamp: float   # æ—¶é—´æˆ³
    datetime: datetime # æ—¥æœŸæ—¶é—´
```

### ç»Ÿè®¡å’Œå†å²

```python
# è·å–ç»Ÿè®¡ä¿¡æ¯
stats = bus.get_stats()
print(f"æ€»äº‹ä»¶æ•°: {stats['total_events']}")
print(f"æŒ‰ç±»å‹ç»Ÿè®¡: {stats['events_by_type']}")

# è·å–äº‹ä»¶å†å²
history = bus.get_history(limit=10)
for event in history:
    print(f"{event.type} @ {event.datetime}")
```

---

## ğŸ”— é›†æˆç¤ºä¾‹

### å®Œæ•´çš„æ–‡ä»¶å¤„ç†æµç¨‹

```python
from core.advanced_recognizer import get_advanced_recognizer
from core.template_engine import get_template_engine
from core.events import get_event_bus, EventTypes

# åˆå§‹åŒ–
recognizer = get_advanced_recognizer()
engine = get_template_engine()
bus = get_event_bus()

# è®¾ç½®äº‹ä»¶ç›‘å¬
@event_handler(EventTypes.FILE_PROCESS_START)
def on_start(event):
    print(f"å¼€å§‹å¤„ç†: {event.data['filename']}")

@event_handler(EventTypes.FILE_PROCESS_COMPLETE)
def on_complete(event):
    print(f"å¤„ç†å®Œæˆ: {event.data['new_name']}")

# å¤„ç†æ–‡ä»¶
def process_file(filename):
    # 1. å‘å¸ƒå¼€å§‹äº‹ä»¶
    bus.emit(EventTypes.FILE_PROCESS_START, {'filename': filename})
    
    # 2. è¯†åˆ«æ–‡ä»¶
    info = recognizer.recognize(filename)
    
    # 3. ç”Ÿæˆæ–°æ–‡ä»¶å
    context = {
        'title': info['title'],
        'year': info['year'],
        'season': info['season'],
        'episode': info['episode'],
        'resolution': info['resolution'],
        'video_codec': info['video_codec'],
        'audio_codec': info['audio_codec'],
        'source': info['source'],
        'ext': 'mkv',
    }
    
    template = 'tv_default' if info['is_tv'] else 'movie_default'
    new_name = engine.render(template, context)
    
    # 4. å‘å¸ƒå®Œæˆäº‹ä»¶
    bus.emit(EventTypes.FILE_PROCESS_COMPLETE, {
        'filename': filename,
        'new_name': new_name,
        'quality_score': recognizer.get_quality_score(info)
    })
    
    return new_name

# ä½¿ç”¨
new_name = process_file("The.Matrix.1999.1080p.BluRay.x264.DTS.mkv")
print(f"æ–°æ–‡ä»¶å: {new_name}")
```

---

## ğŸ“ æµ‹è¯•

è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯æ‰€æœ‰åŠŸèƒ½ï¼š

```bash
python test_new_features.py
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥

è¿™äº›æ–°åŠŸèƒ½ä¸ºæœªæ¥çš„æ‰©å±•å¥ å®šäº†åŸºç¡€ï¼š

- **v2.2.0**: åŸºäºæ¨¡æ¿çš„æ‰¹é‡é‡å‘½å
- **v2.3.0**: æ’ä»¶ç³»ç»Ÿå¢å¼ºï¼ˆä½¿ç”¨äº‹ä»¶ç³»ç»Ÿï¼‰
- **v3.0.0**: å¯é€‰çš„é«˜çº§åŠŸèƒ½ï¼ˆRedisç¼“å­˜ã€å¼‚æ­¥ä»»åŠ¡ï¼‰

---

## ğŸ’¡ æœ€ä½³å®è·µ

1. **ä½¿ç”¨é«˜çº§è¯†åˆ«å™¨** - è·å¾—æ›´å‡†ç¡®çš„è¯†åˆ«ç»“æœ
2. **è‡ªå®šä¹‰æ¨¡æ¿** - æ ¹æ®ä¸ªäººå–œå¥½åˆ›å»ºå‘½åæ¨¡æ¿
3. **ç›‘å¬äº‹ä»¶** - å®ç°è‡ªå®šä¹‰çš„å¤„ç†é€»è¾‘
4. **ç»„åˆä½¿ç”¨** - ä¸‰ä¸ªåŠŸèƒ½é…åˆä½¿ç”¨æ•ˆæœæœ€ä½³

---

**äº«å—æ–°åŠŸèƒ½å¸¦æ¥çš„å¼ºå¤§èƒ½åŠ›ï¼** ğŸš€
