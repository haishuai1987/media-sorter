# 中文标题解析说明

## 🎯 核心原则

**所有非中文标题都必须转换为中文标题！**

---

## 📋 问题说明

### 之前的问题

**高级识别器只提取文件名中的信息，不查询中文标题：**

```
输入: The.Wandering.Earth.2019.1080p.BluRay.x264.AAC-RARBG.mkv
输出: 标题 = "The Wandering Earth"  ❌ 这是英文！

输入: Avengers.Endgame.2019.4K.UHD.BluRay.REMUX.HDR10+.mkv
输出: 标题 = "Avengers Endgame"  ❌ 这是英文！
```

### 正确的做法

**高级识别器 + 中文标题解析器 = 完整解决方案：**

```
输入: The.Wandering.Earth.2019.1080p.BluRay.x264.AAC-RARBG.mkv
步骤 1: 高级识别 → "The Wandering Earth"
步骤 2: 查询 TMDB/豆瓣 → "流浪地球"  ✓
输出: 流浪地球 (2019)/流浪地球 (2019) [1080p-BluRay].mkv

输入: Avengers.Endgame.2019.4K.UHD.BluRay.REMUX.HDR10+.mkv
步骤 1: 高级识别 → "Avengers Endgame"
步骤 2: 查询 TMDB/豆瓣 → "复仇者联盟4：终局之战"  ✓
输出: 复仇者联盟4：终局之战 (2019)/复仇者联盟4：终局之战 (2019) [4K-BluRay].mkv
```

---

## 🔧 解决方案

### 1. 中文标题解析器

**文件**: `core/chinese_title_resolver.py`

**功能**：
- ✅ 自动检测标题是否为中文
- ✅ 英文标题自动查询 TMDB/豆瓣
- ✅ 优先使用豆瓣（中文结果更准确）
- ✅ 豆瓣失败时使用 TMDB
- ✅ 缓存查询结果，提高性能

### 2. 集成识别器

**类**: `IntegratedRecognizer`

**功能**：
- ✅ 整合高级识别器 + 中文标题解析器
- ✅ 一步完成：识别 + 中文标题查询
- ✅ 保留原始英文标题（`original_title` 字段）

---

## 💻 使用方法

### 基本用法

```python
from core.chinese_title_resolver import IntegratedRecognizer

# 创建识别器（需要配置 API）
recognizer = IntegratedRecognizer(
    tmdb_api_key="YOUR_TMDB_API_KEY",
    douban_cookie="YOUR_DOUBAN_COOKIE"
)

# 识别文件（自动获取中文标题）
filename = "The.Matrix.1999.1080p.BluRay.x264.DTS.mkv"
info = recognizer.recognize_with_chinese_title(filename)

print(f"标题: {info['title']}")  # 黑客帝国
print(f"原始标题: {info.get('original_title')}")  # The Matrix
print(f"年份: {info['year']}")  # 1999
```

### 完整流程

```python
from core.chinese_title_resolver import IntegratedRecognizer
from core.template_engine import get_template_engine

# 1. 创建识别器
recognizer = IntegratedRecognizer(
    tmdb_api_key=TMDB_API_KEY,
    douban_cookie=DOUBAN_COOKIE
)

# 2. 识别文件（自动获取中文标题）
filename = "The.Wandering.Earth.2019.1080p.BluRay.x264.AAC.mkv"
info = recognizer.recognize_with_chinese_title(filename)

# 3. 使用模板生成新文件名
engine = get_template_engine()
new_name = engine.render('movie_default', {
    'title': info['title'],  # 流浪地球（中文）
    'year': info['year'],
    'resolution': info['resolution'],
    'source': info['source'],
    'ext': 'mkv',
})

print(new_name)
# 输出: 流浪地球 (2019)/流浪地球 (2019) [1080p-BluRay].mkv
```

---

## 🔄 工作流程

```
┌─────────────────────────────────────────────────────────┐
│  输入文件名                                              │
│  The.Wandering.Earth.2019.1080p.BluRay.x264.AAC.mkv    │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│  步骤 1: 高级识别器                                      │
│  - 提取标题: "The Wandering Earth"                      │
│  - 提取年份: 2019                                       │
│  - 提取分辨率: 1080p                                    │
│  - 提取来源: BluRay                                     │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│  步骤 2: 检测标题语言                                    │
│  - 检测到英文标题                                        │
│  - 需要查询中文标题                                      │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│  步骤 3: 查询中文标题                                    │
│  - 优先查询豆瓣: "The Wandering Earth" + 2019           │
│  - 找到中文标题: "流浪地球"                              │
│  - 保存原始标题: original_title = "The Wandering Earth" │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│  步骤 4: 使用模板生成新文件名                            │
│  - 模板: movie_default                                  │
│  - 标题: 流浪地球（中文）                                │
│  - 年份: 2019                                           │
│  - 分辨率: 1080p                                        │
│  - 来源: BluRay                                         │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│  输出文件名                                              │
│  流浪地球 (2019)/流浪地球 (2019) [1080p-BluRay].mkv    │
└─────────────────────────────────────────────────────────┘
```

---

## 📊 示例对比

### 示例 1: 英文电影

| 阶段 | 内容 |
|------|------|
| **输入** | `The.Matrix.1999.1080p.BluRay.x264.DTS.mkv` |
| **高级识别** | 标题: "The Matrix", 年份: 1999 |
| **中文查询** | 查询 TMDB/豆瓣 → "黑客帝国" |
| **输出** | `黑客帝国 (1999)/黑客帝国 (1999) [1080p-BluRay].mkv` |

### 示例 2: 英文电视剧

| 阶段 | 内容 |
|------|------|
| **输入** | `Game.of.Thrones.S08E06.1080p.WEB-DL.H264.mkv` |
| **高级识别** | 标题: "Game of Thrones", 季: 8, 集: 6 |
| **中文查询** | 查询 TMDB/豆瓣 → "权力的游戏" |
| **输出** | `权力的游戏/Season 08/权力的游戏 - S08E06 [1080p-WEB-DL].mkv` |

### 示例 3: 中文电影（无需查询）

| 阶段 | 内容 |
|------|------|
| **输入** | `流浪地球.2019.1080p.BluRay.x264.AAC.mkv` |
| **高级识别** | 标题: "流浪地球", 年份: 2019 |
| **中文检测** | ✓ 已经是中文，跳过查询 |
| **输出** | `流浪地球 (2019)/流浪地球 (2019) [1080p-BluRay].mkv` |

---

## ⚙️ 配置要求

### TMDB API Key

1. 访问 https://www.themoviedb.org/settings/api
2. 注册账号
3. 申请 API Key（免费）
4. 配置到程序中

### 豆瓣 Cookie

1. 登录 https://movie.douban.com/
2. 按 F12 打开开发者工具
3. Network 标签 → 刷新页面
4. 复制 Cookie
5. 配置到程序中

---

## 🎯 关键点

### ✅ 优势

1. **确保中文标题** - 所有英文标题都会自动转换
2. **智能检测** - 中文标题不会重复查询
3. **双重保险** - 豆瓣 + TMDB 双重查询
4. **保留原始** - 原始英文标题保存在 `original_title`
5. **性能优化** - 查询结果缓存

### ⚠️ 注意事项

1. **需要网络** - 查询 TMDB/豆瓣需要网络连接
2. **需要配置** - 必须配置 API Key 和 Cookie
3. **查询延迟** - 首次查询会有网络延迟
4. **失败处理** - 查询失败时保留英文标题

---

## 🔗 在 app.py 中集成

### 修改现有代码

```python
# 在 app.py 顶部添加导入
from core.chinese_title_resolver import IntegratedRecognizer

# 创建全局识别器实例
integrated_recognizer = None

def get_recognizer():
    """获取集成识别器"""
    global integrated_recognizer
    if integrated_recognizer is None:
        integrated_recognizer = IntegratedRecognizer(
            tmdb_api_key=TMDB_API_KEY,
            douban_cookie=DOUBAN_COOKIE
        )
    return integrated_recognizer

# 在处理文件时使用
def process_file(filename):
    recognizer = get_recognizer()
    
    # 自动获取中文标题
    info = recognizer.recognize_with_chinese_title(filename)
    
    # info['title'] 现在是中文标题
    # 使用模板生成新文件名
    from core.template_engine import get_template_engine
    engine = get_template_engine()
    
    template = 'tv_default' if info['is_tv'] else 'movie_default'
    new_name = engine.render(template, {
        'title': info['title'],  # 中文标题
        'year': info['year'],
        'season': info['season'],
        'episode': info['episode'],
        'resolution': info['resolution'],
        'source': info['source'],
        'ext': 'mkv',
    })
    
    return new_name
```

---

## 🧪 测试

运行测试脚本：

```bash
python test_chinese_title.py
```

---

## 📝 总结

**完整解决方案 = 高级识别器 + 中文标题解析器 + 模板引擎**

```
英文文件名 → 高级识别 → 中文查询 → 模板生成 → 中文文件名 ✓
```

**确保所有标题最终都是中文！** 🎯
