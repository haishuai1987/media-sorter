# 🚀 快速部署指南

## 📦 准备工作

**需要的文件：**
- `app.py` - 后端服务器
- `index.html` - 前端页面
- `install.sh` - 一键部署脚本（可选）

**文件位置：** `E:\media-renamer`

---

## 🎯 一键部署（推荐）

### 第1步：上传文件到飞牛OS

在Windows PowerShell中执行：

```powershell
# 进入项目目录
cd E:\media-renamer

# 上传文件（替换为你的实际IP地址）
scp app.py index.html install.sh root@192.168.1.100:/root/
```

输入root密码后等待上传完成。

### 第2步：SSH登录飞牛OS

```powershell
ssh root@192.168.1.100
```

### 第3步：运行部署脚本

```bash
# 创建目录并移动文件
mkdir -p /root/media-manager
mv /root/app.py /root/index.html /root/install.sh /root/media-manager/

# 进入目录
cd /root/media-manager

# 添加执行权限
chmod +x install.sh

# 运行部署脚本
./install.sh
```

### 第4步：完成！

看到以下信息表示部署成功：

```
==================================================
🎉 部署完成！
==================================================

✅ 服务状态：
   • 当前状态: 运行中
   • 开机自启: 已启用
   • 崩溃重启: 已启用（10秒后自动重启）

📱 访问地址：
   http://localhost:8090
   http://192.168.1.100:8090

📋 常用命令：
   查看状态: systemctl status media-manager
   查看日志: journalctl -u media-manager -f
   重启服务: systemctl restart media-manager
   停止服务: systemctl stop media-manager
   禁用自启: systemctl disable media-manager

📂 扫描路径: /vol02/1000-1-b23abde7/待整理

💡 提示：
   服务已设置为后台常驻运行
   系统重启后会自动启动
   如果崩溃会在10秒后自动重启

==================================================
```

---

## 🔧 手动部署（不使用脚本）

### 第1步：上传文件

```powershell
cd E:\media-renamer
scp app.py index.html root@192.168.1.100:/root/
```

### 第2步：SSH登录

```bash
ssh root@192.168.1.100
```

### 第3步：创建目录

```bash
mkdir -p /root/media-manager
mv /root/app.py /root/index.html /root/media-manager/
cd /root/media-manager
```

### 第4步：创建systemd服务

```bash
cat > /etc/systemd/system/media-manager.service << 'EOF'
[Unit]
Description=Media Manager Service V1
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/root/media-manager
ExecStart=/usr/bin/python3 /root/media-manager/app.py
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF
```

### 第5步：启动服务

```bash
# 重载systemd配置
systemctl daemon-reload

# 启动服务
systemctl start media-manager

# 设置开机自启
systemctl enable media-manager

# 查看状态
systemctl status media-manager
```

---

## 📋 服务管理命令

### 查看服务状态
```bash
systemctl status media-manager
```

### 查看实时日志
```bash
journalctl -u media-manager -f
```

### 查看最近50条日志
```bash
journalctl -u media-manager -n 50
```

### 重启服务
```bash
systemctl restart media-manager
```

### 停止服务
```bash
systemctl stop media-manager
```

### 启动服务
```bash
systemctl start media-manager
```

### 禁用开机自启
```bash
systemctl disable media-manager
```

### 启用开机自启
```bash
systemctl enable media-manager
```

---

## ✅ 服务特性

### 🔄 自动重启
- 如果程序崩溃，10秒后自动重启
- 配置项：`Restart=always` 和 `RestartSec=10`

### 🚀 开机自启
- 系统启动后自动运行服务
- 配置项：`WantedBy=multi-user.target`

### 📝 日志记录
- 所有输出记录到系统日志
- 使用 `journalctl` 查看日志

### 🔒 权限管理
- 以root用户运行
- 可以访问所有文件夹

---

## 🔄 更新程序

### 方法一：使用脚本更新

```bash
# 停止服务
systemctl stop media-manager

# 上传新文件（在Windows上执行）
cd E:\media-renamer
scp app.py index.html root@192.168.1.100:/root/media-manager/

# 启动服务（在飞牛OS上执行）
systemctl start media-manager
```

### 方法二：不停机更新

```bash
# 上传新文件
scp app.py index.html root@192.168.1.100:/root/media-manager/

# 重启服务
ssh root@192.168.1.100 "systemctl restart media-manager"
```

---

## 🐛 故障排除

### 服务无法启动

```bash
# 查看详细错误
journalctl -u media-manager -n 50

# 手动运行查看错误
cd /root/media-manager
python3 app.py
```

### 端口被占用

```bash
# 查看8090端口占用
netstat -tulpn | grep 8090

# 修改端口（编辑app.py）
nano /root/media-manager/app.py
# 修改 PORT = 8090 为其他端口
```

### 权限问题

```bash
# 检查文件权限
ls -la /root/media-manager/

# 修复权限
chmod 644 /root/media-manager/app.py
chmod 644 /root/media-manager/index.html
```

### 服务状态异常

```bash
# 重载systemd配置
systemctl daemon-reload

# 重启服务
systemctl restart media-manager

# 查看状态
systemctl status media-manager
```

---

## 📞 验证部署

### 1. 检查服务状态
```bash
systemctl status media-manager
```

应该显示：`Active: active (running)`

### 2. 检查端口监听
```bash
netstat -tulpn | grep 8090
```

应该显示：`python3` 在监听 `8090` 端口

### 3. 访问Web界面
在浏览器打开：`http://你的NAS_IP:8090`

### 4. 测试重启
```bash
# 重启系统
reboot

# 重启后检查服务
systemctl status media-manager
```

服务应该自动运行。

---

## 💡 最佳实践

1. **定期查看日志**
   ```bash
   journalctl -u media-manager -f
   ```

2. **备份配置**
   ```bash
   cp /etc/systemd/system/media-manager.service /root/media-manager.service.backup
   ```

3. **监控服务状态**
   ```bash
   # 添加到crontab，每小时检查一次
   0 * * * * systemctl is-active media-manager || systemctl restart media-manager
   ```

4. **日志轮转**
   ```bash
   # 限制日志大小
   journalctl --vacuum-size=100M
   ```

---

## 🎉 部署完成检查清单

- [ ] 文件已上传到 `/root/media-manager/`
- [ ] systemd服务已创建
- [ ] 服务状态为 `active (running)`
- [ ] 开机自启已启用
- [ ] 可以访问Web界面 `http://NAS_IP:8090`
- [ ] 测试重启后服务自动启动
- [ ] 日志正常输出

全部完成后，你的媒体管理器就已经成功部署并配置为常驻服务了！🎊
