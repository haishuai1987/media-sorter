# 相同文件处理说明

## 问题场景

当使用"自动比较"策略时，如果新旧文件质量完全相同，系统应该如何处理？

## 处理逻辑

### 判断标准

系统通过以下维度判断文件是否"完全相同"：

1. **质量评分相同**
   - 分辨率评分相同
   - 来源质量评分相同
   - 编码格式评分相同

2. **文件大小基本相同**
   - 差异小于 1MB（1024KB）
   - 考虑到不同压制可能有微小差异

### 处理策略

当判断为"完全相同"时：

```
✓ 决策: 文件质量和大小基本相同，保留旧文件（避免重复操作）
⏭️ 跳过处理
```

**原因：**
- 避免不必要的文件移动和删除操作
- 减少网盘IO压力
- 保护已整理好的文件
- 节省处理时间

## 实际案例

### 案例1: 完全相同的文件

```
场景: 重复扫描同一个文件夹

旧文件: /vol02/电视剧/日番/异世界默示录麦诺格拉 (2025)/Season 1/异世界默示录麦诺格拉 - S01E01.mkv
        1080p WEB-DL, 1.5GB

新文件: /vol02/待整理/Apocalypse Bringer Mynoghra.S01E01.1080p.WEB-DL.mkv
        1080p WEB-DL, 1.5GB

比较过程:
├── 质量评分: 新文件=1140分, 旧文件=1140分
├── 文件大小: 新文件=1.5GB, 旧文件=1.5GB
├── 大小差异: 0MB < 1MB阈值
└── 判断: 文件质量和大小基本相同

决策: ⏭️ 保留旧文件，跳过新文件
原因: 文件质量和大小基本相同，已保留旧文件
```

### 案例2: 微小差异（仍视为相同）

```
场景: 不同压制工具产生的微小差异

旧文件: 异世界默示录麦诺格拉 - S01E01.mkv
        1080p WEB-DL, 1500.5MB

新文件: Apocalypse Bringer Mynoghra.S01E01.1080p.WEB-DL.mkv
        1080p WEB-DL, 1500.8MB

比较过程:
├── 质量评分: 新文件=1140分, 旧文件=1140分
├── 文件大小: 新文件=1500.8MB, 旧文件=1500.5MB
├── 大小差异: 0.3MB < 1MB阈值
└── 判断: 文件质量和大小基本相同

决策: ⏭️ 保留旧文件，跳过新文件
原因: 差异太小，可能是相同文件的不同压制
```

### 案例3: 明显差异（不同文件）

```
场景: 相同质量但文件大小差异较大

旧文件: 异世界默示录麦诺格拉 - S01E01.mkv
        1080p WEB-DL, 1.2GB

新文件: Apocalypse Bringer Mynoghra.S01E01.1080p.WEB-DL.mkv
        1080p WEB-DL, 2.5GB

比较过程:
├── 质量评分: 新文件=1140分, 旧文件=1140分
├── 文件大小: 新文件=2.5GB, 旧文件=1.2GB
├── 大小差异: 1.3GB > 1MB阈值
└── 判断: 新文件更大

决策: ✓ 删除旧文件，保留新文件
原因: 新文件更大，可能包含更多音轨或更高码率
```

## 为什么选择1MB作为阈值？

### 考虑因素

1. **容器格式差异**
   - MKV vs MP4 容器开销不同
   - 元数据大小差异
   - 章节信息差异

2. **压制工具差异**
   - 不同工具的封装方式
   - 字幕封装方式不同
   - 音轨封装差异

3. **实际测试**
   - 相同视频用不同工具封装，差异通常 < 500KB
   - 1MB是一个安全的阈值
   - 既能识别相同文件，又不会误判

### 阈值对比

| 阈值 | 优点 | 缺点 |
|------|------|------|
| 100KB | 精确识别 | 容易误判为不同文件 |
| **1MB** | **平衡准确性和容错性** | **推荐** |
| 10MB | 容错性强 | 可能将不同文件判断为相同 |

## 特殊情况处理

### 情况1: 评分相同但大小差异巨大

```
旧文件: 1080p WEB-DL, 800MB (高压缩)
新文件: 1080p WEB-DL, 3GB (低压缩)

决策: 保留新文件（更大 = 更高码率 = 更好质量）
```

### 情况2: 评分相同且大小相同

```
旧文件: 1080p WEB-DL, 1.5GB
新文件: 1080p WEB-DL, 1.5GB

决策: 保留旧文件（避免重复操作）
```

### 情况3: 无法识别质量信息

```
旧文件: 异世界默示录麦诺格拉 - S01E01.mkv (无质量标识)
新文件: Apocalypse Bringer Mynoghra.S01E01.mkv (无质量标识)

比较过程:
├── 质量评分: 新文件=0分, 旧文件=0分
├── 文件大小: 新文件=1.5GB, 旧文件=1.5GB
├── 大小差异: 0MB < 1MB阈值
└── 判断: 文件质量和大小基本相同

决策: 保留旧文件（无法判断，保守处理）
```

## 日志示例

### 完全相同的文件

```
⚠️  文件冲突: /vol02/电视剧/日番/异世界默示录麦诺格拉 (2025)/Season 1/异世界默示录麦诺格拉 - S01E01.mkv
  策略: 自动比较质量
    质量评分: 新文件=1140分, 旧文件=1140分
    文件大小: 新文件=1500.0MB, 旧文件=1500.0MB
    判断: 文件质量和大小基本相同（差异<1MB）
  ✓ 决策: 文件质量和大小基本相同，保留旧文件（避免重复操作）

日志显示:
⏭️ 跳过：Apocalypse Bringer Mynoghra.S01E01.mkv
  文件质量和大小基本相同，已保留旧文件
```

### 新文件更好

```
⚠️  文件冲突: /vol02/电视剧/日番/异世界默示录麦诺格拉 (2025)/Season 1/异世界默示录麦诺格拉 - S01E01.mkv
  策略: 自动比较质量
    质量评分: 新文件=1160分, 旧文件=760分
    判断: 新文件质量更好
  ✓ 决策: 新文件质量更好，替换旧文件

日志显示:
✓ Apocalypse Bringer Mynoghra.S01E01.mkv
  → 异世界默示录麦诺格拉 - S01E01.mkv
  📁 日番
```

### 旧文件更好

```
⚠️  文件冲突: /vol02/电视剧/日番/异世界默示录麦诺格拉 (2025)/Season 1/异世界默示录麦诺格拉 - S01E01.mkv
  策略: 自动比较质量
    质量评分: 新文件=760分, 旧文件=1160分
    判断: 旧文件质量更好
  ✓ 决策: 旧文件质量更好，保留旧文件

日志显示:
⏭️ 跳过：Apocalypse Bringer Mynoghra.S01E01.mkv
  旧文件质量更好，已保留旧文件
```

## 总结

当新旧文件质量完全相同时：

1. ✅ **保留旧文件** - 避免不必要的操作
2. ⏭️ **跳过新文件** - 不进行移动和删除
3. 📝 **记录日志** - 清楚说明跳过原因
4. 🚀 **继续处理** - 不影响其他文件的处理

这种策略：
- ✅ 安全可靠
- ✅ 节省资源
- ✅ 避免重复操作
- ✅ 保护已整理的文件
