# 自动清理功能说明

## 功能概述

处理完成后，系统会自动清理待整理目录中的冗余文件和空文件夹，释放磁盘空间。

## 清理对象

### 1. 跳过的文件

以下情况的文件会被自动清理：

#### 情况1: 质量相同的文件
```
场景: 目标文件夹已有相同质量的文件

待整理目录:
/vol02/待整理/Apocalypse Bringer Mynoghra.S01E01.1080p.WEB-DL.mkv

目标目录:
/vol02/电视剧/日番/异世界默示录麦诺格拉 (2025)/Season 1/异世界默示录麦诺格拉 - S01E01.mkv
(1080p WEB-DL, 1.5GB)

处理结果:
⏭️ 跳过: 文件质量和大小基本相同
🧹 清理: 删除待整理目录中的文件
```

#### 情况2: 质量较差的文件
```
场景: 目标文件夹已有更高质量的文件

待整理目录:
/vol02/待整理/Apocalypse Bringer Mynoghra.S01E01.720p.WEBRip.mkv

目标目录:
/vol02/电视剧/日番/异世界默示录麦诺格拉 (2025)/Season 1/异世界默示录麦诺格拉 - S01E01.mkv
(1080p BluRay, 2GB)

处理结果:
⏭️ 跳过: 旧文件质量更好
🧹 清理: 删除待整理目录中的低质量文件
```

### 2. 空文件夹

处理完成后，系统会递归检查并删除空文件夹：

```
处理前:
/vol02/待整理/
├── Apocalypse Bringer Mynoghra/
│   ├── Season 1/
│   │   ├── S01E01.mkv (已移动)
│   │   └── S01E02.mkv (已移动)
│   └── extras/
│       └── sample.mkv (已删除)
└── Other Show/
    └── S01E01.mkv (已移动)

处理后:
/vol02/待整理/
(所有文件夹都被清理)
```

## 清理流程

```
步骤1: 处理所有文件
├── 成功移动的文件 → 从待整理目录移走
├── 低质量版本 → 直接删除
└── 跳过的文件 → 记录路径

步骤2: 清理跳过的文件
├── 遍历记录的文件路径
├── 逐个删除文件
└── 记录清理日志

步骤3: 清理空文件夹
├── 从底层开始遍历
├── 检查文件夹是否为空
├── 删除空文件夹
└── 递归向上清理
```

## 实际案例

### 案例1: 完整清理流程

**初始状态：**
```
/vol02/待整理/
├── Apocalypse Bringer Mynoghra/
│   ├── S01E01.1080p.WEB-DL.mkv (1.5GB)
│   ├── S01E01.720p.WEBRip.mkv (800MB)
│   ├── S01E02.1080p.WEB-DL.mkv (1.5GB)
│   └── sample.txt (不支持的文件)
└── Other Show/
    └── S01E01.mkv
```

**处理过程：**

1. **扫描阶段**
   ```
   ✓ 找到 4 个媒体文件
   ✓ 自动删除 1 个不支持的文件 (sample.txt)
   ```

2. **去重阶段**
   ```
   ✓ S01E01: 保留 1080p WEB-DL
   ❌ S01E01: 删除 720p WEBRip (低质量)
   ```

3. **重命名阶段**
   ```
   ✓ S01E01.1080p.WEB-DL.mkv → 移动到目标目录
   ✓ S01E02.1080p.WEB-DL.mkv → 移动到目标目录
   ✓ Other Show S01E01.mkv → 移动到目标目录
   ```

4. **清理阶段**
   ```
   🧹 清理 0 个跳过的文件
   📁 清理 2 个空文件夹:
      - Apocalypse Bringer Mynoghra/
      - Other Show/
   ```

**最终状态：**
```
/vol02/待整理/
(空目录)

/vol02/电视剧/日番/
├── 异世界默示录麦诺格拉 (2025)/
│   └── Season 1/
│       ├── 异世界默示录麦诺格拉 - S01E01.mkv
│       └── 异世界默示录麦诺格拉 - S01E02.mkv
└── Other Show (2024)/
    └── Season 1/
        └── Other Show - S01E01.mkv
```

### 案例2: 增量更新场景

**初始状态：**
```
目标目录已有:
/vol02/电视剧/日番/异世界默示录麦诺格拉 (2025)/Season 1/
├── 异世界默示录麦诺格拉 - S01E01.mkv (1080p WEB-DL, 1.5GB)
└── 异世界默示录麦诺格拉 - S01E02.mkv (1080p WEB-DL, 1.5GB)

待整理目录:
/vol02/待整理/New Episodes/
├── Apocalypse Bringer Mynoghra.S01E01.1080p.WEB-DL.mkv (1.5GB, 重复)
├── Apocalypse Bringer Mynoghra.S01E02.1080p.WEB-DL.mkv (1.5GB, 重复)
└── Apocalypse Bringer Mynoghra.S01E03.1080p.WEB-DL.mkv (1.5GB, 新集)
```

**处理过程：**

使用"自动比较"策略：

1. **S01E01 处理**
   ```
   ⚠️  文件冲突
   质量评分: 新=1140分, 旧=1140分
   文件大小: 新=1.5GB, 旧=1.5GB
   判断: 文件质量和大小基本相同
   ⏭️ 跳过: 保留旧文件
   📝 记录: 待清理
   ```

2. **S01E02 处理**
   ```
   ⚠️  文件冲突
   质量评分: 新=1140分, 旧=1140分
   文件大小: 新=1.5GB, 旧=1.5GB
   判断: 文件质量和大小基本相同
   ⏭️ 跳过: 保留旧文件
   📝 记录: 待清理
   ```

3. **S01E03 处理**
   ```
   ✓ 无冲突
   ✓ 移动到目标目录
   ```

4. **清理阶段**
   ```
   🧹 清理 2 个跳过的文件:
      - Apocalypse Bringer Mynoghra.S01E01.1080p.WEB-DL.mkv
      - Apocalypse Bringer Mynoghra.S01E02.1080p.WEB-DL.mkv
   📁 清理 1 个空文件夹:
      - New Episodes/
   ```

**最终状态：**
```
/vol02/待整理/
(空目录)

/vol02/电视剧/日番/异世界默示录麦诺格拉 (2025)/Season 1/
├── 异世界默示录麦诺格拉 - S01E01.mkv (保留原文件)
├── 异世界默示录麦诺格拉 - S01E02.mkv (保留原文件)
└── 异世界默示录麦诺格拉 - S01E03.mkv (新增)

释放空间: 约 3GB (删除了2个重复文件)
```

## 日志显示

### 完整日志示例

```
处理完成：删除 1 个低清晰度版本，重命名 3 个文件，清理 2 个跳过的文件，清理 2 个空文件夹

📋 重命名日志:

❌ 删除：Apocalypse Bringer Mynoghra.S01E01.720p.WEBRip.mkv
   低清晰度版本（720p WEBRip），保留 1080p WEB-DL

✓ Apocalypse Bringer Mynoghra.S01E01.1080p.WEB-DL.mkv
  → 异世界默示录麦诺格拉 - S01E01.mkv
  📁 日番

⏭️ 跳过：Apocalypse Bringer Mynoghra.S01E02.1080p.WEB-DL.mkv
  文件质量和大小基本相同，已保留旧文件

✓ Apocalypse Bringer Mynoghra.S01E03.1080p.WEB-DL.mkv
  → 异世界默示录麦诺格拉 - S01E03.mkv
  📁 日番

🧹 清理：Apocalypse Bringer Mynoghra.S01E02.1080p.WEB-DL.mkv
   质量相同或较差，已清理

📁 清理文件夹：Apocalypse Bringer Mynoghra/
   空文件夹，已清理

📁 清理文件夹：待整理/
   空文件夹，已清理
```

## 优势

### 1. 自动化
- ✅ 无需手动清理
- ✅ 处理完成后自动执行
- ✅ 一键完成所有操作

### 2. 空间释放
- ✅ 删除重复文件
- ✅ 删除低质量文件
- ✅ 清理空文件夹
- ✅ 最大化释放磁盘空间

### 3. 目录整洁
- ✅ 待整理目录保持干净
- ✅ 避免文件堆积
- ✅ 便于下次整理

### 4. 安全可靠
- ✅ 只清理跳过的文件
- ✅ 不会误删重要文件
- ✅ 详细的清理日志

## 注意事项

### 1. 清理时机
- 清理在所有文件处理完成后执行
- 确保文件已成功移动到目标位置
- 网盘操作有延迟，系统会等待同步

### 2. 清理范围
- 只清理待整理目录（basePath）
- 不会清理目标输出目录
- 不会清理待整理目录本身

### 3. 空文件夹判断
- 完全空的文件夹才会被删除
- 包含隐藏文件的文件夹不会被删除
- 从底层向上递归清理

### 4. 错误处理
- 清理失败不影响主流程
- 错误会记录在日志中
- 可以手动重新清理

## 配置建议

### 推荐配置（自动清理）
```
冲突策略: 🤖 自动比较
优点: 
- 自动保留最佳质量
- 自动清理低质量和重复文件
- 最大化释放空间
```

### 保守配置（手动清理）
```
冲突策略: ⏭️ 跳过
优点:
- 不会删除任何文件
- 可以手动检查后再清理
- 更加安全
```

## 总结

自动清理功能确保：
1. ✅ 待整理目录保持干净
2. ✅ 最大化释放磁盘空间
3. ✅ 避免重复文件堆积
4. ✅ 自动化程度更高
5. ✅ 详细的操作日志

这个功能特别适合：
- 定期整理大量媒体文件
- 网盘空间有限的用户
- 需要保持目录整洁的场景
- 自动化批量处理任务
