# 📚 媒体库文件管理器 V1.3 - 功能总览

## 🎯 核心定位

一键完成媒体文件的**扫描 → 识别 → 分类 → 重命名 → 入库 → 清理**全流程，让媒体库管理变得简单高效。

---

## 🚀 一键整理入库

点击"一键整理入库"按钮，系统自动完成：

```
1. 📂 扫描待整理目录
   └── 递归扫描所有子文件夹
   └── 识别媒体和字幕文件
   └── 自动删除不支持的文件

2. 🌐 查询中文标题
   └── 优先豆瓣查询（完整标题）
   └── 失败后TMDB查询
   └── 支持长标题智能缩短

3. 📁 智能分类
   └── 基于TMDB元数据
   └── 电影：动画/华语/外语
   └── 电视剧：国漫/日番/欧美剧等

4. 🎯 智能去重
   └── 同一影片多个版本
   └── 自动保留最高质量
   └── 删除低质量版本

5. ⚔️ 冲突处理
   └── 检测同名文件
   └── 根据策略处理
   └── 自动比较质量

6. 📝 标准化重命名
   └── 符合媒体服务器规范
   └── 包含完整元数据
   └── 自动创建目录结构

7. 🚚 移动到目标位置
   └── 电影 → 电影输出路径/分类/
   └── 电视剧 → 电视剧输出路径/分类/
   └── 自动创建分类目录

8. 🧹 自动清理
   └── 删除跳过的文件
   └── 清理空文件夹
   └── 释放磁盘空间
```

---

## 📁 智能分类系统

### 电影分类

| 分类 | 匹配规则 | 示例 |
|------|----------|------|
| **动画电影** | genre_ids=16 | 铃芽之旅、你的名字 |
| **华语电影** | language=zh/cn | 满江红、流浪地球 |
| **外语电影** | 其他 | 复仇者联盟、泰坦尼克号 |

### 电视剧分类

| 分类 | 匹配规则 | 示例 |
|------|----------|------|
| **国漫** | 动画+中国 | 完美世界、斗罗大陆 |
| **日番** | 动画+日本 | 异世界默示录麦诺格拉 |
| **纪录片** | genre_ids=99 | 蓝色星球、舌尖上的中国 |
| **儿童** | genre_ids=10762 | 小猪佩奇、汪汪队 |
| **综艺** | genre_ids=10764/10767 | 向往的生活、奔跑吧 |
| **国产剧** | origin_country=CN/TW/HK | 庆余年、甄嬛传 |
| **欧美剧** | origin_country=US/GB等 | 权力的游戏、老友记 |
| **日韩剧** | origin_country=JP/KR等 | 半泽直树、鱿鱼游戏 |
| **未分类** | 其他 | 无法识别的剧集 |

---

## ⚔️ 文件冲突处理

### 4种处理策略

#### 🤖 自动比较（推荐）

**智能评分系统：**
```
分辨率评分:
├── 4K = 2160分
├── 1080p = 1080分
├── 720p = 720分
└── 480p = 480分

来源质量评分:
├── REMUX = 100分
├── BluRay = 80分
├── WEB-DL = 60分
├── WEBRip = 40分
└── HDRip = 20分

编码格式评分:
├── H.265/HEVC = +10分
└── H.264 = 0分

文件大小:
└── 评分相同时，文件越大越好
```

**决策逻辑：**
- 新文件评分更高 → 替换旧文件
- 旧文件评分更高 → 保留旧文件
- 评分相同且大小差异<1MB → 保留旧文件（视为相同）
- 评分相同但大小差异>1MB → 保留更大的文件

#### ⏭️ 跳过
- 保留旧文件
- 不处理新文件
- 适合已整理好的库

#### 🔄 替换
- 直接用新文件替换旧文件
- 不进行质量比较
- 适合确定新文件更好

#### 📦 保留两个
- 保留旧文件
- 新文件添加版本号（.v1, .v2...）
- 适合多版本对比

---

## 🧹 自动清理功能

### 清理对象

1. **跳过的文件**
   - 质量相同的文件
   - 质量较差的文件
   - 自动删除，释放空间

2. **空文件夹**
   - 递归检查所有文件夹
   - 从底层向上清理
   - 保持目录整洁

### 清理流程

```
处理完成后自动执行:

1. 遍历跳过的文件列表
   └── 逐个删除文件
   └── 记录清理日志

2. 扫描待整理目录
   └── 从底层开始遍历
   └── 检查文件夹是否为空
   └── 删除空文件夹

3. 显示清理结果
   └── 清理了多少文件
   └── 清理了多少文件夹
   └── 释放了多少空间
```

---

## 🌐 中文标题识别

### 双引擎查询

```
优先级: 豆瓣 > TMDB

豆瓣查询:
├── 完整标题查询
├── 清理标题查询
├── 渐进式缩短（80% → 60% → 40%）
└── 关键词查询（前3词）

TMDB查询:
├── 完整标题查询
├── 不带年份查询
├── 渐进式缩短（70% → 50% → 30%）
└── 返回中文标题和元数据

查询缓存:
└── 相同标题不重复查询
```

### 支持的标题格式

```
✓ 超长英文标题
  Apocalypse Bringer Mynoghra World Conquest Starts with the Civilization of Ruin
  → 异世界默示录麦诺格拉～从毁灭文明开始征服世界～

✓ 带年份的标题
  The Last of Us (2023)
  → 最后生还者 (2023)

✓ 复杂格式
  [2024][Full River Red][1080p]
  → 满江红 (2024)
```

---

## 📝 标准化命名

### 电影命名格式

```
标题 (年份)/标题 (年份) - 分辨率.语言.扩展名

示例:
铃芽之旅 (2022)/铃芽之旅 (2022) - 1080p.chs.mkv
满江红 (2023)/满江红 (2023) - 4K.mkv
```

### 电视剧命名格式

```
标题 (年份)/Season X/标题 - S0XE0X - 第 X 集.语言.扩展名

示例:
异世界默示录麦诺格拉 (2025)/Season 1/异世界默示录麦诺格拉 - S01E01 - 第 01 集.mkv
庆余年 (2019)/Season 2/庆余年 - S02E01 - 第 01 集.chs.mkv
```

---

## 🎯 智能去重

### 去重逻辑

```
1. 识别同一影片的多个版本
   └── 相同标题 + 年份 + 季集

2. 计算每个版本的质量评分
   └── 分辨率 + 来源 + 编码 + 大小

3. 保留评分最高的版本
   └── 其他版本标记为删除

4. 显示去重信息
   └── 保留哪个版本
   └── 删除哪些版本
   └── 删除原因
```

### 示例

```
同一剧集的3个版本:
├── S01E01.720p.WEBRip.mkv (评分: 760)
├── S01E01.1080p.WEB-DL.mkv (评分: 1140) ✓ 保留
└── S01E01.1080p.BluRay.mkv (评分: 1160) ✓ 最佳

结果:
✓ 保留: 1080p BluRay
❌ 删除: 720p WEBRip (低清晰度)
❌ 删除: 1080p WEB-DL (来源质量较低)
```

---

## 🌐 网盘优化

### 针对115网盘挂载的优化

1. **操作间隔**
   - 删除操作间隔300ms
   - 重命名操作间隔500ms
   - 避免网盘压力过大

2. **延迟验证**
   - 操作后等待500ms
   - 验证操作是否成功
   - 处理网盘同步延迟

3. **错误处理**
   - 捕获网盘连接错误
   - 提示检查网盘挂载
   - 记录详细错误信息

---

## 📋 详细日志

### 日志类型

```
✓ 成功处理
  显示: 旧文件名 → 新文件名
  附加: 分类信息

⏭️ 跳过处理
  显示: 文件名
  原因: 为什么跳过

❌ 删除文件
  显示: 文件名
  原因: 删除原因

🧹 清理文件
  显示: 文件名
  原因: 质量相同或较差

📁 清理文件夹
  显示: 文件夹路径
  原因: 空文件夹

⚠️ 处理失败
  显示: 文件名
  原因: 错误信息
```

---

## 🎨 界面功能

### 路径配置

- 📂 **扫描路径**：待整理文件所在目录
- 🎬 **电影输出路径**：电影文件的目标位置
- 📺 **电视剧输出路径**：电视剧文件的目标位置
- 📁 **文件夹浏览器**：可视化选择路径

### 策略配置

- ⚙️ **冲突处理策略**：4种策略可选
- 💾 **自动保存**：配置自动保存到浏览器

### 操作按钮

- 🚀 **一键整理入库**：启动完整处理流程
- 📋 **查看日志**：查看详细处理日志

---

## 💡 使用建议

### 首次使用

1. 配置三个路径（扫描、电影、电视剧）
2. 选择"自动比较"策略
3. 点击"一键整理入库"
4. 查看日志确认结果

### 日常使用

1. 新文件放入待整理目录
2. 点击"一键整理入库"
3. 系统自动完成所有操作
4. 待整理目录自动清空

### 增量更新

1. 使用"跳过"策略
2. 只处理新增文件
3. 不影响已整理的文件

### 重新整理

1. 使用"替换"策略
2. 用新文件替换旧文件
3. 适合重新下载的场景

---

## 🎯 适用场景

- ✅ 大量媒体文件需要整理
- ✅ 英文片名需要转中文
- ✅ 需要自动分类管理
- ✅ 多个版本需要去重
- ✅ 网盘空间有限
- ✅ 需要符合媒体服务器规范
- ✅ 定期下载新剧集
- ✅ 使用Emby/Jellyfin/Plex

---

## 📊 处理效率

```
单次处理能力:
├── 扫描: 1000+ 文件/分钟
├── 查询: 10-20 标题/分钟（含缓存）
├── 重命名: 50-100 文件/分钟（网盘）
└── 清理: 即时完成

推荐批次:
├── 小批次: 10-50 文件
├── 中批次: 50-200 文件
└── 大批次: 200+ 文件（分批处理）
```

---

## 🔒 安全保障

- ✅ 只处理待整理目录
- ✅ 不会修改目标目录的文件
- ✅ 详细的操作日志
- ✅ 冲突文件智能处理
- ✅ 错误自动捕获和提示
- ✅ 网盘操作延迟验证

---

## 🎉 总结

**媒体库文件管理器 V1.3** 是一个功能完整、智能高效的媒体库整理工具，真正实现了"一键整理入库"的目标，让媒体库管理变得简单轻松！
