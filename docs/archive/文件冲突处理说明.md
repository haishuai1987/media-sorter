# 文件冲突处理说明

## 功能概述

当目标文件夹中已存在同名文件时，系统提供4种智能处理策略，确保数据安全和灵活性。

## 冲突处理策略

### 1. 🤖 自动比较（推荐）

**策略说明：**
- 自动比较新旧文件的质量
- 保留质量更好的版本
- 删除质量较差的版本

**比较维度：**

| 维度 | 评分规则 |
|------|----------|
| **分辨率** | 4K=2160分, 1080p=1080分, 720p=720分, 480p=480分 |
| **来源质量** | REMUX=100分, BluRay=80分, WEB-DL=60分, WEBRip=40分, HDRip=20分 |
| **编码格式** | H.265/HEVC=10分, H.264=0分 |
| **文件大小** | 评分相同时，文件越大越好 |

**示例：**

```
场景1: 新文件质量更好
旧文件: 异世界默示录麦诺格拉 - S01E01.720p.WEBRip.mkv (500MB)
新文件: 异世界默示录麦诺格拉 - S01E01.1080p.BluRay.mkv (2GB)

评分对比:
旧文件: 720 + 40 = 760分
新文件: 1080 + 80 = 1160分

结果: ✓ 删除旧文件，保留新文件（新文件质量更好）
```

```
场景2: 旧文件质量更好
旧文件: 异世界默示录麦诺格拉 - S01E01.1080p.BluRay.mkv (2GB)
新文件: 异世界默示录麦诺格拉 - S01E01.720p.WEBRip.mkv (500MB)

评分对比:
旧文件: 1080 + 80 = 1160分
新文件: 720 + 40 = 760分

结果: ✓ 保留旧文件，跳过新文件（旧文件质量更好）
```

```
场景3: 评分相同，比较文件大小
旧文件: 异世界默示录麦诺格拉 - S01E01.1080p.WEB-DL.mkv (1.5GB)
新文件: 异世界默示录麦诺格拉 - S01E01.1080p.WEB-DL.mkv (2GB)

评分对比:
旧文件: 1080 + 60 = 1140分
新文件: 1080 + 60 = 1140分

文件大小: 2GB > 1.5GB

结果: ✓ 删除旧文件，保留新文件（文件更大）
```

### 2. ⏭️ 跳过

**策略说明：**
- 保留旧文件
- 不处理新文件
- 适合已经整理好的文件

**使用场景：**
- 目标文件夹已经整理完毕
- 不想覆盖现有文件
- 只想处理新增的文件

**示例：**
```
旧文件: /vol02/电视剧/日番/异世界默示录麦诺格拉 (2025)/Season 1/异世界默示录麦诺格拉 - S01E01.mkv
新文件: /vol02/待整理/Apocalypse Bringer Mynoghra.S01E01.mkv

结果: ⏭️ 跳过处理，保留旧文件
日志: "目标文件已存在，已跳过"
```

### 3. 🔄 替换

**策略说明：**
- 直接用新文件替换旧文件
- 不进行质量比较
- 适合确定新文件更好的情况

**使用场景：**
- 重新下载了更好的版本
- 旧文件有问题需要替换
- 确定新文件是正确的

**示例：**
```
旧文件: 异世界默示录麦诺格拉 - S01E01.mkv (损坏)
新文件: Apocalypse Bringer Mynoghra.S01E01.mkv (完整)

结果: 🔄 删除旧文件，用新文件替换
```

### 4. 📦 保留两个

**策略说明：**
- 保留旧文件
- 新文件添加版本号后缀
- 两个文件都保留

**命名规则：**
```
原文件: 异世界默示录麦诺格拉 - S01E01.mkv
新文件: 异世界默示录麦诺格拉 - S01E01.v1.mkv

如果v1已存在:
新文件: 异世界默示录麦诺格拉 - S01E01.v2.mkv
```

**使用场景：**
- 不确定哪个版本更好
- 想保留多个版本对比
- 不同来源的版本（如不同字幕组）

**示例：**
```
旧文件: 异世界默示录麦诺格拉 - S01E01.mkv (字幕组A)
新文件: Apocalypse Bringer Mynoghra.S01E01.mkv (字幕组B)

结果: 📦 两个都保留
├── 异世界默示录麦诺格拉 - S01E01.mkv (旧文件)
└── 异世界默示录麦诺格拉 - S01E01.v1.mkv (新文件)
```

## 实际应用示例

### 示例1: 批量整理混合质量的文件

**场景：**
待整理文件夹中有同一部剧的多个版本，质量参差不齐

**文件列表：**
```
/vol02/待整理/
├── Apocalypse Bringer Mynoghra.S01E01.720p.WEBRip.mkv
├── Apocalypse Bringer Mynoghra.S01E01.1080p.WEB-DL.mkv
├── Apocalypse Bringer Mynoghra.S01E02.1080p.BluRay.mkv
└── Apocalypse Bringer Mynoghra.S01E03.480p.mkv
```

**选择策略：** 🤖 自动比较

**处理结果：**
```
/vol02/电视剧/日番/异世界默示录麦诺格拉 (2025)/Season 1/
├── 异世界默示录麦诺格拉 - S01E01.mkv (1080p WEB-DL, 自动选择最佳)
├── 异世界默示录麦诺格拉 - S01E02.mkv (1080p BluRay)
└── 异世界默示录麦诺格拉 - S01E03.mkv (480p)

日志:
✓ S01E01: 保留1080p WEB-DL版本（评分1140），跳过720p WEBRip（评分760）
✓ S01E02: 处理成功
✓ S01E03: 处理成功
```

### 示例2: 增量更新已整理的文件夹

**场景：**
目标文件夹已经整理好，只想添加新集数

**已有文件：**
```
/vol02/电视剧/日番/异世界默示录麦诺格拉 (2025)/Season 1/
├── 异世界默示录麦诺格拉 - S01E01.mkv
├── 异世界默示录麦诺格拉 - S01E02.mkv
└── 异世界默示录麦诺格拉 - S01E03.mkv
```

**新文件：**
```
/vol02/待整理/
├── Apocalypse Bringer Mynoghra.S01E01.mkv (重复)
├── Apocalypse Bringer Mynoghra.S01E02.mkv (重复)
└── Apocalypse Bringer Mynoghra.S01E04.mkv (新集)
```

**选择策略：** ⏭️ 跳过

**处理结果：**
```
/vol02/电视剧/日番/异世界默示录麦诺格拉 (2025)/Season 1/
├── 异世界默示录麦诺格拉 - S01E01.mkv (保留旧文件)
├── 异世界默示录麦诺格拉 - S01E02.mkv (保留旧文件)
├── 异世界默示录麦诺格拉 - S01E03.mkv
└── 异世界默示录麦诺格拉 - S01E04.mkv (新增)

日志:
⏭️ S01E01: 跳过（目标文件已存在）
⏭️ S01E02: 跳过（目标文件已存在）
✓ S01E04: 处理成功
```

### 示例3: 保留多个字幕组版本

**场景：**
想保留不同字幕组的版本进行对比

**选择策略：** 📦 保留两个

**处理结果：**
```
/vol02/电视剧/日番/异世界默示录麦诺格拉 (2025)/Season 1/
├── 异世界默示录麦诺格拉 - S01E01.mkv (字幕组A)
├── 异世界默示录麦诺格拉 - S01E01.v1.mkv (字幕组B)
└── 异世界默示录麦诺格拉 - S01E01.v2.mkv (字幕组C)

日志:
✓ S01E01 (字幕组A): 处理成功
📦 S01E01 (字幕组B): 保留两个版本，添加后缀 .v1
📦 S01E01 (字幕组C): 保留两个版本，添加后缀 .v2
```

## 推荐使用场景

| 场景 | 推荐策略 | 原因 |
|------|----------|------|
| 首次整理 | 🤖 自动比较 | 自动选择最佳质量 |
| 增量更新 | ⏭️ 跳过 | 避免覆盖已整理的文件 |
| 重新下载 | 🔄 替换 | 确定新文件更好 |
| 多版本对比 | 📦 保留两个 | 保留所有版本 |
| 混合场景 | 🤖 自动比较 | 智能处理各种情况 |

## 注意事项

1. **自动比较的局限性**
   - 只能根据文件名和大小判断
   - 无法判断字幕质量、音轨数量等
   - 建议重要文件手动检查

2. **网盘操作延迟**
   - 删除和移动操作可能有延迟
   - 系统会等待0.5秒验证操作结果
   - 如遇失败，请检查网盘连接

3. **磁盘空间**
   - "保留两个"策略会占用双倍空间
   - 建议定期清理不需要的版本

4. **日志记录**
   - 所有操作都会记录在日志中
   - 可以查看哪些文件被跳过或替换
   - 便于事后检查和恢复

## 配置建议

**保守策略（推荐新手）：**
```
策略: ⏭️ 跳过
优点: 不会覆盖任何现有文件，最安全
缺点: 需要手动处理重复文件
```

**智能策略（推荐日常使用）：**
```
策略: 🤖 自动比较
优点: 自动保留最佳质量，省时省力
缺点: 可能误判特殊情况
```

**激进策略（确定新文件更好时）：**
```
策略: 🔄 替换
优点: 快速更新所有文件
缺点: 可能覆盖好的文件
```

**收藏策略（收藏控）：**
```
策略: 📦 保留两个
优点: 保留所有版本
缺点: 占用大量空间
```
