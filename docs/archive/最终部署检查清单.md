# 最终部署检查清单

## ✅ 已完成的优化

### 1. 核心功能
- ✅ 文件名清理（跨文件系统兼容）
- ✅ 权限检查
- ✅ 网络操作重试机制
- ✅ 安全的文件操作（safe_rename, safe_remove）
- ✅ 符号链接解析
- ✅ 文件系统类型检测

### 2. 配置管理
- ✅ 用户配置文件支持（~/.media-renamer/config.json）
- ✅ 设置界面（Web UI）
- ✅ API密钥独立配置
- ✅ 代理支持（HTTP/SOCKS5）

### 3. 界面优化
- ✅ 整理详情弹窗
- ✅ 实时进度显示
- ✅ 8步进度跟踪
- ✅ 实时日志
- ✅ 完成通知
- ✅ 设置按钮

### 4. 部署支持
- ✅ 自动安装脚本（install.sh）
- ✅ Docker支持（Dockerfile + docker-compose.yml）
- ✅ systemd服务支持
- ✅ NAS系统部署指南

### 5. 文档
- ✅ Linux/NAS优化方案
- ✅ NAS部署指南
- ✅ 快速开始指南
- ✅ 设置功能说明
- ✅ 更新日志

---

## 🔍 最终检查项

### 系统兼容性

#### Python版本
```bash
# 检查Python版本
python3 --version
# 需要 >= 3.6
```

#### 依赖检查
```python
# 所有依赖都是Python标准库
import os
import json
import re
import urllib.request
import time
from functools import wraps
from http.server import HTTPServer, SimpleHTTPRequestHandler
```

#### 文件系统权限
```bash
# 检查配置目录权限
ls -la ~/.media-renamer/
# 应该有读写权限

# 检查媒体目录权限
ls -la /path/to/media/
# 应该有读写权限
```

### 网络配置

#### 端口检查
```bash
# 检查端口8090是否被占用
netstat -tuln | grep 8090
# 或
ss -tuln | grep 8090
```

#### 防火墙配置
```bash
# Ubuntu/Debian
sudo ufw allow 8090

# CentOS/RHEL
sudo firewall-cmd --add-port=8090/tcp --permanent
sudo firewall-cmd --reload
```

### 配置文件

#### 默认配置位置
```
~/.media-renamer/config.json
```

#### 配置文件格式
```json
{
  "tmdb_api_key": "your-key",
  "tmdb_proxy": "http://proxy:port",
  "tmdb_proxy_type": "http",
  "douban_cookie": "your-cookie"
}
```

---

## 🚀 部署步骤

### 方法1: 自动安装（推荐）

```bash
# 1. 下载项目
git clone https://github.com/your-repo/media-renamer.git
cd media-renamer

# 2. 运行安装脚本
chmod +x install.sh
./install.sh

# 3. 配置API密钥
# 访问 http://localhost:8090
# 点击"设置"按钮配置

# 4. 启动服务
python3 app.py
```

### 方法2: Docker部署

```bash
# 1. 修改docker-compose.yml
nano docker-compose.yml
# 修改volumes路径

# 2. 启动容器
docker-compose up -d

# 3. 查看日志
docker-compose logs -f

# 4. 配置API密钥
# 访问 http://localhost:8090
# 点击"设置"按钮配置
```

### 方法3: systemd服务

```bash
# 1. 创建服务文件
sudo nano /etc/systemd/system/media-renamer.service

# 2. 添加内容（见下方）

# 3. 启用服务
sudo systemctl daemon-reload
sudo systemctl enable media-renamer
sudo systemctl start media-renamer

# 4. 检查状态
sudo systemctl status media-renamer
```

#### systemd服务文件
```ini
[Unit]
Description=Media Renamer Service
After=network.target

[Service]
Type=simple
User=your-user
WorkingDirectory=/path/to/media-renamer
ExecStart=/usr/bin/python3 /path/to/media-renamer/app.py
Restart=on-failure
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

---

## 🧪 测试清单

### 基础功能测试

#### 1. 启动测试
```bash
# 启动服务
python3 app.py

# 检查输出
# 应该显示:
# 🎬 媒体库文件管理器 V1.3
# 服务器运行在: http://localhost:8090
```

#### 2. 访问测试
```bash
# 测试Web访问
curl http://localhost:8090

# 应该返回HTML内容
```

#### 3. API测试
```bash
# 测试设置API
curl -X POST http://localhost:8090/api/get-settings \
  -H "Content-Type: application/json" \
  -d '{}'

# 应该返回JSON配置
```

### 文件操作测试

#### 1. 权限测试
```bash
# 创建测试目录
mkdir -p ~/test-media/待整理
mkdir -p ~/test-media/电影
mkdir -p ~/test-media/剧集

# 创建测试文件
touch ~/test-media/待整理/test.mp4

# 检查权限
ls -la ~/test-media/
```

#### 2. 扫描测试
- 在Web界面配置路径
- 点击扫描
- 检查是否能找到文件

#### 3. 重命名测试
- 使用少量测试文件
- 执行重命名
- 检查结果

### 网络文件系统测试

#### NFS测试
```bash
# 挂载NFS
sudo mount -t nfs server:/export /mnt/nfs

# 测试读写
touch /mnt/nfs/test.txt
rm /mnt/nfs/test.txt
```

#### SMB/CIFS测试
```bash
# 挂载SMB
sudo mount -t cifs //server/share /mnt/smb \
  -o username=user,password=pass

# 测试读写
touch /mnt/smb/test.txt
rm /mnt/smb/test.txt
```

---

## 🔧 常见问题修复

### 问题1: 权限错误

```bash
# 修改所有者
sudo chown -R $USER:$USER /path/to/media

# 修改权限
sudo chmod -R 755 /path/to/media

# 检查SELinux（CentOS/RHEL）
sudo setenforce 0  # 临时禁用
sudo getenforce    # 检查状态
```

### 问题2: 端口被占用

```bash
# 查找占用进程
sudo lsof -i :8090
# 或
sudo netstat -tulpn | grep 8090

# 修改端口
# 编辑 app.py
PORT = 8091  # 改为其他端口
```

### 问题3: Python版本过低

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install python3.9

# CentOS/RHEL
sudo yum install python39

# 使用指定版本
python3.9 app.py
```

### 问题4: 配置文件权限

```bash
# 检查配置目录
ls -la ~/.media-renamer/

# 修复权限
chmod 755 ~/.media-renamer
chmod 644 ~/.media-renamer/config.json
```

### 问题5: 网络超时

```python
# 编辑 app.py
NETWORK_RETRY_COUNT = 5  # 增加重试次数
NETWORK_RETRY_DELAY = 3  # 增加延迟
NETWORK_OP_DELAY = 2.0   # 增加操作延迟
```

---

## 📊 性能优化建议

### 1. 批量处理
- 每次处理50-100个文件
- 大文件（>10GB）单独处理
- 避免同时处理过多文件

### 2. 网络优化
- 使用有线连接
- 避免WiFi连接处理大文件
- 考虑使用本地缓存

### 3. 系统优化
```bash
# 增加文件描述符限制
ulimit -n 4096

# 检查磁盘IO
iostat -x 1

# 检查网络
iftop
```

### 4. NAS优化
- 启用SSD缓存（如支持）
- 使用快照功能备份
- 定期清理日志

---

## 🔒 安全建议

### 1. 网络安全
```bash
# 仅允许局域网访问
sudo ufw allow from 192.168.1.0/24 to any port 8090

# 或使用iptables
sudo iptables -A INPUT -s 192.168.1.0/24 -p tcp --dport 8090 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 8090 -j DROP
```

### 2. 文件权限
```bash
# 限制配置文件权限
chmod 600 ~/.media-renamer/config.json

# 限制应用目录权限
chmod 750 /path/to/media-renamer
```

### 3. 反向代理（可选）
```nginx
# Nginx配置
server {
    listen 80;
    server_name media.example.com;
    
    location / {
        proxy_pass http://localhost:8090;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        
        # 基础认证
        auth_basic "Restricted";
        auth_basic_user_file /etc/nginx/.htpasswd;
    }
}
```

---

## 📝 维护建议

### 日常维护

#### 1. 日志检查
```bash
# systemd服务日志
sudo journalctl -u media-renamer -f

# 直接运行日志
# 查看终端输出
```

#### 2. 配置备份
```bash
# 备份配置
cp ~/.media-renamer/config.json ~/config.backup.json

# 定期备份
crontab -e
# 添加: 0 0 * * 0 cp ~/.media-renamer/config.json ~/backups/config-$(date +\%Y\%m\%d).json
```

#### 3. 更新检查
```bash
# 检查更新
git pull

# 重启服务
sudo systemctl restart media-renamer
```

### 定期任务

#### 1. 清理日志
```bash
# 清理旧日志
sudo journalctl --vacuum-time=7d
```

#### 2. 检查磁盘空间
```bash
# 检查空间
df -h

# 清理缓存
sudo apt clean  # Ubuntu/Debian
sudo yum clean all  # CentOS/RHEL
```

#### 3. 更新Cookie
- 每月更新豆瓣Cookie
- 检查TMDB API Key状态

---

## ✅ 部署完成检查

部署完成后，确认以下项目：

- [ ] Python 3.6+ 已安装
- [ ] 服务正常启动
- [ ] Web界面可访问
- [ ] API密钥已配置
- [ ] 路径权限正确
- [ ] 测试文件处理成功
- [ ] 日志正常输出
- [ ] 防火墙已配置
- [ ] 备份策略已设置
- [ ] 文档已阅读

---

## 🎉 部署成功

恭喜！系统已成功部署并优化完成。

现在你可以：
1. 访问 http://your-ip:8090
2. 配置API密钥
3. 开始整理媒体库

享受自动化的媒体管理体验！
