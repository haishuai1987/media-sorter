# äºŒç»´ç ç™»å½•ä¼˜åŒ–å®ç°æ€»ç»“

## å·²å®Œæˆçš„å·¥ä½œ

### âœ… åç«¯APIå®ç°ï¼ˆå·²å®Œæˆï¼‰

åœ¨ `app.py` ä¸­æ·»åŠ äº†ä¸‰ä¸ªæ–°çš„APIç«¯ç‚¹ï¼š

1. **`/api/qrcode/start`** - å¼€å§‹äºŒç»´ç ç™»å½•
   - è·å–115çš„Token
   - è¿”å›äºŒç»´ç å›¾ç‰‡URLï¼ˆç›´æ¥ä½¿ç”¨115çš„URLï¼Œä¸éœ€è¦qrcodeåº“ï¼‰
   - è¿”å›uidã€timeã€signç­‰å‚æ•°ä¾›åç»­ä½¿ç”¨

2. **`/api/qrcode/check`** - æ£€æŸ¥æ‰«ç çŠ¶æ€
   - è½®è¯¢æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ‰«ç 
   - è¿”å›çŠ¶æ€ç ï¼š0(ç­‰å¾…)ã€1(å·²æ‰«ç )ã€2(æˆåŠŸ)ã€-1(è¿‡æœŸ)ã€-2(å–æ¶ˆ)

3. **`/api/qrcode/finish`** - å®Œæˆç™»å½•è·å–Cookie
   - POSTè¯·æ±‚è·å–Cookie
   - è‡ªåŠ¨ä¿å­˜Cookieåˆ°é…ç½®æ–‡ä»¶
   - è¿”å›Cookieç»™å‰ç«¯

### æ ¸å¿ƒä¼˜åŠ¿

1. âœ… **ä¸éœ€è¦qrcodeåº“** - ç›´æ¥ä½¿ç”¨115å®˜æ–¹äºŒç»´ç å›¾ç‰‡URL
2. âœ… **ä¸é˜»å¡åç«¯** - åªè¿”å›URLï¼Œä¸ç”Ÿæˆå›¾ç‰‡
3. âœ… **å¼‚æ­¥è½®è¯¢** - å‰ç«¯å®šæ—¶æ£€æŸ¥ï¼Œä¸é˜»å¡UI

## å‰ç«¯å®ç°ï¼ˆå¾…å®Œæˆï¼‰

### éœ€è¦æ·»åŠ çš„å†…å®¹

#### 1. HTMLç»“æ„

åœ¨è®¾ç½®é¡µé¢æˆ–ç™»å½•é¡µé¢æ·»åŠ ï¼š

```html
<!-- äºŒç»´ç ç™»å½•æŒ‰é’® -->
<button onclick="startQRCodeLogin()" class="btn btn-primary">
  ğŸ“± æ‰«ç ç™»å½•115ç½‘ç›˜
</button>

<!-- äºŒç»´ç å¼¹çª— -->
<div id="qrcode-modal" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="close" onclick="closeQRCodeModal()">&times;</span>
    <h2>æ‰«ç ç™»å½•115ç½‘ç›˜</h2>
    
    <!-- ç›´æ¥æ˜¾ç¤º115çš„äºŒç»´ç å›¾ç‰‡ -->
    <img id="qrcode-image" src="" alt="äºŒç»´ç " style="width: 300px; height: 300px; display: none;">
    
    <p id="qrcode-status" class="status-waiting">æ­£åœ¨åŠ è½½...</p>
    
    <div class="tips">
      <p>ğŸ’¡ æç¤ºï¼š</p>
      <ul>
        <li>è¯·ä½¿ç”¨115æ‰‹æœºå®¢æˆ·ç«¯æ‰«æäºŒç»´ç </li>
        <li>äºŒç»´ç æœ‰æ•ˆæœŸ60ç§’</li>
        <li>æ‰«ç åè¯·åœ¨æ‰‹æœºä¸Šç¡®è®¤ç™»å½•</li>
      </ul>
    </div>
  </div>
</div>
```

#### 2. JavaScriptä»£ç 

```javascript
// å¼€å§‹äºŒç»´ç ç™»å½•
async function startQRCodeLogin() {
  try {
    const response = await fetch('/api/qrcode/start', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({app: 'wechatmini'})
    });
    
    const data = await response.json();
    
    if (data.success) {
      // æ˜¾ç¤ºäºŒç»´ç 
      const modal = document.getElementById('qrcode-modal');
      const img = document.getElementById('qrcode-image');
      const status = document.getElementById('qrcode-status');
      
      img.src = data.qr_url;  // ç›´æ¥æ˜¾ç¤º115çš„å›¾ç‰‡
      img.style.display = 'block';
      status.textContent = 'è¯·ä½¿ç”¨115æ‰‹æœºå®¢æˆ·ç«¯æ‰«æäºŒç»´ç ';
      modal.style.display = 'block';
      
      // å¼€å§‹è½®è¯¢
      startPolling(data);
    } else {
      alert('ç”ŸæˆäºŒç»´ç å¤±è´¥: ' + data.error);
    }
  } catch (error) {
    alert('è¯·æ±‚å¤±è´¥: ' + error.message);
  }
}

// è½®è¯¢æ£€æŸ¥çŠ¶æ€
function startPolling(tokenData) {
  let attempts = 0;
  const maxAttempts = 30; // 60ç§’è¶…æ—¶
  
  const pollInterval = setInterval(async () => {
    attempts++;
    
    if (attempts > maxAttempts) {
      clearInterval(pollInterval);
      document.getElementById('qrcode-status').textContent = 'äºŒç»´ç å·²è¿‡æœŸï¼Œè¯·é‡æ–°è·å–';
      return;
    }
    
    try {
      const response = await fetch('/api/qrcode/check', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          uid: tokenData.uid,
          time: tokenData.time,
          sign: tokenData.sign
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        const status = data.status;
        const statusEl = document.getElementById('qrcode-status');
        
        if (status === 0) {
          statusEl.textContent = 'ç­‰å¾…æ‰«ç ...';
        } else if (status === 1) {
          statusEl.textContent = 'å·²æ‰«ç ï¼Œè¯·åœ¨æ‰‹æœºä¸Šç¡®è®¤';
        } else if (status === 2) {
          // æ‰«ç æˆåŠŸï¼
          clearInterval(pollInterval);
          statusEl.textContent = 'æ‰«ç æˆåŠŸï¼Œæ­£åœ¨è·å–Cookie...';
          
          // è·å–Cookie
          await finishLogin(tokenData);
        } else if (status === -1) {
          clearInterval(pollInterval);
          statusEl.textContent = 'äºŒç»´ç å·²è¿‡æœŸ';
        } else if (status === -2) {
          clearInterval(pollInterval);
          statusEl.textContent = 'ç”¨æˆ·å–æ¶ˆæ‰«ç ';
        }
      }
    } catch (error) {
      console.error('æ£€æŸ¥çŠ¶æ€å¤±è´¥:', error);
    }
  }, 2000); // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡
  
  window.qrcodePolling = pollInterval;
}

// å®Œæˆç™»å½•
async function finishLogin(tokenData) {
  try {
    const response = await fetch('/api/qrcode/finish', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        uid: tokenData.uid,
        app: tokenData.app
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      document.getElementById('qrcode-status').textContent = 'ç™»å½•æˆåŠŸï¼';
      
      // å»¶è¿Ÿå…³é—­å¼¹çª—å¹¶åˆ·æ–°é¡µé¢
      setTimeout(() => {
        closeQRCodeModal();
        location.reload();
      }, 1500);
    } else {
      document.getElementById('qrcode-status').textContent = 'è·å–Cookieå¤±è´¥: ' + data.error;
    }
  } catch (error) {
    document.getElementById('qrcode-status').textContent = 'è¯·æ±‚å¤±è´¥: ' + error.message;
  }
}

// å…³é—­å¼¹çª—
function closeQRCodeModal() {
  document.getElementById('qrcode-modal').style.display = 'none';
  
  // åœæ­¢è½®è¯¢
  if (window.qrcodePolling) {
    clearInterval(window.qrcodePolling);
  }
}
```

#### 3. CSSæ ·å¼

```css
/* äºŒç»´ç å¼¹çª—æ ·å¼ */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
  background-color: #fefefe;
  margin: 10% auto;
  padding: 30px;
  border-radius: 12px;
  width: 400px;
  max-width: 90%;
  text-align: center;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

.close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  line-height: 20px;
}

.close:hover {
  color: #000;
}

#qrcode-image {
  margin: 20px auto;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
}

#qrcode-status {
  margin: 20px 0;
  font-size: 16px;
  font-weight: 500;
}

.status-waiting {
  color: #666;
}

.status-scanned {
  color: #ff9800;
}

.status-success {
  color: #4caf50;
}

.status-error {
  color: #f44336;
}

.tips {
  margin-top: 20px;
  padding: 15px;
  background-color: #f5f5f5;
  border-radius: 8px;
  text-align: left;
}

.tips p {
  font-weight: 600;
  margin-bottom: 10px;
}

.tips ul {
  list-style-position: inside;
  color: #666;
}

.tips li {
  margin: 5px 0;
}
```

## æµ‹è¯•æ­¥éª¤

1. **å¯åŠ¨æœåŠ¡å™¨**
   ```bash
   python app.py
   ```

2. **æ‰“å¼€æµè§ˆå™¨**
   è®¿é—® `http://localhost:8090`

3. **ç‚¹å‡»"æ‰«ç ç™»å½•"æŒ‰é’®**
   - åº”è¯¥å¼¹å‡ºäºŒç»´ç å¼¹çª—
   - æ˜¾ç¤º115çš„äºŒç»´ç å›¾ç‰‡

4. **ä½¿ç”¨115æ‰‹æœºå®¢æˆ·ç«¯æ‰«ç **
   - çŠ¶æ€åº”è¯¥ä»"ç­‰å¾…æ‰«ç "å˜ä¸º"å·²æ‰«ç "
   - åœ¨æ‰‹æœºä¸Šç¡®è®¤åï¼ŒçŠ¶æ€å˜ä¸º"æ‰«ç æˆåŠŸ"
   - è‡ªåŠ¨è·å–Cookieå¹¶ä¿å­˜
   - é¡µé¢åˆ·æ–°

5. **éªŒè¯Cookie**
   - æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­æ˜¯å¦ä¿å­˜äº†Cookie
   - å°è¯•ä½¿ç”¨115ç½‘ç›˜åŠŸèƒ½

## ä¼˜åŠ¿æ€»ç»“

1. âœ… **ä¸éœ€è¦qrcodeåº“** - è§£å†³äº†ä¾èµ–é—®é¢˜
2. âœ… **ä¸ä¼šå¡æ­»** - å¼‚æ­¥è½®è¯¢ï¼Œä¸é˜»å¡
3. âœ… **ç”¨æˆ·ä½“éªŒå¥½** - å®æ—¶æ˜¾ç¤ºçŠ¶æ€
4. âœ… **å®ç°ç®€å•** - ä»£ç æ¸…æ™°æ˜“æ‡‚
5. âœ… **è·¨å¹³å°å…¼å®¹** - çº¯Webå®ç°

## ä¸‹ä¸€æ­¥

1. åœ¨HTMLä¸­æ·»åŠ äºŒç»´ç ç™»å½•æŒ‰é’®å’Œå¼¹çª—
2. æ·»åŠ JavaScriptä»£ç 
3. æ·»åŠ CSSæ ·å¼
4. æµ‹è¯•å®Œæ•´æµç¨‹
5. ä¼˜åŒ–ç”¨æˆ·ä½“éªŒï¼ˆåŠ è½½åŠ¨ç”»ã€é”™è¯¯æç¤ºç­‰ï¼‰

---

**çŠ¶æ€ï¼š** åç«¯å·²å®Œæˆ âœ… | å‰ç«¯å¾…å®ç° â³
