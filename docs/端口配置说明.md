# 端口配置说明

## 默认端口

### 本地/NAS 部署：8090

**原因**：
- 8000 端口是很多 NAS 系统的默认端口
  - Synology DSM：8000（HTTP）、8001（HTTPS）
  - QNAP QTS：8080（HTTP）、8081（HTTPS）
  - 其他 Web 服务也常用 8000 端口
- 使用 8090 可以避免端口冲突

**访问方式**：
```
http://localhost:8090
http://192.168.x.x:8090  # 局域网
```

---

### 云服务器部署：8000

**原因**：
- 云服务器通常没有其他服务占用 8000 端口
- 配合 Nginx 反向代理使用
- 8000 是常见的应用服务端口

**访问方式**：
```
https://your-domain.com  # 通过 Nginx（推荐）
http://your-server-ip:8000  # 直接访问
```

---

## 端口对比

| 部署方式 | 默认端口 | 原因 | 访问方式 |
|---------|---------|------|---------|
| 本地开发 | 8090 | 避免与 NAS 冲突 | http://localhost:8090 |
| NAS 部署 | 8090 | 避免与 DSM 冲突 | http://nas-ip:8090 |
| 云服务器 | 8000 | 配合 Nginx | https://domain.com |
| Docker | 8090 | 统一标准 | http://localhost:8090 |

---

## 常见端口冲突

### Synology DSM

**默认端口**：
- HTTP：5000、8000
- HTTPS：5001、8001

**解决方案**：
1. 使用 8090 端口（推荐）
2. 修改 DSM 端口
3. 使用 Nginx 反向代理

---

### QNAP QTS

**默认端口**：
- HTTP：8080
- HTTPS：8081

**解决方案**：
- 使用 8090 端口（不冲突）

---

### 其他常见服务

| 服务 | 默认端口 | 冲突情况 |
|------|---------|---------|
| qBittorrent | 8080 | 不冲突 |
| Transmission | 9091 | 不冲突 |
| Plex | 32400 | 不冲突 |
| Emby | 8096 | 不冲突 |
| Jellyfin | 8096 | 不冲突 |
| Portainer | 9000 | 不冲突 |

---

## 修改端口

### 方法 1：环境变量（推荐）

```bash
# 临时修改
export PORT=8091
python3 app.py

# 永久修改（添加到 ~/.bashrc）
echo 'export PORT=8091' >> ~/.bashrc
source ~/.bashrc
```

---

### 方法 2：.env 文件

创建 `.env` 文件：

```bash
# 本地开发
PORT=8090

# 云服务器
PORT=8000

# 自定义端口
PORT=8091
```

---

### 方法 3：Systemd 服务

编辑服务文件：

```ini
[Service]
Environment="PORT=8091"
ExecStart=/usr/bin/python3 /opt/media-renamer/app.py
```

---

## 防火墙配置

### UFW（Ubuntu）

```bash
# 开放 8090 端口
sudo ufw allow 8090/tcp

# 仅允许局域网访问
sudo ufw allow from 192.168.1.0/24 to any port 8090

# 查看规则
sudo ufw status
```

---

### Firewalld（CentOS/Rocky）

```bash
# 开放 8090 端口
sudo firewall-cmd --permanent --add-port=8090/tcp
sudo firewall-cmd --reload

# 查看规则
sudo firewall-cmd --list-ports
```

---

### Synology DSM

1. 控制面板 → 安全性 → 防火墙
2. 编辑规则 → 创建
3. 端口：8090
4. 协议：TCP
5. 来源 IP：允许所有或指定 IP

---

## Nginx 反向代理

### 配置示例

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        # 本地部署
        proxy_pass http://127.0.0.1:8090;
        
        # 或云服务器
        # proxy_pass http://127.0.0.1:8000;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

---

## 端口检测

### 检查端口是否被占用

```bash
# Linux/Mac
sudo netstat -tulpn | grep 8090
sudo lsof -i :8090

# 查看进程
ps aux | grep app.py
```

### Windows

```powershell
# 检查端口
netstat -ano | findstr 8090

# 查看进程
tasklist | findstr python
```

---

## 常见问题

### Q1: 为什么本地使用 8090 而不是 8000？

**A**: 8000 端口是很多 NAS 系统（如 Synology DSM）的默认端口，使用 8090 可以避免冲突。

---

### Q2: 可以使用 80 端口吗？

**A**: 可以，但需要：
1. Root 权限运行
2. 或使用 Nginx 反向代理（推荐）

---

### Q3: 端口被占用怎么办？

**A**: 
1. 修改为其他端口（如 8091、8092）
2. 停止占用端口的服务
3. 使用 Nginx 反向代理

---

### Q4: Docker 容器使用什么端口？

**A**: 
- 容器内部：8090
- 映射到主机：可自定义（如 8090:8090）

---

### Q5: 云服务器必须使用 8000 端口吗？

**A**: 不是，可以使用任何端口。8000 只是推荐值，配合 Nginx 使用。

---

## 最佳实践

### 本地/NAS 部署

```bash
# 使用默认 8090 端口
python3 app.py

# 访问
http://localhost:8090
http://nas-ip:8090
```

**优点**：
- ✅ 避免端口冲突
- ✅ 无需额外配置
- ✅ 局域网可访问

---

### 云服务器部署

```bash
# 使用 Nginx + 8000 端口
# 内部：8000
# 外部：80/443

# 访问
https://your-domain.com
```

**优点**：
- ✅ 标准 HTTP/HTTPS 端口
- ✅ 支持 SSL 加密
- ✅ 无需记住端口
- ✅ 更专业

---

## 总结

| 场景 | 推荐端口 | 原因 |
|------|---------|------|
| 本地开发 | 8090 | 避免冲突 |
| NAS 部署 | 8090 | 避免与 DSM 冲突 |
| 云服务器 | 8000 + Nginx | 标准配置 |
| Docker | 8090 | 统一标准 |

**记住**：
- 本地/NAS：8090（避免冲突）
- 云服务器：8000 + Nginx（标准配置）
- 灵活配置：使用环境变量

有问题随时查看文档或提交 Issue！
