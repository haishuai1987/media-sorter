# 远程更新工具使用指南

## 📋 工具概述

本项目提供了一套完整的远程更新工具，可以通过 API 从本地 Windows 电脑推送更新到远程 Linux 服务器。

---

## 🛠️ 工具列表

### 1. force-push-update.ps1 ⭐ **推荐**
**自动强制更新脚本**

- **用途**：最简单、最可靠的更新方式
- **特点**：
  - 自动检测更新
  - 普通更新失败时自动尝试强制更新
  - 无需用户交互
  - 自动验证服务重启

**使用方法**：
```powershell
powershell -ExecutionPolicy Bypass -File "force-push-update.ps1"
```

---

### 2. push-update.ps1
**交互式更新脚本**

- **用途**：需要手动确认的更新方式
- **特点**：
  - 检测更新
  - 普通更新失败时询问是否强制更新
  - 需要用户确认

**使用方法**：
```powershell
powershell -ExecutionPolicy Bypass -File "push-update.ps1"
```

---

### 3. test-server.ps1
**服务器连接测试脚本**

- **用途**：测试服务器连接状态
- **特点**：
  - 测试多个可能的服务器地址
  - 显示连接状态和错误信息

**使用方法**：
```powershell
powershell -ExecutionPolicy Bypass -File "test-server.ps1"
```

---

### 4. 远程推送更新.sh
**Linux/Mac 版本更新脚本**

- **用途**：在 Linux 或 Mac 上使用
- **特点**：
  - Bash 脚本
  - 功能与 Windows 版本相同

**使用方法**：
```bash
bash 远程推送更新.sh
```

---

### 5. 远程推送更新.ps1
**Windows 完整版更新脚本**

- **用途**：功能最完整的 Windows 版本
- **特点**：
  - 彩色输出
  - 详细的状态信息
  - 完整的错误处理

**使用方法**：
```powershell
powershell -ExecutionPolicy Bypass -File "远程推送更新.ps1"
```

---

## 🚀 快速开始

### 第一次使用

1. **确认服务器地址**
   
   打开 `force-push-update.ps1`，检查第 2 行：
   ```powershell
   $SERVER_URL = "http://192.168.51.105:8090"
   ```
   
   如果服务器 IP 不同，请修改为正确的地址。

2. **执行更新**
   
   在项目根目录打开 PowerShell，执行：
   ```powershell
   powershell -ExecutionPolicy Bypass -File "force-push-update.ps1"
   ```

3. **等待完成**
   
   脚本会自动：
   - 检查服务器状态
   - 检测是否有更新
   - 执行更新（失败时自动强制更新）
   - 验证服务重启

4. **刷新浏览器**
   
   更新完成后，在浏览器中按 `Ctrl + Shift + R` 强制刷新页面。

---

## 📊 更新流程

```
开始
  ↓
检查服务器状态
  ↓
检测是否有更新
  ↓
有更新？
  ├─ 否 → 提示已是最新版本 → 结束
  └─ 是 → 尝试普通更新
           ↓
       更新成功？
           ├─ 是 → 等待服务重启 → 验证服务 → 结束
           └─ 否 → 执行强制更新
                    ↓
                强制更新成功？
                    ├─ 是 → 等待服务重启 → 验证服务 → 结束
                    └─ 否 → 报错 → 结束
```

---

## 🎯 使用场景

### 场景 1：日常更新
```powershell
# 使用推荐的自动脚本
powershell -ExecutionPolicy Bypass -File "force-push-update.ps1"
```

### 场景 2：测试服务器连接
```powershell
# 先测试连接
powershell -ExecutionPolicy Bypass -File "test-server.ps1"

# 确认连接正常后再更新
powershell -ExecutionPolicy Bypass -File "force-push-update.ps1"
```

### 场景 3：需要确认的更新
```powershell
# 使用交互式脚本
powershell -ExecutionPolicy Bypass -File "push-update.ps1"
```

---

## 🔧 配置说明

### 修改服务器地址

所有脚本都在开头定义了服务器地址：

**PowerShell 脚本**：
```powershell
$SERVER_URL = "http://192.168.51.105:8090"
```

**Bash 脚本**：
```bash
SERVER_URL="http://192.168.51.105:8090"
```

根据实际情况修改 IP 地址和端口。

---

## ⚠️ 常见问题

### 问题 1：服务器无法访问

**错误信息**：
```
[ERROR] Server is offline or unreachable
```

**解决方法**：
1. 检查服务器 IP 地址是否正确
2. 检查服务器是否在运行
3. 检查防火墙设置
4. 使用 `test-server.ps1` 测试连接

---

### 问题 2：普通更新失败

**错误信息**：
```
[WARN] Normal update failed: 远程服务器返回错误: (500) 内部服务器错误
```

**解决方法**：
- 使用 `force-push-update.ps1`，它会自动尝试强制更新
- 或者在交互式脚本中选择 `y` 执行强制更新

---

### 问题 3：服务重启后无法访问

**现象**：
```
[WARN] Service may need more time to start
```

**解决方法**：
1. 等待 30 秒后手动访问服务器
2. 检查服务器日志：`tail -f ~/media-sorter/app.log`
3. 如果服务未启动，手动启动：
   ```bash
   cd ~/media-sorter
   nohup python3 app.py > app.log 2>&1 &
   ```

---

### 问题 4：PowerShell 执行策略限制

**错误信息**：
```
无法加载文件，因为在此系统上禁止运行脚本
```

**解决方法**：
使用 `-ExecutionPolicy Bypass` 参数：
```powershell
powershell -ExecutionPolicy Bypass -File "force-push-update.ps1"
```

---

## 📝 更新后检查清单

更新完成后，请检查以下内容：

- [ ] 浏览器已强制刷新（Ctrl + Shift + R）
- [ ] 打开"设置" → "系统更新配置"
- [ ] "当前版本"正常显示（不是"获取失败"）
- [ ] 点击"检查更新"提示"已是最新版本"
- [ ] 所有功能正常工作

---

## 🎉 功能特点

### ✅ 优点

1. **简单易用**：一条命令完成更新
2. **自动化**：无需登录服务器
3. **智能重试**：失败时自动强制更新
4. **状态验证**：自动检查服务是否恢复
5. **友好提示**：清晰的进度和状态信息

### 🛡️ 安全性

- 只能更新到 GitHub 仓库的最新版本
- 强制更新会覆盖本地修改（谨慎使用）
- 需要服务器 API 访问权限

---

## 📞 技术支持

如果遇到问题：

1. 查看本文档的"常见问题"部分
2. 检查服务器日志：`tail -f ~/media-sorter/app.log`
3. 查看 GitHub Issues
4. 联系管理员

---

## 🔄 版本历史

### v1.0 (2025-10-20)
- 初始版本
- 支持自动更新和强制更新
- 支持 Windows 和 Linux/Mac
- 智能重试机制

---

## 📚 相关文档

- [智能强制更新功能说明.md](./智能强制更新功能说明.md)
- [部署智能强制更新.sh](./部署智能强制更新.sh)
- [强制更新API使用说明.md](./强制更新API使用说明.md)

---

## 💡 最佳实践

1. **日常使用**：使用 `force-push-update.ps1`
2. **首次使用**：先用 `test-server.ps1` 测试连接
3. **定期更新**：建议每周检查一次更新
4. **更新前**：确保没有正在进行的重要任务
5. **更新后**：立即刷新浏览器并验证功能

---

## 🎯 总结

这套工具让远程更新变得简单、可靠、自动化。推荐使用 `force-push-update.ps1` 进行日常更新，它会自动处理各种情况，确保更新成功。
