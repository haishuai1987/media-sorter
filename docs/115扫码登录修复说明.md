# 115网盘扫码登录修复说明

## 问题描述

之前的扫码登录实现存在以下问题：
1. ❌ 扫码后跳转生成新的二维码
2. ❌ 115手机客户端无法识别二维码
3. ❌ API返回 `key invalid` 错误
4. ❌ 无法获取到Cookie

## 根本原因

我们的实现缺少关键步骤：
- 只检查了扫码状态，但没有POST请求获取Cookie
- 二维码URL格式不正确
- 状态检查的参数不完整

## 修复方案

参考了Alist和py115项目的正确实现，完整的登录流程应该是：

### 1. 获取二维码Token
```
GET https://qrcodeapi.115.com/api/1.0/web/1.0/token/
```
返回：
```json
{
  "state": true,
  "data": {
    "uid": "xxx",
    "time": 123456,
    "sign": "xxx"
  }
}
```

### 2. 生成二维码图片
```
https://qrcodeapi.115.com/api/1.0/mac/1.0/qrcode?uid={uid}
```
注意：使用 `mac` 端点，兼容性最好

### 3. 轮询检查扫码状态
```
GET https://qrcodeapi.115.com/get/status/?uid={uid}&time={time}&sign={sign}
```
返回状态码：
- `0`: 等待扫码
- `1`: 已扫码，等待确认
- `2`: 扫码成功 ⭐
- `-1`: 二维码过期
- `-2`: 用户取消

### 4. POST获取Cookie（关键步骤！）
当状态码为 `2` 时，需要POST请求获取Cookie：
```
POST https://passportapi.115.com/app/1.0/{app}/1.0/login/qrcode/
Data: {
  "app": "wechatmini",  // 或其他app类型
  "account": "{uid}"
}
```
返回：
```json
{
  "state": true,
  "data": {
    "cookie": {
      "UID": "xxx",
      "CID": "xxx",
      "SEID": "xxx"
    }
  }
}
```

## 代码修改

### 后端修改 (app.py)

1. **generate_qrcode()** - 生成二维码
   - 使用正确的token API
   - 保存完整的token信息（uid, time, sign）
   - 使用mac端点生成二维码图片

2. **check_qrcode_status()** - 检查状态
   - 使用完整参数检查状态（uid, time, sign）
   - 当状态为2时，POST请求获取Cookie
   - 正确解析Cookie字典并组合成字符串

### 前端修改 (index.html)

1. 恢复扫码登录弹窗
2. 提供多种扫码方式选择
3. 推荐使用微信小程序（Cookie有效期更长）
4. 优化用户提示和交互体验

## 支持的扫码方式

| 方式 | 代码 | 推荐度 | 说明 |
|------|------|--------|------|
| 微信小程序 | wechatmini | ⭐⭐⭐⭐⭐ | Cookie有效期最长，推荐 |
| 支付宝小程序 | alipaymini | ⭐⭐⭐⭐ | Cookie有效期长 |
| 安卓APP | android | ⭐⭐⭐ | 常规方式 |
| iOS APP | ios | ⭐⭐⭐ | 常规方式 |
| TV版 | tv | ⭐⭐ | 适合长期使用 |
| 网页版 | web | ⭐ | Cookie容易过期 |

## 测试步骤

1. 启动服务
```bash
cd /root/media-sorter
python3 app.py
```

2. 打开Web界面，进入"115网盘整理"设置

3. 点击📱扫码登录按钮

4. 选择"微信小程序"

5. 使用115手机客户端扫码

6. 在手机上点击确认

7. 等待Cookie自动填充并验证

## 预期结果

✅ 二维码可以被115客户端正确识别  
✅ 扫码后不会跳转到新二维码  
✅ 成功获取到Cookie  
✅ Cookie自动填充到输入框  
✅ 自动验证Cookie有效性  

## 参考资料

- [py115 - 115网盘Python SDK](https://github.com/ChenyangGao/p115client)
- [Alist - 115网盘驱动实现](https://github.com/alist-org/alist)

## 技术细节

### 为什么需要POST请求？

115网盘的安全机制：
1. 扫码只是验证身份
2. 需要通过POST请求绑定设备
3. 不同的app类型会生成不同的Cookie
4. 小程序类型的Cookie有效期更长

### Cookie格式

```
UID=123456_A1B2C3D4E5; CID=ABCDEFGHIJK123456; SEID=a1b2c3d4e5f6g7h8
```

三个关键字段：
- `UID`: 用户ID
- `CID`: 客户端ID
- `SEID`: 会话ID

## 常见问题

### Q: 为什么推荐微信小程序？
A: 微信小程序的Cookie有效期通常为几个月，比APP和网页版更长。

### Q: 扫码后显示"等待确认"怎么办？
A: 在手机上点击"确认登录"按钮，不要只是扫码。

### Q: Cookie多久会过期？
A: 取决于扫码方式：
- 微信/支付宝小程序：几个月
- APP：几周
- 网页版：几天

### Q: 可以同时在多个设备登录吗？
A: 可以，但同一种app类型只能保持一个登录状态。例如，扫码"微信小程序"会踢掉之前用微信小程序登录的设备。

## 更新日志

### 2025-10-19
- ✅ 修复二维码URL格式错误
- ✅ 添加POST获取Cookie步骤
- ✅ 完善状态检查参数
- ✅ 优化前端交互体验
- ✅ 添加多种扫码方式选择
- ✅ 推荐使用微信小程序
