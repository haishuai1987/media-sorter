# Media Renamer v2.8.0 部署手册

## 📋 系统要求

### 最低要求
- **Python**: 3.7+
- **内存**: 512MB
- **磁盘**: 100MB（应用）
- **浏览器**: Chrome/Firefox/Safari/Edge（现代浏览器）

### 推荐配置
- **Python**: 3.9+
- **内存**: 1GB+
- **磁盘**: 500MB+
- **CPU**: 2核+

---

## 🚀 快速部署

### 方法1：本地部署（推荐）

```bash
# 1. 克隆仓库
git clone https://github.com/haishuai1987/media-sorter.git
cd media-sorter

# 2. 安装依赖
pip install -r requirements.txt
pip install -r requirements-v2.8.0.txt

# 3. 启动应用
python app_v2.py

# 4. 访问应用
# 浏览器打开: http://localhost:8090
```

### 方法2：Docker 部署

```bash
# 使用 Docker Compose
docker-compose up -d

# 访问应用
# 浏览器打开: http://localhost:8090
```

---

## 🐳 Docker 部署

### 使用 Docker Compose（推荐）

#### 1. 创建 docker-compose.yml

```yaml
version: '3.8'

services:
  media-renamer:
    build: .
    ports:
      - "8090:8090"
    volumes:
      - ./data:/app/data
      - ./config:/app/config
    environment:
      - PORT=8090
      - HOST=0.0.0.0
    restart: unless-stopped
```

#### 2. 启动服务

```bash
# 启动
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止
docker-compose down
```

### 使用 Docker 命令

```bash
# 构建镜像
docker build -t media-renamer:v2.8.0 .

# 运行容器
docker run -d \
  --name media-renamer \
  -p 8090:8090 \
  -v $(pwd)/data:/app/data \
  -v $(pwd)/config:/app/config \
  -e PORT=8090 \
  media-renamer:v2.8.0

# 查看日志
docker logs -f media-renamer

# 停止容器
docker stop media-renamer

# 删除容器
docker rm media-renamer
```

---

## 💻 本地部署

### Linux/macOS

#### 1. 安装 Python

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install python3 python3-pip

# CentOS/RHEL
sudo yum install python3 python3-pip

# macOS (使用 Homebrew)
brew install python3
```

#### 2. 克隆和安装

```bash
# 克隆仓库
git clone https://github.com/haishuai1987/media-sorter.git
cd media-sorter

# 创建虚拟环境（推荐）
python3 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt
pip install -r requirements-v2.8.0.txt
```

#### 3. 启动应用

```bash
# 默认端口 8090
python app_v2.py

# 自定义端口
python app_v2.py --port 8091

# 后台运行
nohup python app_v2.py > app.log 2>&1 &
```

### Windows

#### 1. 安装 Python

从 [python.org](https://www.python.org/downloads/) 下载并安装 Python 3.7+

#### 2. 克隆和安装

```powershell
# 克隆仓库
git clone https://github.com/haishuai1987/media-sorter.git
cd media-sorter

# 创建虚拟环境（推荐）
python -m venv venv
venv\Scripts\activate

# 安装依赖
pip install -r requirements.txt
pip install -r requirements-v2.8.0.txt
```

#### 3. 启动应用

```powershell
# 默认端口 8090
python app_v2.py

# 自定义端口
python app_v2.py --port 8091
```

---

## ☁️ 云服务器部署

### Ubuntu Server

#### 1. 准备服务器

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装必要软件
sudo apt install -y python3 python3-pip git nginx
```

#### 2. 部署应用

```bash
# 克隆仓库
cd /opt
sudo git clone https://github.com/haishuai1987/media-sorter.git
cd media-renamer

# 安装依赖
sudo pip3 install -r requirements.txt
sudo pip3 install -r requirements-v2.8.0.txt
```

#### 3. 配置系统服务

创建 `/etc/systemd/system/media-renamer.service`：

```ini
[Unit]
Description=Media Renamer Service
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/opt/media-renamer
Environment="PATH=/usr/bin"
ExecStart=/usr/bin/python3 /opt/media-renamer/app_v2.py --host 0.0.0.0 --port 8090
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启动服务：

```bash
# 重载配置
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start media-renamer

# 设置开机自启
sudo systemctl enable media-renamer

# 查看状态
sudo systemctl status media-renamer

# 查看日志
sudo journalctl -u media-renamer -f
```

#### 4. 配置 Nginx 反向代理

创建 `/etc/nginx/sites-available/media-renamer`：

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:8090;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

启用配置：

```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/media-renamer /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx
```

#### 5. 配置 SSL（可选）

```bash
# 安装 Certbot
sudo apt install -y certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo certbot renew --dry-run
```

---

## 🔧 配置选项

### 环境变量

| 变量 | 说明 | 默认值 |
|------|------|--------|
| `PORT` | 监听端口 | 8090 |
| `HOST` | 监听地址 | 0.0.0.0 |
| `DEBUG` | 调试模式 | False |

### 命令行参数

```bash
python app_v2.py --help

选项:
  --host HOST       监听地址 (默认: 0.0.0.0)
  --port PORT       监听端口 (默认: 8090)
  --debug           启用调试模式
```

### 配置文件

应用配置存储在 `data/configs/` 目录：

```
data/
├── configs/          # 配置文件
│   └── configs.json
└── history.db        # 历史记录数据库
```

---

## 🔒 安全配置

### 1. 防火墙配置

```bash
# Ubuntu/Debian (UFW)
sudo ufw allow 8090/tcp
sudo ufw enable

# CentOS/RHEL (firewalld)
sudo firewall-cmd --permanent --add-port=8090/tcp
sudo firewall-cmd --reload
```

### 2. 反向代理认证

在 Nginx 配置中添加基本认证：

```nginx
location / {
    auth_basic "Restricted Access";
    auth_basic_user_file /etc/nginx/.htpasswd;
    
    proxy_pass http://127.0.0.1:8090;
    # ... 其他配置
}
```

创建密码文件：

```bash
sudo apt install apache2-utils
sudo htpasswd -c /etc/nginx/.htpasswd admin
```

### 3. HTTPS 配置

使用 Let's Encrypt 免费证书（见上文 SSL 配置）

---

## 📊 性能优化

### 1. 使用 Gunicorn（生产环境推荐）

```bash
# 安装 Gunicorn
pip install gunicorn

# 启动应用
gunicorn -w 4 -b 0.0.0.0:8090 app_v2:app

# 使用配置文件
gunicorn -c gunicorn.conf.py app_v2:app
```

创建 `gunicorn.conf.py`：

```python
bind = "0.0.0.0:8090"
workers = 4
worker_class = "eventlet"  # 支持 WebSocket
timeout = 120
keepalive = 5
```

### 2. 数据库优化

SQLite 配置（`data/history.db`）：

```python
# 在应用中配置
PRAGMA journal_mode = WAL;
PRAGMA synchronous = NORMAL;
PRAGMA cache_size = 10000;
```

### 3. 静态文件缓存

Nginx 配置：

```nginx
location /static/ {
    alias /opt/media-renamer/public/;
    expires 30d;
    add_header Cache-Control "public, immutable";
}
```

---

## 🔍 监控和日志

### 查看日志

```bash
# 应用日志
tail -f app.log

# 系统服务日志
sudo journalctl -u media-renamer -f

# Nginx 日志
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

### 监控指标

- CPU 使用率
- 内存使用率
- 磁盘 I/O
- 网络流量
- 响应时间

---

## 🔄 更新和维护

### 更新应用

```bash
# 停止服务
sudo systemctl stop media-renamer

# 拉取最新代码
cd /opt/media-renamer
sudo git pull origin main

# 更新依赖
sudo pip3 install -r requirements.txt -U
sudo pip3 install -r requirements-v2.8.0.txt -U

# 启动服务
sudo systemctl start media-renamer
```

### 备份数据

```bash
# 备份配置和数据
tar -czf backup-$(date +%Y%m%d).tar.gz data/

# 恢复备份
tar -xzf backup-20231023.tar.gz
```

---

## 🐛 故障排查

### 常见问题

#### 1. 端口被占用

```bash
# 查看端口占用
sudo lsof -i :8090
sudo netstat -tulpn | grep 8090

# 更换端口
python app_v2.py --port 8091
```

#### 2. 依赖安装失败

```bash
# 升级 pip
pip install --upgrade pip

# 使用国内镜像
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

#### 3. 权限问题

```bash
# 修改文件权限
sudo chown -R www-data:www-data /opt/media-renamer
sudo chmod -R 755 /opt/media-renamer
```

#### 4. WebSocket 连接失败

检查 Nginx 配置是否支持 WebSocket：

```nginx
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection 'upgrade';
```

---

## 📚 相关文档

- [快速开始](./快速开始.md) - 快速上手指南
- [使用手册](./使用手册.md) - 完整功能说明
- [常见问题](./常见问题.md) - 问题解答
- [API 文档](./API文档.md) - API 接口说明

---

**部署成功后，访问应用开始使用！** 🎉
