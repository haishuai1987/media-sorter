# 部署手册

## 目录
- [快速部署](#快速部署)
- [NAS系统部署](#nas系统部署)
- [云服务器部署](#云服务器部署)
- [Docker部署](#docker部署)
- [系统服务配置](#系统服务配置)

---

## 快速部署

### 自动安装（推荐）

```bash
git clone https://github.com/haishuai1987/media-sorter.git
cd media-sorter
chmod +x install.sh
./install.sh
python3 app.py
```

访问：http://localhost:8090

### 手动安装

```bash
# 1. 检查Python版本
python3 --version  # 需要 >= 3.6

# 2. 创建配置目录
mkdir -p ~/.media-renamer

# 3. 启动服务
python3 app.py
```

---

## NAS系统部署

### Synology DSM

#### 方法1: Docker（推荐）

1. 安装 **Container Manager**
2. 创建工作目录：
```bash
mkdir -p /volume1/docker/media-renamer
cd /volume1/docker/media-renamer
```
3. 上传文件（app.py, docker-compose.yml等）
4. 启动容器：
```bash
docker-compose up -d
```

#### 方法2: Python直接运行

1. 安装 **Python 3.9**（套件中心）
2. SSH登录并创建目录：
```bash
mkdir -p /volume1/apps/media-renamer
cd /volume1/apps/media-renamer
```
3. 上传文件并运行：
```bash
python3 app.py
```

#### 设置开机自启

控制面板 → 任务计划 → 新增 → 触发的任务 → 用户定义的脚本

事件：开机
脚本：
```bash
#!/bin/bash
cd /volume1/apps/media-renamer
python3 app.py &
```

### QNAP QTS

#### 方法1: Container Station（推荐）

```bash
mkdir -p /share/Container/media-renamer
cd /share/Container/media-renamer
docker-compose up -d
```

#### 方法2: Python直接运行

```bash
mkdir -p /share/apps/media-renamer
cd /share/apps/media-renamer
python3 app.py
```

#### 设置开机自启

创建 `/etc/config/autorun.sh`：
```bash
#!/bin/bash
cd /share/apps/media-renamer
python3 app.py &
```

### TrueNAS / FreeNAS

#### 方法1: Jail（推荐）

1. 创建Jail：Jails → ADD
2. 进入Jail：
```bash
iocage console media-renamer
pkg install python39
mkdir -p /usr/local/media-renamer
cd /usr/local/media-renamer
python3.9 app.py
```

#### 方法2: Docker（TrueNAS SCALE）

TrueNAS SCALE原生支持Docker，参考Docker部署方法。

### Unraid

#### Docker部署

1. Docker标签 → Add Container
2. 配置：
   - Name: media-renamer
   - Port: 8090:8090
   - Path: /mnt/user/media:/data

---

## 云服务器部署

### 推荐系统

**Ubuntu 22.04 LTS**（强烈推荐）

**优势**：
- ✅ 长期支持（LTS）
- ✅ Python 3 预装
- ✅ 文档完善
- ✅ 易于维护

### 一键部署脚本

```bash
# 下载脚本
wget https://raw.githubusercontent.com/haishuai1987/media-sorter/main/deploy-cloud.sh
chmod +x deploy-cloud.sh

# 运行脚本
./deploy-cloud.sh
```

脚本会自动完成：
1. ✅ 安装依赖（Python3、Git、Nginx、Certbot）
2. ✅ 克隆项目
3. ✅ 配置Nginx反向代理
4. ✅ 配置SSL证书
5. ✅ 创建Systemd服务
6. ✅ 配置防火墙

### 手动部署步骤

#### 1. 安装系统（Ubuntu 22.04）

```bash
# 更新系统
sudo apt update
sudo apt upgrade -y

# 安装必要软件
sudo apt install -y python3 python3-pip git nginx certbot python3-certbot-nginx
```

#### 2. 克隆项目

```bash
cd /opt
sudo git clone https://github.com/haishuai1987/media-sorter.git
cd media-sorter
sudo chown -R $USER:$USER /opt/media-sorter
```

#### 3. 配置Nginx

创建配置文件：
```bash
sudo nano /etc/nginx/sites-available/media-renamer
```

添加内容：
```nginx
server {
    listen 80;
    server_name your-domain.com;
    client_max_body_size 100M;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        proxy_connect_timeout 600;
        proxy_send_timeout 600;
        proxy_read_timeout 600;
    }
}
```

启用配置：
```bash
sudo ln -s /etc/nginx/sites-available/media-renamer /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

#### 4. 配置SSL（HTTPS）

```bash
# 使用Let's Encrypt免费证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo certbot renew --dry-run
```

#### 5. 创建Systemd服务

```bash
sudo nano /etc/systemd/system/media-renamer.service
```

添加内容：
```ini
[Unit]
Description=Media Renamer Service
After=network.target

[Service]
Type=simple
User=your-username
WorkingDirectory=/opt/media-sorter
Environment="PORT=8000"
ExecStart=/usr/bin/python3 /opt/media-sorter/app.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启动服务：
```bash
sudo systemctl daemon-reload
sudo systemctl enable media-renamer
sudo systemctl start media-renamer
sudo systemctl status media-renamer
```

#### 6. 配置防火墙

```bash
# UFW（Ubuntu）
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow 22/tcp
sudo ufw enable

# Firewalld（CentOS/Rocky）
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --reload
```

#### 7. 域名配置

在域名服务商处添加DNS记录：

```
类型    主机记录    记录值
A       @          your-server-ip
A       www        your-server-ip
```

等待DNS生效（通常10分钟到24小时）。

### 端口说明

- **本地/NAS部署**：默认 **8090** 端口（避免与NAS系统端口冲突）
- **云服务器部署**：默认 **8000** 端口（配合Nginx反向代理）

**访问方式**：
- 本地：http://localhost:8090
- 云服务器：https://your-domain.com

---

## Docker部署

### 使用docker-compose（推荐）

1. 创建docker-compose.yml：
```yaml
version: '3.8'

services:
  media-renamer:
    build: .
    container_name: media-renamer
    ports:
      - "8090:8090"
    volumes:
      - /path/to/media:/data
    environment:
      - TZ=Asia/Shanghai
    restart: unless-stopped
```

2. 启动容器：
```bash
docker-compose up -d
```

### 使用Dockerfile

```bash
# 构建镜像
docker build -t media-renamer .

# 运行容器
docker run -d \
  --name media-renamer \
  -p 8090:8090 \
  -v /path/to/media:/data \
  -e TZ=Asia/Shanghai \
  --restart unless-stopped \
  media-renamer
```

### Docker命令

```bash
# 启动
docker-compose up -d

# 停止
docker-compose down

# 重启
docker-compose restart

# 查看日志
docker-compose logs -f

# 进入容器
docker exec -it media-renamer bash
```

---

## 系统服务配置

### systemd服务（Linux）

创建服务文件：
```bash
sudo nano /etc/systemd/system/media-renamer.service
```

添加内容：
```ini
[Unit]
Description=Media Renamer Service
After=network.target

[Service]
Type=simple
User=your-user
WorkingDirectory=/path/to/media-sorter
ExecStart=/usr/bin/python3 /path/to/media-sorter/app.py
Restart=on-failure
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

管理服务：
```bash
# 启动
sudo systemctl start media-renamer

# 停止
sudo systemctl stop media-renamer

# 重启
sudo systemctl restart media-renamer

# 状态
sudo systemctl status media-renamer

# 日志
sudo journalctl -u media-renamer -f
```

---

## 性能优化

### 1. 使用Gunicorn（云服务器推荐）

```bash
pip3 install gunicorn
```

修改systemd服务：
```ini
ExecStart=/usr/local/bin/gunicorn -w 4 -b 127.0.0.1:8000 app:app
```

### 2. 配置Nginx缓存

```nginx
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=1g inactive=60m;

location / {
    proxy_cache my_cache;
    proxy_cache_valid 200 60m;
    # ... 其他配置
}
```

### 3. 启用Gzip压缩

```nginx
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript application/json;
```

---

## 故障排查

### 1. 服务无法启动

```bash
# 查看详细日志
sudo journalctl -u media-renamer -n 50

# 检查端口占用
sudo lsof -i :8090

# 手动运行测试
cd /path/to/media-sorter
python3 app.py
```

### 2. Nginx 502错误

```bash
# 检查服务是否运行
sudo systemctl status media-renamer

# 检查端口
curl http://127.0.0.1:8000

# 查看Nginx错误日志
sudo tail -f /var/log/nginx/error.log
```

### 3. 权限错误

```bash
# 修改所有者
sudo chown -R $USER:$USER /path/to/media

# 修改权限
sudo chmod -R 755 /path/to/media

# 检查配置目录
chmod 755 ~/.media-renamer
chmod 644 ~/.media-renamer/config.json
```

### 4. 无法访问域名

```bash
# 检查DNS解析
nslookup your-domain.com

# 检查防火墙
sudo ufw status

# 检查Nginx配置
sudo nginx -t
```

---

## 安全建议

### 1. 修改SSH端口

```bash
sudo nano /etc/ssh/sshd_config
# 修改 Port 22 为其他端口
sudo systemctl restart sshd
```

### 2. 禁用root登录

```bash
sudo nano /etc/ssh/sshd_config
# 设置 PermitRootLogin no
sudo systemctl restart sshd
```

### 3. 配置fail2ban

```bash
sudo apt install fail2ban
sudo systemctl enable fail2ban
sudo systemctl start fail2ban
```

---

## 备份策略

### 配置文件备份

```bash
# 创建备份脚本
sudo nano /opt/backup.sh

#!/bin/bash
BACKUP_DIR="/opt/backups"
DATE=$(date +%Y%m%d_%H%M%S)
mkdir -p $BACKUP_DIR

tar -czf $BACKUP_DIR/config_$DATE.tar.gz \
    ~/.media-renamer/config.json \
    /etc/nginx/sites-available/media-renamer

find $BACKUP_DIR -name "config_*.tar.gz" -mtime +7 -delete

sudo chmod +x /opt/backup.sh

# 添加到crontab
crontab -e
# 添加：0 2 * * * /opt/backup.sh
```

---

## 常用命令

### 服务管理

```bash
# 查看服务状态
sudo systemctl status media-renamer

# 查看日志
sudo journalctl -u media-renamer -f

# 重启服务
sudo systemctl restart media-renamer
```

### Nginx管理

```bash
# 测试配置
sudo nginx -t

# 重启Nginx
sudo systemctl restart nginx

# 查看日志
sudo tail -f /var/log/nginx/access.log
```

### SSL证书管理

```bash
# 查看证书信息
sudo certbot certificates

# 手动续期
sudo certbot renew

# 测试续期
sudo certbot renew --dry-run
```

---

## 更新应用

```bash
# 进入应用目录
cd /opt/media-sorter

# 拉取最新代码
git pull origin main

# 重启服务
sudo systemctl restart media-renamer
```

---

## 卸载

```bash
# 停止并禁用服务
sudo systemctl stop media-renamer
sudo systemctl disable media-renamer

# 删除服务文件
sudo rm /etc/systemd/system/media-renamer.service
sudo systemctl daemon-reload

# 删除Nginx配置
sudo rm /etc/nginx/sites-enabled/media-renamer
sudo rm /etc/nginx/sites-available/media-renamer
sudo systemctl restart nginx

# 删除应用目录
sudo rm -rf /opt/media-sorter

# 删除SSL证书（可选）
sudo certbot delete --cert-name your-domain.com
```

---

## 更多信息

- [快速开始](./快速开始.md) - 5分钟上手
- [使用手册](./使用手册.md) - 完整功能说明
- [常见问题](./常见问题.md) - 问题解答
