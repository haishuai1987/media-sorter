# 一键部署脚本使用说明

## 概述

`deploy-cloud.sh` 是云服务器一键部署脚本，可以自动完成所有部署步骤。

---

## 使用方法

### 1. 下载脚本

```bash
# 方法 1：克隆整个项目
git clone https://github.com/haishuai1987/media-sorter.git
cd media-sorter

# 方法 2：只下载脚本
wget https://raw.githubusercontent.com/haishuai1987/media-sorter/main/deploy-cloud.sh
chmod +x deploy-cloud.sh
```

---

### 2. 运行脚本

```bash
# 给脚本执行权限
chmod +x deploy-cloud.sh

# 运行脚本
./deploy-cloud.sh
```

---

### 3. 按提示输入信息

脚本会询问以下信息：

#### 必填信息

**域名**：
```
请输入域名（如 media.example.com）: your-domain.com
```

**SSL 证书**：
```
是否配置 SSL 证书？(y/n): y
```

**邮箱**（如果配置 SSL）：
```
请输入邮箱（用于 Let's Encrypt）: your@email.com
```

#### 可选信息

**安装目录**（默认 /opt/media-renamer）：
```
安装目录（默认 /opt/media-renamer）: [直接回车使用默认]
```

---

### 4. 确认并开始部署

脚本会显示配置信息：

```
配置信息：
  域名: your-domain.com
  SSL: true
  邮箱: your@email.com
  安装目录: /opt/media-renamer

确认开始部署？(y/n): y
```

输入 `y` 开始自动部署。

---

## 部署步骤

脚本会自动执行以下步骤：

1. ✅ 检查系统环境
2. ✅ 更新系统软件包
3. ✅ 安装依赖（Python3、Git、Nginx、Certbot）
4. ✅ 克隆项目到指定目录
5. ✅ 配置环境变量
6. ✅ 配置 Nginx 反向代理
7. ✅ 配置 SSL 证书（如果选择）
8. ✅ 创建 Systemd 服务
9. ✅ 配置防火墙
10. ✅ 检查服务状态

---

## 部署完成

部署成功后，脚本会显示：

```
========================================
  部署完成！
========================================

访问地址: https://your-domain.com

常用命令:
  查看服务状态: sudo systemctl status media-renamer
  查看日志: sudo journalctl -u media-renamer -f
  重启服务: sudo systemctl restart media-renamer
  停止服务: sudo systemctl stop media-renamer

配置文件位置:
  应用目录: /opt/media-renamer
  Nginx 配置: /etc/nginx/sites-available/media-renamer
  Systemd 服务: /etc/systemd/system/media-renamer.service

SSL 证书:
  证书位置: /etc/letsencrypt/live/your-domain.com/
  自动续期: 已启用（certbot.timer）

下一步:
  1. 访问应用并完成初始配置
  2. 在设置中配置 TMDB API Key 和豆瓣 Cookie
  3. 配置媒体库路径
```

---

## 系统要求

### 推荐配置

- **系统**：Ubuntu 22.04 LTS 或 20.04 LTS
- **CPU**：2核
- **内存**：2GB
- **硬盘**：40GB SSD
- **带宽**：3Mbps

### 支持的系统

- ✅ Ubuntu 22.04 LTS（推荐）
- ✅ Ubuntu 20.04 LTS
- ⚠️ Debian 11/12（可能需要手动调整）
- ⚠️ CentOS/Rocky Linux（可能需要手动调整）

---

## 前置要求

### 1. 域名配置

在运行脚本前，需要先配置域名 DNS：

```
类型    主机记录    记录值
A       @          your-server-ip
A       www        your-server-ip
```

等待 DNS 生效（通常 10 分钟到 24 小时）。

### 2. 服务器访问

确保你可以通过 SSH 访问服务器：

```bash
ssh user@your-server-ip
```

### 3. 权限

- 需要 sudo 权限
- 建议使用普通用户 + sudo（不推荐直接使用 root）

---

## 常用命令

### 服务管理

```bash
# 查看服务状态
sudo systemctl status media-renamer

# 启动服务
sudo systemctl start media-renamer

# 停止服务
sudo systemctl stop media-renamer

# 重启服务
sudo systemctl restart media-renamer

# 查看日志
sudo journalctl -u media-renamer -f

# 查看最近 50 条日志
sudo journalctl -u media-renamer -n 50
```

---

### Nginx 管理

```bash
# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx

# 查看 Nginx 日志
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

---

### SSL 证书管理

```bash
# 查看证书信息
sudo certbot certificates

# 手动续期
sudo certbot renew

# 测试续期
sudo certbot renew --dry-run
```

---

## 故障排查

### 1. 服务无法启动

```bash
# 查看详细日志
sudo journalctl -u media-renamer -n 50

# 检查端口占用
sudo netstat -tlnp | grep 8000

# 手动运行测试
cd /opt/media-renamer
python3 app.py
```

---

### 2. Nginx 502 错误

```bash
# 检查服务是否运行
sudo systemctl status media-renamer

# 检查端口
curl http://127.0.0.1:8000

# 查看 Nginx 错误日志
sudo tail -f /var/log/nginx/error.log
```

---

### 3. SSL 证书配置失败

**原因**：
- DNS 未生效
- 防火墙阻止 80/443 端口
- 域名解析错误

**解决方案**：
```bash
# 检查 DNS 解析
nslookup your-domain.com

# 检查防火墙
sudo ufw status

# 手动配置 SSL
sudo certbot --nginx -d your-domain.com
```

---

### 4. 无法访问域名

```bash
# 检查 DNS 解析
nslookup your-domain.com

# 检查防火墙
sudo ufw status

# 检查 Nginx 配置
sudo nginx -t

# 检查服务状态
sudo systemctl status nginx
sudo systemctl status media-renamer
```

---

## 卸载

如果需要卸载，运行以下命令：

```bash
# 停止并禁用服务
sudo systemctl stop media-renamer
sudo systemctl disable media-renamer

# 删除服务文件
sudo rm /etc/systemd/system/media-renamer.service
sudo systemctl daemon-reload

# 删除 Nginx 配置
sudo rm /etc/nginx/sites-enabled/media-renamer
sudo rm /etc/nginx/sites-available/media-renamer
sudo systemctl restart nginx

# 删除应用目录
sudo rm -rf /opt/media-renamer

# 删除 SSL 证书（可选）
sudo certbot delete --cert-name your-domain.com
```

---

## 更新应用

```bash
# 进入应用目录
cd /opt/media-renamer

# 拉取最新代码
git pull origin main

# 重启服务
sudo systemctl restart media-renamer
```

---

## 安全建议

### 1. 修改 SSH 端口

```bash
sudo nano /etc/ssh/sshd_config
# 修改 Port 22 为其他端口
sudo systemctl restart sshd
```

### 2. 禁用 root 登录

```bash
sudo nano /etc/ssh/sshd_config
# 设置 PermitRootLogin no
sudo systemctl restart sshd
```

### 3. 配置 fail2ban

```bash
sudo apt install fail2ban
sudo systemctl enable fail2ban
sudo systemctl start fail2ban
```

---

## 常见问题

### Q1: 脚本支持哪些系统？

**A**: 主要支持 Ubuntu 22.04/20.04 LTS，其他系统可能需要手动调整。

---

### Q2: 可以不配置 SSL 吗？

**A**: 可以，脚本会询问是否配置 SSL。但强烈建议配置 HTTPS。

---

### Q3: 可以修改安装目录吗？

**A**: 可以，脚本会询问安装目录，默认为 /opt/media-renamer。

---

### Q4: 部署失败怎么办？

**A**: 
1. 查看错误信息
2. 检查系统要求
3. 查看故障排查部分
4. 提交 Issue

---

### Q5: 如何更新到最新版本？

**A**: 
```bash
cd /opt/media-renamer
git pull origin main
sudo systemctl restart media-renamer
```

---

## 获取帮助

- 📖 查看 [云服务器部署指南](./云服务器部署指南.md)
- ❓ 查看 [常见问题](./常见问题.md)
- 🐛 提交 Issue

---

## 总结

一键部署脚本可以：

✅ **自动化部署** - 无需手动配置
✅ **交互式配置** - 友好的用户界面
✅ **完整功能** - 包含 Nginx、SSL、Systemd
✅ **错误处理** - 自动检查和提示
✅ **易于使用** - 只需运行一个命令

享受自动化的部署体验！🚀
