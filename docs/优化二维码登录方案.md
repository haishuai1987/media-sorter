# 优化二维码登录方案

## 问题分析

当前二维码登录的问题：
1. ❌ 需要qrcode库生成二维码图片
2. ❌ 后端生成图片可能阻塞
3. ❌ Web端可能卡死

## 解决方案：使用115官方二维码图片

### 核心发现

115提供了**现成的二维码图片URL**：
```
https://qrcodeapi.115.com/api/1.0/mac/1.0/qrcode?uid={uid}
```

**不需要自己生成二维码！** 直接在前端显示这个URL的图片即可。

### 优化后的流程

```
前端                          后端                        115 API
  │                            │                            │
  │  1. 请求开始扫码登录         │                            │
  ├──────────────────────────>│                            │
  │                            │  2. 获取Token              │
  │                            ├──────────────────────────>│
  │                            │<──────────────────────────┤
  │  3. 返回二维码URL和Token    │                            │
  │<──────────────────────────┤                            │
  │                            │                            │
  │  4. 显示二维码图片           │                            │
  │  <img src="qr_url">        │                            │
  │                            │                            │
  │  5. 轮询检查状态             │                            │
  ├──────────────────────────>│  6. 检查扫码状态            │
  │                            ├──────────────────────────>│
  │                            │<──────────────────────────┤
  │  7. 返回状态                │                            │
  │<──────────────────────────┤                            │
  │                            │                            │
  │  (重复5-7直到扫码完成)       │                            │
  │                            │                            │
  │  8. 扫码成功，获取Cookie     │                            │
  ├──────────────────────────>│  9. POST获取Cookie         │
  │                            ├──────────────────────────>│
  │                            │<──────────────────────────┤
  │  10. 返回Cookie             │                            │
  │<──────────────────────────┤                            │
  │                            │                            │
  │  11. 保存Cookie并刷新       │                            │
```

### 优势

1. ✅ **不需要qrcode库** - 使用115官方图片
2. ✅ **不阻塞后端** - 只是返回URL，不生成图片
3. ✅ **不卡死Web端** - 异步轮询，不阻塞UI
4. ✅ **用户体验好** - 实时显示扫码状态
5. ✅ **跨平台兼容** - 纯Web实现

## 实现代码

### 后端API

```python
@app.route('/api/qrcode/start', methods=['POST'])
def start_qrcode_login():
    """开始二维码登录"""
    try:
        data = request.get_json()
        app_type = data.get('app', 'wechatmini')
        
        # 1. 获取Token
        url = 'https://qrcodeapi.115.com/api/1.0/web/1.0/token/'
        response = requests.get(url, timeout=10)
        result = response.json()
        
        if not result.get('state'):
            return jsonify({'success': False, 'error': '获取Token失败'})
        
        token_data = result.get('data', {})
        uid = token_data.get('uid')
        
        # 2. 生成二维码URL（不需要qrcode库！）
        qr_url = f'https://qrcodeapi.115.com/api/1.0/mac/1.0/qrcode?uid={uid}'
        
        # 3. 返回给前端
        return jsonify({
            'success': True,
            'qr_url': qr_url,  # 前端直接显示这个图片
            'uid': uid,
            'time': token_data.get('time'),
            'sign': token_data.get('sign'),
            'app': app_type
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/qrcode/check', methods=['POST'])
def check_qrcode_status():
    """检查二维码扫码状态"""
    try:
        data = request.get_json()
        uid = data.get('uid')
        time_val = data.get('time')
        sign = data.get('sign')
        
        # 检查状态
        params = {'uid': uid, 'time': time_val, 'sign': sign}
        url = f'https://qrcodeapi.115.com/get/status/?{urlencode(params)}'
        response = requests.get(url, timeout=10)
        result = response.json()
        
        status_data = result.get('data', {})
        status_code = status_data.get('status')
        
        # 状态码：
        # 0 - 等待扫码
        # 1 - 已扫码，等待确认
        # 2 - 已确认，登录成功
        # -1 - 二维码过期
        # -2 - 用户取消
        
        return jsonify({
            'success': True,
            'status': status_code
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})


@app.route('/api/qrcode/finish', methods=['POST'])
def finish_qrcode_login():
    """完成二维码登录，获取Cookie"""
    try:
        data = request.get_json()
        uid = data.get('uid')
        app_type = data.get('app', 'wechatmini')
        
        # POST获取Cookie
        url = f'https://passportapi.115.com/app/1.0/{app_type}/1.0/login/qrcode/'
        post_data = {'app': app_type, 'account': uid}
        response = requests.post(url, data=post_data, timeout=10)
        result = response.json()
        
        if not result.get('state'):
            return jsonify({'success': False, 'error': '获取Cookie失败'})
        
        # 提取Cookie
        cookie_dict = result.get('data', {}).get('cookie', {})
        cookie_parts = []
        for key in ['UID', 'CID', 'SEID']:
            if key in cookie_dict:
                cookie_parts.append(f"{key}={cookie_dict[key]}")
        
        cookie = '; '.join(cookie_parts)
        
        # 保存Cookie
        config = load_config()
        config['cloud115_cookie'] = cookie
        save_config(config)
        
        return jsonify({
            'success': True,
            'cookie': cookie
        })
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})
```

### 前端实现

```javascript
// 开始二维码登录
async function startQRCodeLogin() {
  try {
    showLoading('正在生成二维码...');
    
    const response = await fetch('/api/qrcode/start', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({app: 'wechatmini'})
    });
    
    const data = await response.json();
    
    if (data.success) {
      // 显示二维码（直接用img标签显示URL）
      showQRCode(data.qr_url, data);
      
      // 开始轮询检查状态
      startPolling(data);
    } else {
      showError('生成二维码失败: ' + data.error);
    }
  } catch (error) {
    showError('请求失败: ' + error.message);
  }
}

// 显示二维码
function showQRCode(qrUrl, tokenData) {
  const modal = document.getElementById('qrcode-modal');
  const img = document.getElementById('qrcode-image');
  const status = document.getElementById('qrcode-status');
  
  // 直接显示115的二维码图片
  img.src = qrUrl;
  img.style.display = 'block';
  
  status.textContent = '请使用115手机客户端扫描二维码';
  status.className = 'status-waiting';
  
  modal.style.display = 'block';
  
  // 保存token数据用于轮询
  window.qrcodeData = tokenData;
}

// 轮询检查状态
function startPolling(tokenData) {
  let attempts = 0;
  const maxAttempts = 30; // 60秒超时
  
  const pollInterval = setInterval(async () => {
    attempts++;
    
    if (attempts > maxAttempts) {
      clearInterval(pollInterval);
      showQRCodeStatus('二维码已过期，请重新获取', 'error');
      return;
    }
    
    try {
      const response = await fetch('/api/qrcode/check', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          uid: tokenData.uid,
          time: tokenData.time,
          sign: tokenData.sign
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        const status = data.status;
        
        if (status === 0) {
          showQRCodeStatus('等待扫码...', 'waiting');
        } else if (status === 1) {
          showQRCodeStatus('已扫码，请在手机上确认', 'scanned');
        } else if (status === 2) {
          // 扫码成功！
          clearInterval(pollInterval);
          showQRCodeStatus('扫码成功，正在获取Cookie...', 'success');
          
          // 获取Cookie
          await finishLogin(tokenData);
        } else if (status === -1) {
          clearInterval(pollInterval);
          showQRCodeStatus('二维码已过期', 'error');
        } else if (status === -2) {
          clearInterval(pollInterval);
          showQRCodeStatus('用户取消扫码', 'error');
        }
      }
    } catch (error) {
      console.error('检查状态失败:', error);
    }
  }, 2000); // 每2秒检查一次
  
  // 保存interval ID用于取消
  window.qrcodePolling = pollInterval;
}

// 完成登录
async function finishLogin(tokenData) {
  try {
    const response = await fetch('/api/qrcode/finish', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        uid: tokenData.uid,
        app: tokenData.app
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      showQRCodeStatus('登录成功！', 'success');
      
      // 延迟关闭弹窗并刷新页面
      setTimeout(() => {
        closeQRCodeModal();
        location.reload();
      }, 1500);
    } else {
      showQRCodeStatus('获取Cookie失败: ' + data.error, 'error');
    }
  } catch (error) {
    showQRCodeStatus('请求失败: ' + error.message, 'error');
  }
}

// 显示状态
function showQRCodeStatus(message, type) {
  const status = document.getElementById('qrcode-status');
  status.textContent = message;
  status.className = `status-${type}`;
}

// 关闭弹窗
function closeQRCodeModal() {
  const modal = document.getElementById('qrcode-modal');
  modal.style.display = 'none';
  
  // 停止轮询
  if (window.qrcodePolling) {
    clearInterval(window.qrcodePolling);
  }
}
```

### HTML结构

```html
<!-- 二维码登录按钮 -->
<button onclick="startQRCodeLogin()" class="btn btn-primary">
  📱 扫码登录
</button>

<!-- 二维码弹窗 -->
<div id="qrcode-modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeQRCodeModal()">&times;</span>
    <h2>扫码登录115网盘</h2>
    
    <!-- 直接显示115的二维码图片 -->
    <img id="qrcode-image" src="" alt="二维码" style="width: 300px; height: 300px;">
    
    <p id="qrcode-status" class="status-waiting">正在加载...</p>
    
    <div class="tips">
      <p>💡 提示：</p>
      <ul>
        <li>请使用115手机客户端扫描二维码</li>
        <li>二维码有效期60秒</li>
        <li>扫码后请在手机上确认登录</li>
      </ul>
    </div>
  </div>
</div>
```

## 总结

这个方案的关键优势：

1. **不需要qrcode库** - 直接使用115官方二维码图片URL
2. **不阻塞后端** - 只返回URL，不生成图片
3. **异步轮询** - 前端定时检查状态，不阻塞UI
4. **实时反馈** - 显示扫码进度（等待→已扫码→成功）
5. **自动完成** - 扫码成功后自动获取Cookie并保存

**实现时间：** 约1-2小时
**用户体验：** 优秀，类似主流网站的扫码登录
