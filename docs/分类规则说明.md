# 分类规则说明

## 概述

系统使用基于 TMDB 元数据的规则分类系统，根据电影/电视剧的类型、语言、国家等信息自动分类到二级目录。

---

## 分类方式

### 1. 规则分类（主要方式）

根据 TMDB API 返回的元数据自动分类：
- `genre_ids`：内容类型（动作、喜剧、科幻等）
- `original_language`：原始语言
- `origin_country`：国家或地区（电视剧）
- `production_countries`：制作国家（电影）

### 2. 目录检测（辅助方式）

检测现有的分类目录，智能匹配文件应该放到哪个目录：
- 精确匹配：分类名称完全相同
- 模糊匹配：包含关系匹配
- 支持中英文混合

---

## 内置分类规则

### 电影分类

#### 1. 动画电影
**匹配条件**：
- `genre_ids` 包含 `16`（动画）

**示例**：
- 疯狂动物城
- 寻梦环游记
- 千与千寻

#### 2. 华语电影
**匹配条件**：
- `original_language` 为 `zh`, `cn`, `bo`, `za`（中文及方言）

**示例**：
- 流浪地球
- 你好，李焕英
- 长津湖

#### 3. 外语电影（默认）
**匹配条件**：
- 不匹配以上任何规则

**示例**：
- 阿凡达
- 复仇者联盟
- 泰坦尼克号

---

### 电视剧分类

#### 1. 国漫
**匹配条件**：
- `genre_ids` 包含 `16`（动画）
- `origin_country` 包含 `CN`, `TW`, `HK`（中国、台湾、香港）

**示例**：
- 斗罗大陆
- 完美世界
- 凡人修仙传

#### 2. 日番
**匹配条件**：
- `genre_ids` 包含 `16`（动画）
- `origin_country` 包含 `JP`（日本）

**示例**：
- 进击的巨人
- 鬼灭之刃
- 咒术回战

#### 3. 纪录片
**匹配条件**：
- `genre_ids` 包含 `99`（纪录片）

**示例**：
- 蓝色星球
- 地球脉动
- 舌尖上的中国

#### 4. 儿童
**匹配条件**：
- `genre_ids` 包含 `10762`（儿童）

**示例**：
- 小猪佩奇
- 汪汪队立大功
- 超级飞侠

#### 5. 综艺
**匹配条件**：
- `genre_ids` 包含 `10764` 或 `10767`（综艺）

**示例**：
- 奔跑吧
- 极限挑战
- 向往的生活

#### 6. 国产剧
**匹配条件**：
- `origin_country` 包含 `CN`, `TW`, `HK`（中国、台湾、香港）
- 不匹配以上任何规则

**示例**：
- 三体
- 狂飙
- 开端

#### 7. 欧美剧
**匹配条件**：
- `origin_country` 包含 `US`, `FR`, `GB`, `DE`, `ES`, `IT`, `NL`, `PT`, `RU`, `UK`

**示例**：
- 权力的游戏
- 绝命毒师
- 西部世界

#### 8. 日韩剧
**匹配条件**：
- `origin_country` 包含 `JP`, `KP`, `KR`, `TH`, `IN`, `SG`

**示例**：
- 半泽直树
- 鱿鱼游戏
- 请回答1988

#### 9. 未分类（默认）
**匹配条件**：
- 不匹配以上任何规则

---

## 分类流程

### 1. 获取元数据

从 TMDB API 获取电影/电视剧的详细信息：
```json
{
  "genre_ids": [16, 35],
  "original_language": "ja",
  "origin_country": ["JP"]
}
```

### 2. 按顺序匹配规则

按照配置文件中的顺序，逐个匹配分类规则：
1. 检查 `genre_ids` 是否匹配
2. 检查 `origin_country` 是否匹配
3. 检查 `original_language` 是否匹配
4. 所有条件都满足才算匹配成功

### 3. 确定分类

- 匹配成功：使用该分类名称
- 未匹配：使用默认分类（外语电影/未分类）

### 4. 检测现有目录

检查媒体库中是否已存在该分类目录：
- 存在：使用现有目录
- 不存在：创建新目录

---

## TMDB 元数据字典

### genre_ids（类型）

**电影类型**：
- 28 - 动作 (Action)
- 12 - 冒险 (Adventure)
- 16 - 动画 (Animation)
- 35 - 喜剧 (Comedy)
- 80 - 犯罪 (Crime)
- 99 - 纪录 (Documentary)
- 18 - 剧情 (Drama)
- 10751 - 家庭 (Family)
- 14 - 奇幻 (Fantasy)
- 36 - 历史 (History)
- 27 - 恐怖 (Horror)
- 10402 - 音乐 (Music)
- 9648 - 悬疑 (Mystery)
- 10749 - 爱情 (Romance)
- 878 - 科幻 (Science Fiction)
- 10770 - 电视电影 (TV Movie)
- 53 - 惊悚 (Thriller)
- 10752 - 战争 (War)
- 37 - 西部 (Western)

**电视剧类型**：
- 10759 - 动作冒险 (Action & Adventure)
- 16 - 动画 (Animation)
- 35 - 喜剧 (Comedy)
- 80 - 犯罪 (Crime)
- 99 - 纪录片 (Documentary)
- 18 - 剧情 (Drama)
- 10751 - 家庭 (Family)
- 10762 - 儿童 (Kids)
- 9648 - 悬疑 (Mystery)
- 10763 - 新闻 (News)
- 10764 - 真人秀 (Reality)
- 10765 - 科幻奇幻 (Sci-Fi & Fantasy)
- 10766 - 肥皂剧 (Soap)
- 10767 - 脱口秀 (Talk)
- 10768 - 战争政治 (War & Politics)
- 37 - 西部 (Western)

### original_language（语言）

常用语言代码：
- zh, cn - 中文
- en - 英语
- ja - 日语
- ko - 韩语
- fr - 法语
- de - 德语
- es - 西班牙语
- it - 意大利语
- ru - 俄语
- th - 泰语

### origin_country（国家/地区）

常用国家代码：
- CN - 中国大陆
- TW - 中国台湾
- HK - 中国香港
- US - 美国
- GB - 英国
- JP - 日本
- KR - 韩国
- FR - 法国
- DE - 德国
- ES - 西班牙
- IT - 意大利
- RU - 俄罗斯
- TH - 泰国
- IN - 印度

---

## 自定义分类

### 修改分类规则

编辑 `app.py` 中的 `CATEGORY_CONFIG`：

```python
CATEGORY_CONFIG = {
    'movie': {
        '动画电影': {
            'genre_ids': ['16']
        },
        '华语电影': {
            'original_language': ['zh', 'cn', 'bo', 'za']
        },
        '外语电影': {}  # 默认分类
    },
    'tv': {
        # 自定义电视剧分类...
    }
}
```

### 添加新分类

在对应的 `movie` 或 `tv` 下添加新规则：

```python
'科幻电影': {
    'genre_ids': ['878']  # 科幻类型
},
'动作电影': {
    'genre_ids': ['28']  # 动作类型
}
```

### 组合条件

多个条件需要同时满足：

```python
'国产科幻': {
    'genre_ids': ['878'],  # 科幻
    'original_language': ['zh', 'cn']  # 中文
}
```

---

## 常见问题

### Q1: 如何查看文件的分类结果？

**A**: 查看整理日志，会显示：
```
元数据: genre_ids=['16'], origin_country=['JP'], language=ja
匹配分类: 日番
```

### Q2: 为什么文件没有分类到预期的目录？

**A**: 可能原因：
1. TMDB 元数据不准确
2. 分类规则不匹配
3. 匹配顺序问题（先匹配的规则优先）

### Q3: 如何修改分类规则？

**A**: 编辑 `app.py` 中的 `CATEGORY_CONFIG`，重启服务生效。

### Q4: 可以禁用某个分类吗？

**A**: 可以，删除或注释掉对应的分类规则即可。

### Q5: 如何添加更细分的分类？

**A**: 在 `CATEGORY_CONFIG` 中添加新规则，使用更具体的条件组合。

---

## 最佳实践

### 1. 分类顺序

将更具体的分类放在前面：
```python
'国产科幻': {...},  # 更具体
'国产剧': {...},    # 较宽泛
'未分类': {}        # 默认
```

### 2. 默认分类

每个类型（movie/tv）都应该有一个默认分类：
```python
'外语电影': {},  # 电影默认
'未分类': {}     # 电视剧默认
```

### 3. 测试分类

修改规则后，先用少量文件测试：
1. 查看日志中的元数据
2. 确认分类结果正确
3. 再批量处理

---

## 技术细节

### 分类匹配算法

```python
def determine_category(metadata, media_type):
    config = CATEGORY_CONFIG.get(media_type, {})
    
    for category_name, rules in config.items():
        match = True
        
        # 检查 genre_ids
        if 'genre_ids' in rules:
            if not any(gid in metadata['genre_ids'] for gid in rules['genre_ids']):
                match = False
        
        # 检查 origin_country
        if match and 'origin_country' in rules:
            if not any(country in metadata['origin_country'] for country in rules['origin_country']):
                match = False
        
        # 检查 original_language
        if match and 'original_language' in rules:
            if metadata['original_language'] not in rules['original_language']:
                match = False
        
        if match:
            return category_name
    
    return None  # 使用默认分类
```

---

## 总结

分类规则系统提供了灵活而强大的自动分类功能：

✅ **基于元数据** - 使用 TMDB 的准确信息
✅ **规则灵活** - 支持多种条件组合
✅ **易于扩展** - 可以添加自定义分类
✅ **智能匹配** - 按顺序匹配，优先级明确
✅ **自动创建** - 缺失的分类目录自动创建

合理配置分类规则，可以实现高度自动化的媒体库管理！
