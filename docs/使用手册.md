# 使用手册

## 目录
- [配置说明](#配置说明)
- [核心功能](#核心功能)
- [命名规则](#命名规则)
- [分类规则](#分类规则)
- [使用技巧](#使用技巧)

---

## 配置说明

### API配置

#### TMDB配置
- **API Key**: https://www.themoviedb.org/settings/api
- **代理地址**: http://proxy:port（可选）
- **限制**: 每天40,000次请求

#### 豆瓣配置
- **Cookie**: 登录豆瓣 → F12 → Network → 复制Cookie
- **有效期**: 1-3个月
- **优势**: 不需要代理，提供中文标题

### 路径配置

#### 新配置方式（推荐）✨

使用统一的媒体库路径，支持二级分类：

```
媒体库路径: /path/to/媒体库
语言偏好: 中文 或 English
```

**媒体库结构**：
```
媒体库/
├── 电影/（或 Movies/）
│   ├── 动作/
│   ├── 喜剧/
│   └── 科幻/
└── 电视剧/（或 TV Shows/）
    ├── 美剧/
    ├── 日剧/
    └── 韩剧/
```

**功能特点**：
- ✅ 自动检测现有目录结构
- ✅ 支持二级分类
- ✅ 支持中英文目录名称
- ✅ 智能匹配现有分类
- ✅ 自动创建缺失的分类目录

#### 旧配置方式（兼容）

```
待整理目录: /path/to/待整理
电影输出目录: /path/to/电影
剧集输出目录: /path/to/剧集
```

**注意**：旧配置不支持二级分类功能

### 冲突策略

- **自动比较**：智能比较文件质量（推荐）
- **跳过**：保留旧文件，跳过新文件
- **替换**：用新文件替换旧文件
- **保留两个**：新文件添加.v1后缀

---

## 核心功能

### 1. 智能重命名

自动识别并提取：
- 电影/剧集名称
- 年份
- 季集信息（剧集）
- 分辨率（4K, 1080p, 720p等）
- 来源（BluRay, WEB-DL, HDTV等）
- 编码（H.265, H.264等）

### 2. 中文标题识别

**查询优先级**：豆瓣 > TMDB

- **豆瓣**：提供中文标题，不需要代理
- **TMDB**：提供英文标题，自动翻译为中文

### 3. 智能去重

**质量评分系统**：
- 分辨率：4K=2160, 1080p=1080, 720p=720
- 来源：REMUX=100, BluRay=80, WEB-DL=60
- 格式：MKV=5, MP4=3, AVI=1
- 编码：H.265=2, H.264=1

**去重规则**：识别相同电影/剧集的不同版本，保留最高分版本

### 4. 智能分类

**电影分类**：
- **动画电影**: 类型包含动画
- **华语电影**: 原始语言为中文
- **外语电影**: 其他语言

**剧集分类**：
- **国漫**: 动画 + 中国/台湾/香港
- **日番**: 动画 + 日本
- **纪录片**: 类型为纪录片
- **国产剧**: 中国/台湾/香港剧集
- **日韩剧**: 日本/韩国剧集
- **欧美剧**: 欧美国家剧集

### 5. 冲突处理

**自动比较策略**：
1. 比较文件质量分数
2. 新文件更好 → 替换旧文件
3. 旧文件更好 → 保留旧文件
4. 质量相同 → 保留旧文件

### 6. 自动清理

**清理内容**：
- 跳过的文件（质量相同或较差）
- 空文件夹（递归删除）
- 临时文件

---

## 命名规则

### 电影命名

**格式**：
```
电影名称 (年份) [分辨率-来源].扩展名
```

**示例**：
```
流浪地球 (2019) [1080p-BluRay].mkv
肖申克的救赎 (1994) [4K-REMUX].mkv
千与千寻 (2001) [720p-WEB-DL].mp4
```

### 剧集命名

**格式**：
```
剧集名称 (年份)/Season XX/剧集名称 - SXXEXX [分辨率-来源].扩展名
```

**示例**：
```
三体 (2023)/Season 01/三体 - S01E01 [1080p-WEB-DL].mkv
权力的游戏 (2011)/Season 01/权力的游戏 - S01E01 [4K-BluRay].mkv
```

### 字幕命名

**格式**：
```
与视频文件同名.语言标识.srt
```

**示例**：
```
流浪地球 (2019) [1080p-BluRay].chs.srt
流浪地球 (2019) [1080p-BluRay].eng.srt
```

---

## 分类规则

### 电影分类规则

#### 动画电影
- **匹配条件**：`genre_ids` 包含 `16`（动画）
- **示例**：疯狂动物城、千与千寻

#### 华语电影
- **匹配条件**：`original_language` 为 `zh`, `cn`, `bo`, `za`
- **示例**：流浪地球、长津湖

#### 外语电影（默认）
- **匹配条件**：不匹配以上任何规则
- **示例**：阿凡达、泰坦尼克号

### 电视剧分类规则

#### 国漫
- **匹配条件**：动画 + 中国/台湾/香港
- **示例**：斗罗大陆、完美世界

#### 日番
- **匹配条件**：动画 + 日本
- **示例**：进击的巨人、鬼灭之刃

#### 纪录片
- **匹配条件**：`genre_ids` 包含 `99`
- **示例**：蓝色星球、地球脉动

#### 国产剧
- **匹配条件**：中国/台湾/香港剧集
- **示例**：三体、狂飙

#### 欧美剧
- **匹配条件**：美国、英国等欧美国家
- **示例**：权力的游戏、绝命毒师

#### 日韩剧
- **匹配条件**：日本、韩国剧集
- **示例**：半泽直树、鱿鱼游戏

### 自定义分类

编辑 `app.py` 中的 `CATEGORY_CONFIG`：

```python
CATEGORY_CONFIG = {
    'movie': {
        '科幻电影': {
            'genre_ids': ['878']  # 科幻类型
        }
    }
}
```

---

## 使用技巧

### 首次使用

1. **小批量测试**: 先用5-10个文件测试
2. **检查结果**: 确认命名和分类正确
3. **调整策略**: 根据需要调整冲突策略
4. **批量处理**: 确认无误后批量处理

### 日常使用

1. 新文件放入待整理目录
2. 点击"一键整理入库"
3. 系统自动完成所有操作
4. 查看"整理详情"了解进度

### 增量更新

1. 使用"跳过"策略
2. 只处理新增文件
3. 不影响已整理的库
4. 定期运行保持整洁

### 批量处理

1. 建议每次50-100个文件
2. 大文件（>10GB）单独处理
3. 避免同时处理过多文件
4. 可以多次运行

### 网盘用户

1. 处理速度较慢属正常
2. 系统已针对网盘优化
3. 增加了重试机制
4. 增加了操作延迟

---

## 处理流程

系统会自动完成8个步骤：

1. **📂 智能扫描** - 扫描待整理目录
2. **🌐 中文标题识别** - 通过豆瓣/TMDB获取中文标题
3. **🎯 智能去重** - 识别重复文件，保留最佳版本
4. **📝 标准化重命名** - 按规范格式重命名
5. **📁 智能分类** - 自动分类（动画、华语、外语等）
6. **🚚 自动移动** - 移动到目标目录
7. **⚔️ 冲突处理** - 处理同名文件
8. **🧹 自动清理** - 清理跳过的文件和空文件夹

---

## 支持的文件格式

- **视频**: mp4, mkv, avi, mov, ts, iso, rmvb, mpeg, mpg, wmv, 3gp, asf, m4v, flv, m2ts, tp, f4v
- **字幕**: srt, ass, ssa

---

## 冲突处理示例

### 场景1: 新文件质量更好

```
旧文件: 流浪地球 (2019) [720p-WEB-DL].mkv
新文件: 流浪地球 (2019) [1080p-BluRay].mkv
结果: 删除旧文件，保留新文件
```

### 场景2: 旧文件质量更好

```
旧文件: 流浪地球 (2019) [1080p-BluRay].mkv
新文件: 流浪地球 (2019) [720p-WEB-DL].mkv
结果: 保留旧文件，跳过新文件
```

### 场景3: 保留两个版本

```
旧文件: 流浪地球 (2019) [1080p-BluRay].mkv
新文件: 流浪地球 (2019) [1080p-WEB-DL].mkv
结果: 
- 流浪地球 (2019) [1080p-BluRay].mkv
- 流浪地球 (2019) [1080p-WEB-DL].v1.mkv
```

---

## 更多信息

- [快速开始](./快速开始.md) - 5分钟上手
- [部署手册](./部署手册.md) - 详细部署指南
- [常见问题](./常见问题.md) - 问题解答
- [API文档](./API文档.md) - API接口说明
