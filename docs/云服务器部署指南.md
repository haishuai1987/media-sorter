# 云服务器部署指南

## 推荐系统选择

### 1. Ubuntu Server（强烈推荐）✨

**推荐版本**：Ubuntu 22.04 LTS 或 20.04 LTS

**优势**：
- ✅ 长期支持（LTS）
- ✅ 软件包丰富
- ✅ 社区活跃
- ✅ 文档完善
- ✅ Python 3 预装
- ✅ 易于维护

**适合**：
- 新手用户
- 长期稳定运行
- 需要频繁更新

---

### 2. Debian（推荐）

**推荐版本**：Debian 11 (Bullseye) 或 12 (Bookworm)

**优势**：
- ✅ 极其稳定
- ✅ 资源占用低
- ✅ 安全性高
- ✅ 适合服务器

**适合**：
- 追求稳定性
- 资源有限的服务器
- 长期不重启

---

### 3. CentOS Stream / Rocky Linux / AlmaLinux

**推荐版本**：Rocky Linux 9 或 AlmaLinux 9

**优势**：
- ✅ 企业级稳定性
- ✅ 安全性高
- ✅ 适合生产环境

**适合**：
- 企业用户
- 需要 RHEL 兼容性
- 严格的安全要求

---

## 端口配置

### 默认端口

- **本地/NAS 部署**：默认使用 **8090** 端口（避免与 NAS 系统端口冲突）
- **云服务器部署**：默认使用 **8000** 端口（配合 Nginx 反向代理）

**注意**：8000 端口是很多 NAS 系统（如 Synology DSM）的默认端口，本地部署使用 8090 可以避免冲突。

### 推荐配置

#### 方案 1：使用 Nginx 反向代理（推荐）✨

```
用户 → 域名:80/443 → Nginx → localhost:8000 → Python应用
```

**优势**：
- ✅ 使用标准 HTTP/HTTPS 端口（80/443）
- ✅ 支持 SSL/TLS 加密
- ✅ 可以配置多个域名
- ✅ 性能更好
- ✅ 安全性更高

#### 方案 2：直接修改端口

通过环境变量修改端口：

```bash
# 使用 80 端口（需要 root 权限）
export PORT=80
python3 app.py

# 或使用其他端口
export PORT=8080
python3 app.py
```

**注意**：
- 80/443 端口需要 root 权限
- 8000 端口可能与 NAS 系统冲突
- 建议使用 Nginx 反向代理而不是直接使用 80 端口

---

## 自动识别部署环境

### 实现方案

让程序自动识别是本地部署还是云服务器部署：

```python
import os
import socket

def detect_environment():
    """检测部署环境"""
    # 检查是否有公网 IP
    hostname = socket.gethostname()
    local_ip = socket.gethostbyname(hostname)
    
    # 检查环境变量
    is_cloud = os.environ.get('DEPLOY_ENV') == 'cloud'
    
    # 检查是否在容器中
    is_docker = os.path.exists('/.dockerenv')
    
    # 检查常见的云服务器标识
    cloud_indicators = [
        '/etc/cloud',  # Cloud-init
        '/var/lib/cloud',
        os.environ.get('CLOUD_PROVIDER')
    ]
    
    has_cloud_indicator = any(
        os.path.exists(path) if isinstance(path, str) and not path.startswith('$') else path
        for path in cloud_indicators
    )
    
    if is_cloud or has_cloud_indicator:
        return 'cloud'
    elif is_docker:
        return 'docker'
    elif local_ip.startswith('192.168.') or local_ip.startswith('10.'):
        return 'local'
    else:
        return 'unknown'

# 根据环境自动配置
env = detect_environment()

if env == 'cloud':
    # 云服务器配置
    HOST = '0.0.0.0'  # 监听所有接口
    PORT = 8000  # 使用 Nginx 反向代理
    DEBUG = False
elif env == 'local':
    # 本地配置
    HOST = '127.0.0.1'  # 只监听本地
    PORT = 8000
    DEBUG = True
else:
    # 默认配置
    HOST = '0.0.0.0'
    PORT = 8000
    DEBUG = False
```

### 使用环境变量

创建 `.env` 文件：

```bash
# 云服务器
DEPLOY_ENV=cloud
HOST=0.0.0.0
PORT=8000
DEBUG=false

# 本地开发
# DEPLOY_ENV=local
# HOST=127.0.0.1
# PORT=8000
# DEBUG=true
```

---

## 完整部署步骤

### 1. 选择云服务器

**推荐配置**：
- CPU：2核
- 内存：2GB
- 硬盘：40GB SSD
- 带宽：3Mbps

**推荐服务商**：
- 阿里云
- 腾讯云
- 华为云
- AWS
- DigitalOcean

---

### 2. 安装系统（Ubuntu 22.04）

```bash
# 更新系统
sudo apt update
sudo apt upgrade -y

# 安装必要软件
sudo apt install -y python3 python3-pip git nginx certbot python3-certbot-nginx
```

---

### 3. 克隆项目

```bash
# 创建目录
cd /opt
sudo git clone https://github.com/your-repo/media-renamer.git
cd media-renamer

# 设置权限
sudo chown -R $USER:$USER /opt/media-renamer
```

---

### 4. 配置 Nginx

创建 Nginx 配置文件：

```bash
sudo nano /etc/nginx/sites-available/media-renamer
```

添加以下内容：

```nginx
server {
    listen 80;
    server_name your-domain.com;  # 替换为你的域名

    # 限制请求大小（用于上传）
    client_max_body_size 100M;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket 支持（如果需要）
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # 超时设置
        proxy_connect_timeout 600;
        proxy_send_timeout 600;
        proxy_read_timeout 600;
    }

    # 静态文件（可选）
    location /static/ {
        alias /opt/media-renamer/public/;
        expires 30d;
    }
}
```

启用配置：

```bash
sudo ln -s /etc/nginx/sites-available/media-renamer /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

---

### 5. 配置 SSL（HTTPS）

```bash
# 使用 Let's Encrypt 免费证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo certbot renew --dry-run
```

配置后，Nginx 会自动更新为：

```nginx
server {
    listen 443 ssl;
    server_name your-domain.com;

    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

    # ... 其他配置
}

server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}
```

---

### 6. 创建 Systemd 服务

创建服务文件：

```bash
sudo nano /etc/systemd/system/media-renamer.service
```

添加以下内容：

```ini
[Unit]
Description=Media Renamer Service
After=network.target

[Service]
Type=simple
User=your-username
WorkingDirectory=/opt/media-renamer
Environment="DEPLOY_ENV=cloud"
Environment="HOST=127.0.0.1"
Environment="PORT=8000"
ExecStart=/usr/bin/python3 /opt/media-renamer/app.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启动服务：

```bash
sudo systemctl daemon-reload
sudo systemctl enable media-renamer
sudo systemctl start media-renamer
sudo systemctl status media-renamer
```

---

### 7. 配置防火墙

```bash
# UFW（Ubuntu）
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow 22/tcp  # SSH
sudo ufw enable

# Firewalld（CentOS/Rocky）
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --reload
```

---

### 8. 域名配置

在域名服务商处添加 DNS 记录：

```
类型    主机记录    记录值
A       @          your-server-ip
A       www        your-server-ip
```

等待 DNS 生效（通常 10 分钟到 24 小时）。

---

## 访问方式对比

### 本地部署

```
访问地址：http://localhost:8090
或：http://127.0.0.1:8090
或：http://192.168.x.x:8090（局域网）
```

**注意**：使用 8090 端口避免与 NAS 系统（如 Synology DSM 的 8000 端口）冲突

### 云服务器部署

#### 方案 1：使用 Nginx（推荐）

```
访问地址：https://your-domain.com
或：http://your-domain.com（自动跳转到 HTTPS）
```

**优势**：
- ✅ 无需记住端口
- ✅ 支持 HTTPS 加密
- ✅ 更专业
- ✅ SEO 友好

#### 方案 2：直接使用端口

```
访问地址：http://your-domain.com:8000
或：http://your-server-ip:8000
或：http://your-domain.com:8090（本地/NAS）
```

**注意**：
- ❌ 需要记住端口
- ❌ 不支持 HTTPS（除非配置）
- ❌ 防火墙需要开放对应端口
- ⚠️ 8000 端口可能与 NAS 系统冲突

---

## 性能优化

### 1. 使用 Gunicorn（推荐）

安装 Gunicorn：

```bash
pip3 install gunicorn
```

修改 systemd 服务：

```ini
ExecStart=/usr/local/bin/gunicorn -w 4 -b 127.0.0.1:8000 app:app
```

### 2. 配置 Nginx 缓存

```nginx
# 在 http 块中添加
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=1g inactive=60m;

# 在 location 块中添加
proxy_cache my_cache;
proxy_cache_valid 200 60m;
proxy_cache_use_stale error timeout http_500 http_502 http_503 http_504;
```

### 3. 启用 Gzip 压缩

```nginx
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json;
```

---

## 安全建议

### 1. 修改 SSH 端口

```bash
sudo nano /etc/ssh/sshd_config
# 修改 Port 22 为其他端口，如 2222
sudo systemctl restart sshd
```

### 2. 禁用 root 登录

```bash
sudo nano /etc/ssh/sshd_config
# 设置 PermitRootLogin no
sudo systemctl restart sshd
```

### 3. 配置 fail2ban

```bash
sudo apt install fail2ban
sudo systemctl enable fail2ban
sudo systemctl start fail2ban
```

### 4. 定期更新

```bash
# 创建自动更新脚本
sudo nano /etc/cron.weekly/update-system

#!/bin/bash
apt update
apt upgrade -y
apt autoremove -y

sudo chmod +x /etc/cron.weekly/update-system
```

---

## 监控和日志

### 查看应用日志

```bash
# Systemd 日志
sudo journalctl -u media-renamer -f

# Nginx 日志
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

### 监控资源使用

```bash
# 安装 htop
sudo apt install htop
htop

# 查看磁盘使用
df -h

# 查看内存使用
free -h
```

---

## 备份策略

### 1. 配置文件备份

```bash
# 创建备份脚本
sudo nano /opt/backup.sh

#!/bin/bash
BACKUP_DIR="/opt/backups"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# 备份配置
tar -czf $BACKUP_DIR/config_$DATE.tar.gz \
    /opt/media-renamer/config.json \
    /etc/nginx/sites-available/media-renamer

# 保留最近 7 天的备份
find $BACKUP_DIR -name "config_*.tar.gz" -mtime +7 -delete

sudo chmod +x /opt/backup.sh

# 添加到 crontab
crontab -e
# 添加：0 2 * * * /opt/backup.sh
```

### 2. 数据库备份（如果使用）

```bash
# 备份 SQLite
cp /opt/media-renamer/*.db $BACKUP_DIR/
```

---

## 故障排查

### 1. 服务无法启动

```bash
# 查看详细日志
sudo journalctl -u media-renamer -n 50

# 检查端口占用
sudo netstat -tlnp | grep 8000

# 手动运行测试
cd /opt/media-renamer
python3 app.py
```

### 2. Nginx 502 错误

```bash
# 检查 Python 应用是否运行
sudo systemctl status media-renamer

# 检查端口是否正确
curl http://127.0.0.1:8000

# 查看 Nginx 错误日志
sudo tail -f /var/log/nginx/error.log
```

### 3. 无法访问域名

```bash
# 检查 DNS 解析
nslookup your-domain.com

# 检查防火墙
sudo ufw status

# 检查 Nginx 配置
sudo nginx -t
```

---

## 总结

### 推荐配置

**系统**：Ubuntu 22.04 LTS
**架构**：Nginx + Python + Systemd
**访问**：https://your-domain.com
**端口**：内部 8000，外部 80/443

### 优势

✅ **稳定性**：Systemd 自动重启
✅ **安全性**：HTTPS 加密
✅ **性能**：Nginx 反向代理
✅ **易用性**：无需记住端口
✅ **专业性**：标准的生产环境配置

### 下一步

1. 选择云服务器和系统
2. 按照步骤部署
3. 配置域名和 SSL
4. 测试访问
5. 配置备份和监控

有问题随时查看日志或提交 Issue！
