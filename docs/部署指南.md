# 部署指南

## 目录
- [快速部署](#快速部署)
- [Linux系统部署](#linux系统部署)
- [NAS系统部署](#nas系统部署)
- [Docker部署](#docker部署)
- [系统服务](#系统服务)

---

## 快速部署

### 自动安装（推荐）

```bash
# 1. 克隆项目
git clone https://github.com/your-repo/media-renamer.git
cd media-renamer

# 2. 运行安装脚本
chmod +x install.sh
./install.sh

# 3. 启动服务
python3 app.py

# 4. 访问应用
# http://localhost:8090
```

### 手动安装

```bash
# 1. 检查Python版本
python3 --version  # 需要 >= 3.6

# 2. 创建配置目录
mkdir -p ~/.media-renamer

# 3. 设置权限
chmod +x app.py

# 4. 启动服务
python3 app.py
```

---

## Linux系统部署

### Ubuntu / Debian

```bash
# 1. 安装Python
sudo apt update
sudo apt install python3 python3-pip

# 2. 克隆项目
git clone https://github.com/your-repo/media-renamer.git
cd media-renamer

# 3. 运行安装脚本
chmod +x install.sh
./install.sh

# 4. 配置防火墙
sudo ufw allow 8090

# 5. 启动服务
python3 app.py
```

### CentOS / RHEL

```bash
# 1. 安装Python
sudo yum install python3 python3-pip

# 2. 克隆项目
git clone https://github.com/your-repo/media-renamer.git
cd media-renamer

# 3. 运行安装脚本
chmod +x install.sh
./install.sh

# 4. 配置防火墙
sudo firewall-cmd --add-port=8090/tcp --permanent
sudo firewall-cmd --reload

# 5. 启动服务
python3 app.py
```

---

## NAS系统部署

### Synology DSM

#### 方法1: Docker（推荐）

1. 安装 **Container Manager**（旧版本为Docker）
2. 创建工作目录：
```bash
mkdir -p /volume1/docker/media-renamer
cd /volume1/docker/media-renamer
```
3. 上传文件（app.py, index.html, Dockerfile, docker-compose.yml）
4. 修改docker-compose.yml中的路径
5. 启动容器：
```bash
docker-compose up -d
```

#### 方法2: Python直接运行

1. 安装 **Python 3.9**（套件中心）
2. SSH登录：
```bash
ssh admin@your-nas-ip
```
3. 创建应用目录：
```bash
mkdir -p /volume1/apps/media-renamer
cd /volume1/apps/media-renamer
```
4. 上传文件
5. 运行：
```bash
python3 app.py
```

#### 设置开机自启

1. 控制面板 → 任务计划
2. 新增 → 触发的任务 → 用户定义的脚本
3. 事件：开机
4. 脚本：
```bash
#!/bin/bash
cd /volume1/apps/media-renamer
python3 app.py &
```

### QNAP QTS

#### 方法1: Container Station（推荐）

1. 安装 **Container Station**
2. SSH登录：
```bash
ssh admin@your-nas-ip
```
3. 创建工作目录：
```bash
mkdir -p /share/Container/media-renamer
cd /share/Container/media-renamer
```
4. 上传文件
5. 启动容器：
```bash
docker-compose up -d
```

#### 方法2: Python直接运行

1. 安装 **Python 3**（App Center）
2. 创建应用目录：
```bash
mkdir -p /share/apps/media-renamer
cd /share/apps/media-renamer
```
3. 上传文件
4. 运行：
```bash
python3 app.py
```

#### 设置开机自启

创建 `/etc/config/autorun.sh`：
```bash
#!/bin/bash
cd /share/apps/media-renamer
python3 app.py &
```

### TrueNAS / FreeNAS

#### 方法1: Jail（推荐）

1. 创建Jail：
   - Jails → ADD
   - 名称: media-renamer
   - Release: 最新版本

2. 进入Jail：
```bash
iocage console media-renamer
```

3. 安装Python：
```bash
pkg install python39
```

4. 创建应用目录：
```bash
mkdir -p /usr/local/media-renamer
cd /usr/local/media-renamer
```

5. 上传文件并运行：
```bash
python3.9 app.py
```

#### 方法2: Docker（TrueNAS SCALE）

TrueNAS SCALE原生支持Docker，参考Docker部署方法。

### Unraid

#### 方法1: Docker（推荐）

1. Docker标签 → Add Container
2. 配置：
   - Name: media-renamer
   - Repository: your-image
   - Port: 8090:8090
   - Path: /mnt/user/media:/data

#### 方法2: docker-compose

```bash
# SSH登录
ssh root@tower

# 创建目录
mkdir -p /mnt/user/appdata/media-renamer
cd /mnt/user/appdata/media-renamer

# 上传文件
# 启动
docker-compose up -d
```

---

## Docker部署

### 使用docker-compose（推荐）

1. 创建docker-compose.yml：
```yaml
version: '3.8'

services:
  media-renamer:
    build: .
    container_name: media-renamer
    ports:
      - "8090:8090"
    volumes:
      - /path/to/media:/data
    environment:
      - TZ=Asia/Shanghai
    restart: unless-stopped
```

2. 修改volumes路径

3. 启动容器：
```bash
docker-compose up -d
```

4. 查看日志：
```bash
docker-compose logs -f
```

### 使用Dockerfile

1. 构建镜像：
```bash
docker build -t media-renamer .
```

2. 运行容器：
```bash
docker run -d \
  --name media-renamer \
  -p 8090:8090 \
  -v /path/to/media:/data \
  -e TZ=Asia/Shanghai \
  --restart unless-stopped \
  media-renamer
```

### Docker命令

```bash
# 启动
docker-compose up -d

# 停止
docker-compose down

# 重启
docker-compose restart

# 查看日志
docker-compose logs -f

# 进入容器
docker exec -it media-renamer bash
```

---

## 系统服务

### systemd服务（Linux）

1. 创建服务文件：
```bash
sudo nano /etc/systemd/system/media-renamer.service
```

2. 添加内容：
```ini
[Unit]
Description=Media Renamer Service
After=network.target

[Service]
Type=simple
User=your-user
WorkingDirectory=/path/to/media-renamer
ExecStart=/usr/bin/python3 /path/to/media-renamer/app.py
Restart=on-failure
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

3. 启用服务：
```bash
sudo systemctl daemon-reload
sudo systemctl enable media-renamer
sudo systemctl start media-renamer
```

4. 管理服务：
```bash
# 启动
sudo systemctl start media-renamer

# 停止
sudo systemctl stop media-renamer

# 重启
sudo systemctl restart media-renamer

# 状态
sudo systemctl status media-renamer

# 日志
sudo journalctl -u media-renamer -f
```

---

## 网络配置

### 防火墙配置

#### Ubuntu / Debian
```bash
sudo ufw allow 8090
sudo ufw reload
```

#### CentOS / RHEL
```bash
sudo firewall-cmd --add-port=8090/tcp --permanent
sudo firewall-cmd --reload
```

#### 仅允许局域网访问
```bash
sudo ufw allow from 192.168.1.0/24 to any port 8090
```

### 反向代理（可选）

#### Nginx配置
```nginx
server {
    listen 80;
    server_name media.example.com;
    
    location / {
        proxy_pass http://localhost:8090;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

#### 添加认证
```nginx
location / {
    auth_basic "Restricted";
    auth_basic_user_file /etc/nginx/.htpasswd;
    proxy_pass http://localhost:8090;
}
```

---

## 故障排查

### 端口被占用

```bash
# 查找占用进程
sudo lsof -i :8090
# 或
sudo netstat -tulpn | grep 8090

# 修改端口
# 编辑 app.py
PORT = 8091
```

### 权限错误

```bash
# 修改所有者
sudo chown -R $USER:$USER /path/to/media

# 修改权限
sudo chmod -R 755 /path/to/media

# 检查配置目录
ls -la ~/.media-renamer/
chmod 755 ~/.media-renamer
chmod 644 ~/.media-renamer/config.json
```

### Python版本过低

```bash
# Ubuntu/Debian
sudo apt install python3.9

# CentOS/RHEL
sudo yum install python39

# 使用指定版本
python3.9 app.py
```

### SELinux问题（CentOS/RHEL）

```bash
# 临时禁用
sudo setenforce 0

# 检查状态
sudo getenforce

# 永久禁用（不推荐）
sudo nano /etc/selinux/config
# SELINUX=disabled
```

---

## 性能优化

### 系统优化

```bash
# 增加文件描述符限制
ulimit -n 4096

# 检查磁盘IO
iostat -x 1

# 检查网络
iftop
```

### 应用优化

编辑 app.py：
```python
# 网络优化
NETWORK_RETRY_COUNT = 5  # 增加重试次数
NETWORK_RETRY_DELAY = 3  # 增加延迟
NETWORK_OP_DELAY = 2.0   # 增加操作延迟
```

### NAS优化

- 启用SSD缓存（如支持）
- 使用快照功能备份
- 定期清理日志
- 使用有线连接

---

## 安全建议

### 网络安全

```bash
# 仅允许局域网访问
sudo ufw allow from 192.168.1.0/24 to any port 8090

# 或使用iptables
sudo iptables -A INPUT -s 192.168.1.0/24 -p tcp --dport 8090 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 8090 -j DROP
```

### 文件权限

```bash
# 限制配置文件权限
chmod 600 ~/.media-renamer/config.json

# 限制应用目录权限
chmod 750 /path/to/media-renamer
```

### API密钥安全

- 使用自己的API Key
- 不要分享配置文件
- 定期更新Cookie

---

## 维护建议

### 日常维护

```bash
# 检查日志
sudo journalctl -u media-renamer -f

# 备份配置
cp ~/.media-renamer/config.json ~/config.backup.json

# 检查磁盘空间
df -h
```

### 定期任务

```bash
# 清理日志
sudo journalctl --vacuum-time=7d

# 更新程序
git pull
sudo systemctl restart media-renamer

# 更新Cookie（每月）
# 在Web界面的"设置"中更新
```

---

## 部署检查清单

部署完成后，确认以下项目：

- [ ] Python 3.6+ 已安装
- [ ] 服务正常启动
- [ ] Web界面可访问
- [ ] API密钥已配置
- [ ] 路径权限正确
- [ ] 测试文件处理成功
- [ ] 日志正常输出
- [ ] 防火墙已配置
- [ ] 备份策略已设置

---

## 获取帮助

如遇问题，请提供：
1. 系统版本
2. Python版本
3. 错误日志
4. 复现步骤

查看 [常见问题文档](常见问题.md) 获取更多帮助。
