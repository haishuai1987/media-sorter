# 本地整理模块优化实施计划

## 概述

本文档规划两个 spec 的实施顺序和策略：
1. **secondary-classification-fix** - 二级分类修复
2. **local-organizer-optimization** - 性能优化

## 实施策略

### 推荐方案：先修复功能，再优化性能

**原因**：
1. 二级分类是核心功能问题，影响用户使用
2. 性能优化依赖于正确的功能实现
3. 先确保功能正确，再提升速度
4. 避免在错误的实现上做优化

### 实施顺序

```
Phase 1: 二级分类修复 (优先级：高)
  ├── 实现核心检测器类
  ├── 修复路径生成逻辑
  ├── 更新界面配置
  └── 测试验证

Phase 2: 性能优化 (优先级：中)
  ├── 创建本地优化函数
  ├── 移除网盘限制
  ├── 添加并行处理
  └── 性能测试

Phase 3: 集成和优化 (优先级：中)
  ├── 整合两个 spec 的改进
  ├── 全面测试
  └── 文档更新
```

## 详细实施计划

### Phase 1: 二级分类修复 (预计 2-3 天)

#### Week 1 - Day 1-2: 核心实现

**任务组 1.1: 检测器实现**
- [ ] 1. 实现 MediaLibraryDetector 类
- [ ] 2. 实现 SecondaryClassificationDetector 类
- [ ] 3. 实现 PathGenerator 类

**预期产出**：
- 3 个核心类完成
- 单元测试通过
- 能够正确检测和生成路径

**验证标准**：
```python
# 测试用例
detector = MediaLibraryDetector('/vol02/1000-1-b23abde7/115')
structure = detector.detect_structure()
assert structure['tv_dir'] == '电视剧'
assert structure['movie_dir'] == '电影'

classifier = SecondaryClassificationDetector(structure['tv_path'])
category_dir = classifier.get_category_dir('国产剧')
assert category_dir == '国产剧'  # 使用已存在的目录

generator = PathGenerator('/vol02/1000-1-b23abde7/115')
path, rel_path = generator.generate_path({
    'type': 'tv',
    'title': '包青天',
    'year': '1993',
    'season': 1,
    'episode': '08',
    'season_episode': 'S01E08',
    'category': '国产剧',
    'fileExt': '.mkv'
})
assert path == '/vol02/1000-1-b23abde7/115/电视剧/国产剧/包青天 (1993)/Season 1/包青天 - S01E08 - 第 08 集.mkv'
```

#### Week 1 - Day 2-3: 集成和界面

**任务组 1.2: 后端集成**
- [ ] 4. 修复文件名生成逻辑
- [ ] 5. 重构 generate_output_path() 方法
- [ ] 6. 修改 handle_smart_rename() 方法
- [ ] 7. 实现 ConfigManager 类

**任务组 1.3: 前端更新**
- [ ] 8. 更新前端界面 - 配置部分
- [ ] 9. 更新前端界面 - 整理页面
- [ ] 10. 添加配置迁移提示

**预期产出**：
- 后端 API 完全集成
- 前端界面更新完成
- 配置迁移功能可用

**验证标准**：
- 在界面上选择媒体库路径
- 自动检测并显示目录结构
- 执行整理，文件保存到正确路径
- 文件名格式正确

#### Week 1 - Day 3: 测试和修复

**任务组 1.4: 测试**
- [ ] 11. 单元测试
- [ ] 12. 集成测试

**测试场景**：
1. 新媒体库（空目录）
2. 现有媒体库（已有分类）
3. 中文目录名
4. 英文目录名
5. 混合目录名
6. 旧配置迁移

**预期产出**：
- 所有测试通过
- Bug 修复完成
- 功能稳定可用

---

### Phase 2: 性能优化 (预计 2-3 天)

#### Week 2 - Day 1-2: 核心优化

**任务组 2.1: 本地优化函数**
- [ ] 1. 创建本地优化的文件操作函数
  - `safe_rename_file_local()`
  - `safe_delete_file_local()`
  - `process_batch_local()`

**任务组 2.2: 并行处理**
- [ ] 2. 实现并行文件处理功能
  - `process_files_parallel()`
  - 线程池管理
  - 错误隔离

**任务组 2.3: 配置分离**
- [ ] 6. 分离本地和云盘配置常量
  - `LOCAL_RETRY_COUNT = 1`
  - `LOCAL_OP_DELAY = 0.0`

**预期产出**：
- 本地优化函数完成
- 并行处理功能可用
- 配置正确分离

**性能目标**：
- 单文件操作：< 0.1 秒
- 100 文件整理：< 60 秒

#### Week 2 - Day 2-3: 集成和测试

**任务组 2.4: API 优化**
- [ ] 3. 优化 handle_smart_rename() 函数
- [ ] 4. 优化 handle_rename() 函数
- [ ] 5. 优化 handle_cleanup() 函数

**任务组 2.5: 监控和配置**
- [ ] 7. 添加性能监控和日志
- [ ] 8. 添加配置选项
- [ ] 9. 更新前端界面

**任务组 2.6: 测试**
- [ ] 10. 性能测试和基准对比
- [ ] 11. 功能测试

**预期产出**：
- 所有 API 优化完成
- 性能监控可用
- 测试通过

**性能验证**：
```python
# 性能测试
import time

# 测试 100 个文件
start = time.time()
results = handle_smart_rename({
    'files': test_files,  # 100 个文件
    'basePath': '/test/source',
    'mediaLibraryPath': '/test/library'
})
elapsed = time.time() - start

assert elapsed < 60  # 应该在 60 秒内完成
assert results['performance']['throughput'] > 1.5  # 至少 1.5 files/sec
```

---

### Phase 3: 集成和优化 (预计 1 天)

#### Week 2 - Day 4: 最终集成

**任务组 3.1: 整合优化**
- [ ] 13. 性能优化（local-organizer-optimization）
  - 确保优化后的函数与新路径生成器兼容
  - 验证并行处理不影响路径正确性

**任务组 3.2: 全面测试**
- 测试二级分类 + 性能优化的组合
- 测试各种边界情况
- 压力测试（1000+ 文件）

**任务组 3.3: 文档更新**
- [ ] 12. 文档更新（secondary-classification-fix）
- [ ] 14. 文档更新（local-organizer-optimization）
- 更新使用指南
- 更新 API 文档
- 添加性能对比数据

**预期产出**：
- 两个 spec 完全集成
- 所有测试通过
- 文档完整

---

## 任务依赖关系

### 关键路径

```
secondary-classification-fix:
  Task 1-3 (检测器) → Task 4-5 (路径生成) → Task 6-7 (集成) → Task 8-10 (界面) → Task 11-12 (测试)

local-organizer-optimization:
  Task 1 (本地函数) → Task 2 (并行) → Task 3-5 (API优化) → Task 6-9 (配置和界面) → Task 10-11 (测试)
```

### 可并行的任务

**Phase 1 中可并行**：
- Task 1-3 (检测器实现) 可以并行开发
- Task 8-9 (前端界面) 可以在后端完成后并行开发

**Phase 2 中可并行**：
- Task 1-2 (函数实现) 可以并行开发
- Task 3-5 (API 优化) 可以并行开发

---

## 风险和缓解措施

### 风险 1: 路径生成逻辑复杂

**风险等级**: 高

**影响**: 可能导致文件保存到错误位置

**缓解措施**:
- 充分的单元测试
- 在测试环境验证
- 添加路径预览功能
- 提供回滚机制

### 风险 2: 性能优化可能引入 Bug

**风险等级**: 中

**影响**: 并行处理可能导致文件冲突或数据不一致

**缓解措施**:
- 先完成功能修复，确保基础正确
- 并行处理添加文件锁
- 充分的并发测试
- 提供配置选项关闭并行

### 风险 3: 配置迁移可能失败

**风险等级**: 中

**影响**: 用户配置丢失或错误

**缓解措施**:
- 保留旧配置作为备份
- 提供手动迁移选项
- 详细的迁移日志
- 支持回退到旧配置

---

## 成功标准

### Phase 1 成功标准

- [ ] 文件保存到正确的二级分类目录
- [ ] 文件名格式正确（无多余信息）
- [ ] Season 目录结构正确
- [ ] 自动检测现有分类目录
- [ ] 界面配置简洁易用
- [ ] 向后兼容旧配置

### Phase 2 成功标准

- [ ] 100 文件整理时间 < 60 秒（优化前 ~120 秒）
- [ ] 单文件操作时间 < 0.1 秒（优化前 ~1.3 秒）
- [ ] 无网络延迟和重试
- [ ] 并行处理稳定可靠
- [ ] 性能监控数据准确

### Phase 3 成功标准

- [ ] 两个 spec 完全集成
- [ ] 所有测试通过
- [ ] 文档完整准确
- [ ] 用户反馈良好

---

## 时间估算

| Phase | 任务数 | 预计时间 | 关键任务 |
|-------|--------|----------|----------|
| Phase 1 | 12 | 2-3 天 | 检测器实现、路径生成 |
| Phase 2 | 11 | 2-3 天 | 并行处理、性能优化 |
| Phase 3 | 3 | 1 天 | 集成测试、文档 |
| **总计** | **26** | **5-7 天** | - |

---

## 下一步行动

### 立即开始

1. **开始 Phase 1, Task 1**: 实现 MediaLibraryDetector 类
2. **准备测试环境**: 创建测试用的媒体库结构
3. **准备测试数据**: 准备各种场景的测试文件

### 建议

- 每完成一个 Phase 就提交代码
- 每个 Task 完成后运行相关测试
- 保持频繁的代码提交
- 及时更新文档

---

## 总结

通过分阶段实施，我们可以：
1. **先修复核心功能**（二级分类）- 确保用户能正确使用
2. **再优化性能**（移除网盘限制）- 提升用户体验
3. **最后整合优化**（集成测试）- 确保稳定可靠

这种方式风险最小，收益最大，用户可以尽快使用到修复后的功能。
